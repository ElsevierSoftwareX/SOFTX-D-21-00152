{------------------------------------------------------------------------------}
{                                                                              }
{  Personal Knowledge Base Designer                                            }
{  by A.Yu. Yurin, N.O. Dorodnykh                                              }
{                                                                              }
{  iskander@icc.ru                                                             }
{  http://knowledge-core.ru/                                                   }
{                                                                              }
{------------------------------------------------------------------------------}

unit MAIN;

interface

uses
  Windows, Messages, SysUtils, Classes, Graphics, Forms, Controls, Menus,
  StdCtrls, Dialogs, Buttons, ExtCtrls, ComCtrls, StdActns, ActnList, ToolWin,
  ImgList, RzButton, xmldom, XMLIntf, msxmldom, XMLDoc, MSXML_TLB,
  RzBHints, Mask, RzEdit,UPKBClass, RzPanel, RzTabs, RzListVw, RzStatus,
  RzLabel, RzSplit, RzShellDialogs, RzCmboBx,DateUtils, ExtDlgs, ShellAPI,
  ActiveX, RzLine, jpeg;

type
  TMainForm = class(TForm)
    MainMenu: TMainMenu;
    File1: TMenuItem;
    Help1: TMenuItem;
    N1: TMenuItem;
    FileExitItem: TMenuItem;
    HelpAboutItem: TMenuItem;
    ActionList1: TActionList;
    WindowCascade1: TWindowCascade;
    WindowTileHorizontal1: TWindowTileHorizontal;
    WindowArrangeAll1: TWindowArrange;
    WindowMinimizeAll1: TWindowMinimizeAll;
    WindowTileVertical1: TWindowTileVertical;
    ToolBar2: TToolBar;
    ToolButton1: TToolButton;
    ToolButton2: TToolButton;
    ToolButton3: TToolButton;
    ToolButton4: TToolButton;
    ToolButton5: TToolButton;
    ToolButton6: TToolButton;
    ToolButton9: TToolButton;
    ToolButton7: TToolButton;
    ToolButton8: TToolButton;
    ImageList1: TImageList;
    N2: TMenuItem;
    N3: TMenuItem;
    N4: TMenuItem;
    N5: TMenuItem;
    N6: TMenuItem;
    N7: TMenuItem;
    N8: TMenuItem;
    N9: TMenuItem;
    N10: TMenuItem;
    Clips1: TMenuItem;
    N11: TMenuItem;
    XMLDocument1: TXMLDocument;
    N12: TMenuItem;
    OpenDialog1: TOpenDialog;
    SaveDialog1: TSaveDialog;
    N13: TMenuItem;
    N14: TMenuItem;
    N15: TMenuItem;
    rzblnhnts1: TRzBalloonHints;
    Splitter1: TSplitter;
    TreeView1: TTreeView;
    RzPanel1: TRzPanel;
    ToolBar1: TToolBar;
    DeleteItem: TToolButton;
    EditItem: TToolButton;
    NewKB: TToolButton;
    NewT: TToolButton;
    NewR: TToolButton;
    NewF: TToolButton;
    GroupBox3: TGroupBox;
    RzPanel2: TRzPanel;
    ScrollBox1: TScrollBox;
    RzPanel3: TRzPanel;
    RzButton3: TRzButton;
    RzButton4: TRzButton;
    RzPageControl1: TRzPageControl;
    TabSheet3: TRzTabSheet;
    TabSheet1: TRzTabSheet;
    N16: TMenuItem;
    N17: TMenuItem;
    ImageList2: TImageList;
    PopupMenu1: TPopupMenu;
    N20: TMenuItem;
    N21: TMenuItem;
    N22: TMenuItem;
    N23: TMenuItem;
    N24: TMenuItem;
    N25: TMenuItem;
    N26: TMenuItem;
    RzMenuButton1: TRzMenuButton;
    PopupMenu2: TPopupMenu;
    RUENG1: TMenuItem;
    ENGRU1: TMenuItem;
    N27: TMenuItem;
    RUENG2: TMenuItem;
    ENGRU2: TMenuItem;
    ScrollBox3: TScrollBox;
    RzPageControl2: TRzPageControl;
    TabSheet2: TRzTabSheet;
    TabSheet4: TRzTabSheet;
    RzPanel7: TRzPanel;
    RzListView1: TRzListView;
    RzStatusPane1: TRzStatusPane;
    RzStatusBar1: TRzStatusBar;
    RzGlyphStatus1: TRzGlyphStatus;
    RzProgressStatus1: TRzProgressStatus;
    RzFieldStatus1: TRzFieldStatus;
    RzSplitter1: TRzSplitter;
    RzSplitter2: TRzSplitter;
    RzGroupBox1: TRzGroupBox;
    RzGroupBox2: TRzGroupBox;
    ToolButton10: TToolButton;
    TabSheet5: TRzTabSheet;
    ScrollBox4: TScrollBox;
    ToolButton11: TToolButton;
    CLIPS2: TMenuItem;
    RationalRosemdl1: TMenuItem;
    N28: TMenuItem;
    doc1: TMenuItem;
    RzPanel4: TRzPanel;
    RzPanel6: TRzPanel;
    RzMaskEdit1: TRzMaskEdit;
    N18: TMenuItem;
    N19: TMenuItem;
    SavePictureDialog1: TSavePictureDialog;
    RVML1: TMenuItem;
    N29: TMenuItem;
    ToolButton12: TToolButton;
    Run1: TMenuItem;
    N30: TMenuItem;
    N31: TMenuItem;
    C1: TMenuItem;
    ToolButton13: TToolButton;
    ToolButton14: TToolButton;
    ToolButton15: TToolButton;
    ToolBar3: TToolBar;
    ToolButton17: TToolButton;
    ImageList3: TImageList;
    N32: TMenuItem;
    N33: TMenuItem;
    RzPanel8: TRzPanel;
    RzListView2: TRzListView;
    N34: TMenuItem;
    RzBitBtn1: TRzBitBtn;
    CLIPSclp1: TMenuItem;
    RationalRosemdl2: TMenuItem;
    N35: TMenuItem;
    N36: TMenuItem;
    English1: TMenuItem;
    N37: TMenuItem;
    N38: TMenuItem;
    N39: TMenuItem;
    RecentFiles1: TMenuItem;
    StarUMLmdj1: TMenuItem;
    RzSplitter3: TRzSplitter;
    PopupMenu3: TPopupMenu;
    Edit1: TMenuItem;
    TabSheet6: TRzTabSheet;
    RzPageControl3: TRzPageControl;
    RzTabSheet1: TRzTabSheet;
    RzTabSheet2: TRzTabSheet;
    RzTabSheet3: TRzTabSheet;
    ScrollBox5: TScrollBox;
    TabSheet7: TRzTabSheet;
    GroupBox5: TGroupBox;
    RzPanel11: TRzPanel;
    RzLabel7: TRzLabel;
    RzEdit2: TRzEdit;
    RzPanel12: TRzPanel;
    RzPanel13: TRzPanel;
    RzLabel2: TRzLabel;
    RzEdit1: TRzEdit;
    RzPanel14: TRzPanel;
    RzLabel3: TRzLabel;
    RzEdit3: TRzEdit;
    RzPanel15: TRzPanel;
    RzLabel4: TRzLabel;
    RzEdit4: TRzEdit;
    RzPanel16: TRzPanel;
    RzLabel5: TRzLabel;
    RzEdit5: TRzEdit;
    ScrollBox6: TScrollBox;
    ScrollBox2: TScrollBox;
    RzPanel9: TRzPanel;
    RzPanel10: TRzPanel;
    ProgramIcon: TImage;
    RzPanel17: TRzPanel;
    RzPanel18: TRzPanel;
    RzBitBtn2: TRzBitBtn;
    ToolButton16: TToolButton;
    ToolButton18: TToolButton;
    Expertsystems1: TMenuItem;
    N40: TMenuItem;
    Expertsystemexplorer1: TMenuItem;
    ImageList4: TImageList;
    GroupBox4: TGroupBox;
    RzPanel5: TRzPanel;
    CheckBox1: TCheckBox;
    RzMemo1: TRzMemo;
    RzPanel19: TRzPanel;
    RzLabel6: TRzLabel;
    Memo1: TMemo;
    RzPanel20: TRzPanel;
    RzPanel21: TRzPanel;
    RzPanel22: TRzPanel;
    RzListView3: TRzListView;
    RzComboBox1: TRzComboBox;
    ScrollBox7: TScrollBox;
    RzSplitter4: TRzSplitter;
    Timer1: TTimer;
    CmapToolsxmi1: TMenuItem;
    ToolButton21: TToolButton;
    CmapToolsCXLbeta1: TMenuItem;
    KBDSbeta1: TMenuItem;
    KnowledgeBases1: TMenuItem;
    Modules1: TMenuItem;
    XMindbeta1: TMenuItem;
    StarUmlxmibeta1: TMenuItem;
    Protege1: TMenuItem;
    Protegeowlbeta1: TMenuItem;
    N41: TMenuItem;
    N42: TMenuItem;
    CFM1: TMenuItem;
    Help2: TMenuItem;
    Importdata1: TMenuItem;
    CanonicalTablescsvbeta1: TMenuItem;
    Join1: TMenuItem;

    procedure N14Click(Sender: TObject);
    procedure N13Click(Sender: TObject);
    procedure N12Click(Sender: TObject);
    procedure N11Click(Sender: TObject);
    procedure RecentFileMenuItemClick(Sender: TObject);
    procedure KBDSkbMenuItemClick(Sender: TObject);
    procedure HelpAbout1Execute(Sender: TObject);
    procedure FileExit1Execute(Sender: TObject);
    procedure N8Click(Sender: TObject);
    procedure N9Click(Sender: TObject);
    procedure N4Click(Sender: TObject);
    procedure N5Click(Sender: TObject);
    procedure N6Click(Sender: TObject);
    procedure N7Click(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure NewKBClick(Sender: TObject);
    procedure TreeView1Click(Sender: TObject);
    procedure N16Click(Sender: TObject);
    procedure ToolButton1Click(Sender: TObject);
    procedure ToolButton2Click(Sender: TObject);
    procedure ToolButton9Click(Sender: TObject);
    procedure DeleteItemClick(Sender: TObject);
    procedure EditItemClick(Sender: TObject);
    procedure NewTClick(Sender: TObject);
    procedure RzButton3Click(Sender: TObject);
    procedure RzButton4Click(Sender: TObject);
    procedure NewRClick(Sender: TObject);
    procedure NewFClick(Sender: TObject);
    procedure ScrollBox1MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure ScrollBox1MouseWheelDown(Sender: TObject; Shift: TShiftState;
      MousePos: TPoint; var Handled: Boolean);
    procedure ScrollBox1MouseWheelUp(Sender: TObject; Shift: TShiftState;
      MousePos: TPoint; var Handled: Boolean);
    procedure CheckBox1Click(Sender: TObject);
    procedure TreeView1DblClick(Sender: TObject);
    procedure N20Click(Sender: TObject);
    procedure PopupMenu1Popup(Sender: TObject);
    procedure RUENG1Click(Sender: TObject);
    procedure ENGRU1Click(Sender: TObject);
    procedure LinkSClick(Sender: TObject);
    procedure TreeView1MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure RzListView1DblClick(Sender: TObject);
    procedure RzListView1Click(Sender: TObject);
    procedure ToolButton8Click(Sender: TObject);
    procedure FormActivate(Sender: TObject);
    procedure ToolButton10Click(Sender: TObject);
    procedure ToolButton11Click(Sender: TObject);
    procedure RationalRosemdl1Click(Sender: TObject);
    procedure TreeView1Edited(Sender: TObject; Node: TTreeNode; var S: string);
    procedure doc1Click(Sender: TObject);
    procedure RzMaskEdit1Change(Sender: TObject);
    procedure Clips1Click(Sender: TObject);
    procedure N15Click(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure N18Click(Sender: TObject);
    procedure RzMaskEdit1Click(Sender: TObject);
    procedure N19Click(Sender: TObject);
    procedure Timer1Timer(Sender: TObject);
    procedure ScrollBox4DragOver(Sender, Source: TObject; X, Y: Integer;
      State: TDragState; var Accept: Boolean);
    procedure ScrollBox4DragDrop(Sender, Source: TObject; X, Y: Integer);
    procedure TabSheet5Show(Sender: TObject);
    procedure TabSheet3Show(Sender: TObject);
    procedure TabSheet1Show(Sender: TObject);
    procedure N29Click(Sender: TObject);
    procedure ToolButton12Click(Sender: TObject);
    procedure N31Click(Sender: TObject);
    procedure C1Click(Sender: TObject);
    procedure ToolButton13Click(Sender: TObject);
    procedure ToolButton17Click(Sender: TObject);
    procedure RzButton2Click(Sender: TObject);
    procedure N34Click(Sender: TObject);
    procedure RzBitBtn1Click(Sender: TObject);
    procedure CLIPSclp1Click(Sender: TObject);
    procedure RationalRosemdl2Click(Sender: TObject);
    procedure TreeView1KeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure English1Click(Sender: TObject);
    procedure N36Click(Sender: TObject);
    procedure N38Click(Sender: TObject);
    procedure AddToRecentFiles(FileName:String);
    procedure LoadRecentMenuItems;
    procedure LoadKBDSMenuItems;

    procedure StarUMLmdj1Click(Sender: TObject);
    procedure RzListView2Change(Sender: TObject; Item: TListItem;
      Change: TItemChange);
    procedure Edit1Click(Sender: TObject);
    procedure PopupMenu3Popup(Sender: TObject);
    procedure ScrollBox4StartDrag(Sender: TObject; var DragObject: TDragObject);
    procedure RzPageControl1DragOver(Sender, Source: TObject; X, Y: Integer;
      State: TDragState; var Accept: Boolean);
    procedure RzSplitter3ULDockOver(Sender: TObject; Source: TDragDockObject; X,
      Y: Integer; State: TDragState; var Accept: Boolean);
    procedure ToolBar1DragOver(Sender, Source: TObject; X, Y: Integer;
      State: TDragState; var Accept: Boolean);
    procedure ToolButton18Click(Sender: TObject);
    procedure TabSheet5Exit(Sender: TObject);
    procedure RzBitBtn2Click(Sender: TObject);
    procedure RzTabSheet2Show(Sender: TObject);
    procedure RzTabSheet1Show(Sender: TObject);
    procedure RzTabSheet3Show(Sender: TObject);
    procedure RzComboBox1Change(Sender: TObject);
    procedure RzListView3Click(Sender: TObject);
    procedure Memo1Change(Sender: TObject);
    procedure TabSheet6Show(Sender: TObject);
    procedure CmapToolsxmi1Click(Sender: TObject);
    procedure ToolButton20Click(Sender: TObject);
    procedure ToolButton20MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure ToolButton19Click(Sender: TObject);
    procedure ToolButton21Click(Sender: TObject);
    procedure CmapToolsCXLbeta1Click(Sender: TObject);
    procedure XMindbeta1Click(Sender: TObject);
    procedure StarUmlxmibeta1Click(Sender: TObject);
    procedure Protege1Click(Sender: TObject);
    procedure Protegeowlbeta1Click(Sender: TObject);
    procedure N41Click(Sender: TObject);
    procedure CFM1Click(Sender: TObject);
    procedure Help2Click(Sender: TObject);
    procedure Importdata1Click(Sender: TObject);
    procedure CanonicalTablescsvbeta1Click(Sender: TObject);

  private
    { Private declarations }
   ModuleID:THandle;
   IntModuleID:TStringList;
  public
    { Public declarations }
   function LS(s:string):string;
   procedure OnEditingNode(Sender: TObject; Node: TTreeNode; var AllowEdit: Boolean);
   procedure MenuItemClick(Sender: TObject);

   Function LoadTree(tmKBList:TList; Tree:TTreeView):Integer;
   function PutChildCount(pN:TTreeNode):String;
   Function RebulidImagesOnTree(Tree:TTreeView):Integer;

   Function LoadCDic(DL:TList;SDL:TStringList;nv:Integer):String;
   Function ReloadKBNames(TN:TTreeNode;KB:TKnowledgeBase):Integer;
   Function GetHelpMessages(HML:TList;HM_Id:Integer):THelpMessage;
   Function LoadHelpMessages(HML:TList; HMF:String):Integer;
   Function ReloadHelpMessage(WC:TWinControl;HM_id:Integer):Integer;

   Function MakeDump(AName:String;AKind:Integer):Integer;
   Function LoadDump(DID:Integer):Integer; //!!!!

   Function LoadAList(WC:TWinControl):Integer;
   Function IndexOfKBbyID(L:TList;ID1:string):Integer;
   Function IndexOfKBbyName(L:TList;ID1:string):Integer;
   function CreateProgressPanel:TPanel;

   function LoadKRLDlls(var List:TStringList;var Index:Integer):Integer;
   procedure FindDlls(Path:String;
                      const ListOfFiles:TStringList);
   Function CallFunction(DllName,FName: String):String;
   procedure InternalGetMethodEntryPoint(ModuleHandle: THandle;
                                        const NameOfMethod: String;
                                        out EntryPoint: Pointer);
   function ReloadMenuItems(var List:TStringList;MenuItem:TMenuItem):Integer;
   procedure KRLMenuItemClick(Sender: TObject);

   function LoadParams:Integer;
   procedure ResultPanelClick(Sender: TObject);
   function MMessageBox(T,BT:Integer;Txt:string):integer;

   Function GetKBForNode(N:TTreeNode):TKnowledgeBase;
   procedure LabelClick_V2(Sender: TObject);

   Function ApplyPolicy(um:Integer):Integer;
   procedure ScrollBoxMouseWheelUp(Sender: TObject;
    Shift: TShiftState; MousePos: TPoint; var Handled: Boolean);
   procedure ScrollBoxMouseWheelDown(Sender: TObject;
    Shift: TShiftState; MousePos: TPoint; var Handled: Boolean);

   procedure RVMLImageMouseDown(Sender: TObject; Button: TMouseButton;
    Shift: TShiftState; X, Y: Integer);
   procedure RVMLImageMouseUp(Sender: TObject; Button: TMouseButton;
    Shift: TShiftState; X, Y: Integer);
   procedure RVMLImageMouseMove(Sender: TObject; Shift: TShiftState; X,
    Y: Integer);
   procedure RVMLImageMouseClick(Sender: TObject);
   procedure RVMLImageDragDrop(Sender, Source: TObject; X, Y: Integer);

//   procedure ShowRuleComponentImageClick(Sender: TObject);

  procedure tmPSODragOver(Sender, Source: TObject; X, Y: Integer;
   State: TDragState; var Accept: Boolean);
  procedure tmPSODragDrop(Sender, Source: TObject; X, Y: Integer);

  procedure RVMLElementDBClick (Sender:TObject);
  function GetListOfExpertSystems:integer;
  procedure ESMenuItemClick(Sender: TObject);
 end;

var
  MainForm: TMainForm;
  UserMode : Integer; //user mode: operator or administrator

  KBDS_server_url : string;
  KBDS_mList : TStringList;
  KBDS_kbList : TStringList;

  LangLocaleDir : string;
  LangPrefix : string;
  LF1 : string;

  FileNameD: String; //Адрес подключенного справочника-
  KB_Index: Integer;  //index of selected KB in KB-List
  tmKb  : TKnowledgeBase;
  KBList  : TList;  //List of Loaded KBs
  CDicList  : TList;
  SelectedCDic  : TStringList;
  HelpMessages  : TList;
  AList : TList;
  DllList : TStringList;
  DllListForAbout : TStringList;
  DllIndex  : Integer;

  EntryPoint:Pointer;

  Replacements : TStringList;
  OLst1 : TStringList;
  CurrentRVMLObject : TObject;

  Ver : string;
  HDDID : String;
  TH,TH1,TH2    :     Cardinal;
  TID,TID1,TID2   :     DWORD;
  F1 : Integer;

  tmPSO : TRzLabel;
  imX,imY : Integer;

  tmPSO1,tmPSO2,tmPSO3,tmPSO4 : TRzLine;

  prIm : TImage;
  prP : TrzPanel;     //progress panel
  pName : String;     //platform name

  fUpadate : String; //update flag

implementation

{$R *.dfm}

uses  uaddKB,about,SDXML,uExp, USTDIClass, UDicForm, USSClass,
      uTrans, USEClass, UStartProjectForm, UMsgBoxForm, AddFactForm2Unit,
  CRPManagerUnit, UViewReportForm, AddRuleForm2Unit, RBRFormUnit,
  AddRuleForm3Unit, AddTempFormUnit, AddGRuleForm4Unit, URVMLElementEditUnit,
  UESDescriptionForm, RRPManagerUnit, UImportDataForCasesForm;
//-----------------------------------------------------------------------------
procedure TMainForm.ESMenuItemClick(Sender: TObject);
var
 s : string;
 tmTs : TStringList;
begin
  if MMessageBox(1,1,'0='+
    LS('Run the expert system')+' ('+
     TMenuItem(Sender).Caption+')'
//    STDIClass.LoadSingleString('Save the knowledge base',LangLocaleDir+LangPrefix+'012.lan')
//    +': '+
//    TKnowledgeBase(TreeView1.Selected.Data).Name
     +'?')=0  then
   begin
     tmTs:=TStringList.Create;
     tmTs.Delimiter:='(';
     tmTs.DelimitedText:=Trim(StringReplace(
        TMenuItem(Sender).Caption,'&','',[rfReplaceAll]));

     s:=ExtractFileDir(Application.ExeName)+
       '\Expert systems\'+tmTs.Strings[0];
     ShellExecute(Handle, 'open',
      PWideChar('PKBD.exe'), nil,
       PWideChar(s), SW_SHOWNORMAL);
   end;
end;
//-----------------------------------------------------------------------------
function  TMainForm.GetListOfExpertSystems:integer;
var
// i : Integer;
 FileAttrs: Integer;
 sr: TSearchRec;
 Path : string;
 tMI : TMenuItem;
begin
 try
  FileAttrs:=faDirectory;
//  if Path=''
//   then
  Path:=ExtractFileDir(Application.ExeName)+'\Expert systems\';

    if SysUtils.
       FindFirst(Path+'\*.*',
                 FileAttrs,
                 sr) = 0
     then
      repeat
       if (System.Pos('.',sr.Name)=0) and
         (sr.Size=0)
        then
         begin
           //обновить пункт меню со списком экспертных систем
            tMI:=TMenuItem.Create(tMI);

            tMI.Caption:=sr.Name+' ('+DateTimeToStr(sr.TimeStamp)+')';

            tMI.OnClick:=ESMenuItemClick;
            MainForm.MainMenu.Items.Items[4].Insert(0,tMI);
         end;
       until SysUtils.FindNext(sr)<>0;
  SysUtils.FindClose(sr);
 finally;
 end;

 Result:=MainForm.MainMenu.Items.Items[4].Count-2;
end;
//-----------------------------------------------------------------------------
procedure TMainForm.RVMLElementDBClick (Sender:TObject);
var
 nF : TRVMLElementEditForm;
 K : TKnowledgeBase;
 tmObj1 : TObject;
begin
//  ScrollBox4.Enabled:=False;
  Application.CreateForm(TRVMLElementEditForm, nF);
  K:=GetKBForNode(TreeView1.Selected);
 //get selected object

  if TObject(CurrentRVMLObject) is TTemplate then
   begin
    K.CopyTemplate(1,TTemplate(CurrentRVMLObject),TTemplate(nF.tmObj));
   end;
  if TObject(CurrentRVMLObject) is TFact then
   begin
    K.CopyFact(1,TFact(CurrentRVMLObject),TFact(nF.tmObj));
   end;

  if TObject(TreeView1.Selected.Data) is TGRule then
  begin
   tmObj1:=TGRule(TreeView1.Selected.Data).GetElementByPosition(
    imX, imY);
   if tmObj1 is TTemplate then
    K.CopyTemplate(1,TTemplate(tmObj1),TTemplate(nF.tmObj));
   if tmObj1 is TGRule then
    K.CopyGRule(1,TGRule(tmObj1),TGRule(nF.tmObj));
  end;

  if TObject(TreeView1.Selected.Data) is TRule then
  begin
   tmObj1:=TRule(TreeView1.Selected.Data).GetElementByPosition(
    imX, imY);
   if tmObj1 is TCondition then
    K.CopyFact(1,TFact(TCondition(tmObj1).Fact),TFact(nF.tmObj));
   if tmObj1 is TRAction then
    K.CopyFact(1,TFact(TRAction(tmObj1).Fact),TFact(nF.tmObj));
   if tmObj1 is TRule then
    K.CopyRule(1,TRule(tmObj1),TRule(nF.tmObj))
  end;

//show and hide tabs
//!!!
 nF.RzPanel5.Visible:=False;  //slot value
 nF.RzPanel6.Visible:=False;  //slot datatype

 nF.RzPanel4.Visible:=True;  //id

 nF.ShowModal;
//ScrollBox4.Enabled:=True;
end;
//-----------------------------------------------------------------------------
procedure TMainForm.tmPSODragDrop(Sender, Source: TObject; X, Y: Integer);
begin
 ScrollBox4DragDrop(Sender, Source, X, Y);
end;
//-----------------------------------------------------------------------------
procedure TMainForm.tmPSODragOver(Sender, Source: TObject; X, Y: Integer;
  State: TDragState; var Accept: Boolean);
begin
//
end;
//-----------------------------------------------------------------------------
function TMainForm.LS(s:string):string;
begin
 Result:=STDIClass.LoadSingleString(s,LangLocaleDir+LangPrefix+'012.lan');
end;

procedure TMainForm.StarUMLmdj1Click(Sender: TObject);
var
  ext : String;
begin
 OpenDialog1.Title:=Application.Title+': '+
  STDIClass.LoadSingleString('Import templates and generalized rules from mdj',LangLocaleDir+LangPrefix+'012.lan')
  ;

 ext:='.mdj';
 OpenDialog1.FileName:='';
 OpenDialog1.Filter:='StarUML files |'
   +'*'+ext+'|'+'StarUML files (xmi)|*.xml|'
   +STDIClass.LoadSingleString('All',LangLocaleDir+LangPrefix+'012.lan')
   +'|*.*';
 OpenDialog1.InitialDir:=ExtractFileDir(Application.ExeName)+'\Models';
 if OpenDialog1.Execute then
  if OpenDialog1.FileName<>'' then
   begin
     tmKb:=TKnowledgeBase.Create;
     tmKb.Init;
     if pos('.xml',OpenDialog1.FileName)>0 then
      tmKb.LoadFromCXLFile(
       ExtractFileDir(Application.ExeName)+'\Dll\xmi.staruml.i.dll',
        OpenDialog1.FileName)
      else
       tmKb.LoadFromMDJFile(OpenDialog1.FileName);

     Application.CreateForm(TExp, Exp);

     Exp.KB:=tmKb;
     Exp.Tag:=3;
     Exp.ShowModal;
   end
end;

procedure TMainForm.StarUmlxmibeta1Click(Sender: TObject);
begin
 Application.CreateForm(TExp, Exp);

 Exp.KB:=nil;
 Exp.Tag:=7;
 Exp.ShowModal;
end;

//-----------------------------------------------------
procedure TMainForm.RVMLImageMouseClick(Sender: TObject);
begin
 if (TObject(TreeView1.Selected.Data) is TTemplate)or
  (TObject(TreeView1.Selected.Data) is TFact) then
   CurrentRVMLObject:=TreeView1.Selected.Data;
 if (TObject(TreeView1.Selected.Data) is TGRule)or
  (TObject(TreeView1.Selected.Data) is TRule) then
   begin
    CurrentRVMLObject:=TreeView1.Selected.Data;
   end;
end;
//-----------------------------------------------------
procedure TMainForm.RVMLImageMouseDown(Sender: TObject; Button: TMouseButton;
  Shift: TShiftState; X, Y: Integer);
begin
  if Button=mbLeft then
   TImage(Sender).BeginDrag(False);
end;
//----------------------------------------------------
procedure TMainForm.RVMLImageMouseUp(Sender: TObject; Button: TMouseButton;
  Shift: TShiftState; X, Y: Integer);
begin
 if Button=mbLeft then
  begin
   if CurrentRVMLObject is TTemplate then
    begin
     TTemplate(CurrentRVMLObject).RVMLImage.Left := X; //Переместить компонент Image в координаты //курсора по X
     TTemplate(CurrentRVMLObject).RVMLImage.Top := Y;
    end;
  end;
// CurrentRVMLObject:=nil;
end;
//----------------------------------------------------
procedure TMainForm.RVMLImageMouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
 //
{ if CurrentRVMLObject is TTemplate then
  begin
   TTemplate(CurrentRVMLObject).DrawParams.Values['x']:=IntToStr(x);
   TTemplate(CurrentRVMLObject).DrawParams.Values['y']:=IntToStr(y);
  end;
 if CurrentRVMLObject is TFact then
  begin
   TFact(CurrentRVMLObject).DrawParams.Values['x']:=IntToStr(x);
   TFact(CurrentRVMLObject).DrawParams.Values['y']:=IntToStr(y);
  end; }
end;
//----------------------------------------------------
procedure TMainForm.ScrollBoxMouseWheelDown(Sender: TObject;
  Shift: TShiftState; MousePos: TPoint; var Handled: Boolean);
var
 m  : Integer;
begin
if Sender is TScrollBox then
begin
 m:=15;
 if TScrollBox(Sender).VertScrollBar.Position+m>
  TScrollBox(Sender).VertScrollBar.Range then
  m:=m-abs(TScrollBox(Sender).VertScrollBar.Range-
   TScrollBox(Sender).VertScrollBar.Position-m);
 TScrollBox(Sender).VertScrollBar.Position:=
  TScrollBox(Sender).VertScrollBar.Position+m;
 end;
end;
//----------------------------------------------------
procedure TMainForm.ScrollBoxMouseWheelUp(Sender: TObject;
  Shift: TShiftState; MousePos: TPoint; var Handled: Boolean);
var
 m  : Integer;
begin
if Sender is TScrollBox then
begin
 m:=15;
 if TScrollBox(Sender).VertScrollBar.Position-m<0 then
  m:=m-abs(TScrollBox(Sender).VertScrollBar.Position-m);
  TScrollBox(Sender).VertScrollBar.Position:=
   TScrollBox(Sender).VertScrollBar.Position-m;
end;
end;
//----------------------------------------------------
Function TMainForm.ApplyPolicy(um:Integer):Integer;
begin
 RzMaskEdit1.Visible:=False;

 case um of
   0:begin  //for operator
    ToolButton11.Enabled:=False; //package
    DeleteItem.Enabled:=False;
    //!!!!
    //    EditItem.Enabled:=False;
    N5.Enabled:=False;
    TreeView1.OnEditing:=OnEditingNode;
    RzPanel6.Visible:=True; //mode panel
    RzPanel6.Caption:='Domain-Specific Editor Mode';

    N8.Checked:=True;  //operator menu item
    N9.Checked:=False; //administrator menu item
    //----------------------------
    NewKB.Visible:=False;
    NewT.Visible:=False;
    ToolButton13.Visible:=False; //add grule

    N13.Enabled:=False;   //import
    N7.Enabled:=False;   //kb
    N5.Enabled:=False;   //template
    N33.Enabled:=False;   //grule
    //-------------------------------
    //pswd field
{    RzMaskEdit1.Visible:=True;
    RzMaskEdit1.PasswordChar:='*';
    RzMaskEdit1.Text:=
    STDIClass.LoadSingleString('Password',LangLocaleDir+LangPrefix+'012.lan');
//   SetFocusedControl(RzMaskEdit1);
    RzMaskEdit1.SetFocus;
//   Sleep(1000);
    RzMaskEdit1Click(RzMaskEdit1);
   }
   end;
   1:begin  //for administrator
    ToolButton11.Enabled:=True; //package
    DeleteItem.Enabled:=True;
    EditItem.Enabled:=True;
    N5.Enabled:=True;

    RzPanel6.Visible:=False; //mode panel
//    RzPanel6.Caption:='Domain-Specific Editor Mode';

    N8.Checked:=False;  //operator menu item
    N9.Checked:=True; //administrator menu item

//    RzMaskEdit1.Visible:=False;
    //----------------------------
    NewKB.Visible:=True;
    NewT.Visible:=True;
    ToolButton13.Visible:=True; //add grule

    N13.Enabled:=True;   //import
    N7.Enabled:=True;   //kb
    N5.Enabled:=True;   //template
    N33.Enabled:=True;   //grule
    //-------------------------------
  end;
 end; //end case
 TreeView1Click(TreeView1);
end;
//----------------------------------------------------
procedure TMainForm.Memo1Change(Sender: TObject);
begin
 TTask(TreeView1.Selected.Data).Description:=
  Trim(TMemo(Sender).Text);
 TTask(TreeView1.Selected.Data).
  Modification_date:=DateTimeToStr(Now);
 RzEdit5.Text:=TTask(TreeView1.Selected.Data).
  Modification_date;
end;

procedure TMainForm.MenuItemClick(Sender: TObject);
var
 i,j,c  : Integer;
 s,s1 : string;
 K14 : TKnowledgeBase;
 tmT : TTemplate;
 tmR : TRule;
 tmF : TFact;
 tmGR : TGRule;
begin
  s:=IntToStr(TMenuItem(Sender).Tag); //id of package
//  if MMessageBox(1,3,'0=Копировать или переместить?')=0

  if MMessageBox(1,3,'0='+
   STDIClass.LoadSingleString('Copy or Remove',LangLocaleDir+LangPrefix+'012.lan')
    +'?')=0
   then
    begin
//     s1:='Перемещение';
     s1:=STDIClass.LoadSingleString('Remove',LangLocaleDir+LangPrefix+'012.lan');
     c:=0;
    end
     else
      begin
//       s1:='Копирование';
       s1:=STDIClass.LoadSingleString('Copy',LangLocaleDir+LangPrefix+'012.lan');
       c:=1;
      end;

     for i := 0 to TreeView1.SelectionCount-1 do
      begin
       K14:=GetKBForNode(TreeView1.Selections[i]);
       if TObject(TreeView1.Selections[i].Data) is TTemplate then
        begin
         j:=K14.TempPackageList.IndexOfName(s);
         if j>-1 then
          begin
           if c=1 then  //create new in current pkg
            begin
             K14.CopyTemplate(0,
              TTemplate(TreeView1.Selections[i].Data),tmT);
             K14.Templates.Add(tmT);
            end
             else
              tmT:=TTemplate(TreeView1.Selections[i].Data);
           //remove exist
           tmT.PackageName:=s;
           tmT.RootPackageName:=
            TTmObj(K14.TempPackageList.Objects[j]).ID_Root;
           end;
        end;
       if TObject(TreeView1.Selections[i].Data) is TFact then
        begin
         j:=K14.FactPackageList.IndexOfName(s);
         if j>-1 then
          begin
           if c=1 then  //create new in current pkg
            begin
             K14.CopyFact(0,
              TFact(TreeView1.Selections[i].Data),tmF);
             K14.Facts.Add(tmF);
            end
             else
              tmF:=TFact(TreeView1.Selections[i].Data);
           //remove exist
           tmF.PackageName:=s;
           tmF.RootPackageName:=
            TTmObj(K14.FactPackageList.Objects[j]).ID_Root;
          end;
        end;
       if TObject(TreeView1.Selections[i].Data) is TGRule then
        begin
         j:=K14.GRulePackageList.IndexOfName(s);
         if j>-1 then
          begin
           if c=1 then  //create new in current pkg
            begin
             K14.CopyGRule(0,
              TGRule(TreeView1.Selections[i].Data),tmGR);
             K14.GRules.Add(tmGR);
            end
             else
              tmGR:=TGRule(TreeView1.Selections[i].Data);
           //remove exist
           tmGR.PackageName:=s;
           tmGR.RootPackageName:=
            TTmObj(K14.GRulePackageList.Objects[j]).ID_Root;
          end;
        end;
       if TObject(TreeView1.Selections[i].Data) is TRule then
        begin
         j:=K14.RulePackageList.IndexOfName(s);
         if j>-1 then
          begin
           if c=1 then  //create new in current pkg
            begin
             K14.CopyRule(0,
              TRule(TreeView1.Selections[i].Data),tmR);
             K14.Rules.Add(tmR);
            end
             else
              tmR:=TRule(TreeView1.Selections[i].Data);
           //remove exist
           tmR.PackageName:=s;
           tmR.RootPackageName:=
            TTmObj(K14.RulePackageList.Objects[j]).ID_Root;
          end;
        end;
      end;

 MainForm.MakeDump(s1+' '+
  STDIClass.LoadSingleString('objects to the package: ',LangLocaleDir+LangPrefix+'012.lan')
  +' '+
  StringReplace(TMenuItem(Sender).Caption,'&','',[rfReplaceAll])
   ,38);
 MainForm.LoadAList(MainForm.RzListView1);
 //reload tree
 MainForm.LoadTree(KBList,MainForm.TreeView1);
end;
//----------------------------------------------------
Function TMainForm.GetKBForNode(N:TTreeNode):TKnowledgeBase;
begin
 Result:=nil;
 if N<>nil then
  begin
  if N.Index=0 then
   begin
    if KBList.Count>0 then
     Result:=TKnowledgeBase(KBList.Items[0]);
   end
  else
   begin
     if TObject(N.Data) is TKnowledgeBase then
      Result:=TKnowledgeBase(N.Data)
      else
       Result:=GetKBForNode(N.Parent);
   end;
  end;
end;
//----------------------------------------------------
procedure TMainForm.OnEditingNode(Sender: TObject; Node: TTreeNode; var AllowEdit: Boolean);
begin
 if (UserMode=1)and(TObject(Node.Data) is TTmObj) then
  AllowEdit:=True
   else
    AllowEdit:=False;
end;
//----------------------------------------------------
procedure TMainForm.ResultPanelClick(Sender: TObject);
var
 nF : TVRItemForm;
 c : Integer;
 T3 : TTask;
begin
 Application.CreateForm(TVRItemForm, nF);
 T3:=TTask(TreeView1.Selected.Data);
 c:=T3.K1.IndexOfFactByID(T3.CBRPResults.Names[
  TComponent(Sender).Tag
  ]);
 nF.ai:=TComponent(Sender).Tag;
 nF.T3:=T3;
 if c=-1 then nF.FA:=nil
  else
   begin
    nF.FA:=TFact(T3.K1.Facts.Items[c]);
   end;
 nF.RzButton2.Visible:=False;
 nF.RzButton3.Visible:=False;

 nF.ShowModal;
end;
//----------------------------------------------------
function TMainForm.MMessageBox(T,BT:Integer;Txt:string):integer;
var
 tmTs : TStringList;
 i,k,m,t1 : Integer;
 tmP : TRzPanel;
begin
 tmTs:=TStringList.Create;
 tmTs.Text:=Txt;

 MsgBoxForm.Position:=poMainFormCenter;

 MsgBoxForm.RzButton1.Visible:=True;
 MsgBoxForm.RzButton2.Visible:=False;

 MsgBoxForm.Caption:=Application.Title;

 MsgBoxForm.RzLabel1.Caption:=' '+Application.Title+' v.'+Ver+' ';

 MsgBoxForm.Image1.Picture:=nil;
 MsgBoxForm.ImageList1.GetBitmap(T,MsgBoxForm.Image1.Picture.Bitmap);

 MsgBoxForm.RzButton2.Visible:=False;
// MsgBoxForm.RzButton3.Visible:=False;

 MsgBoxForm.RzButton1.Caption:=
  STDIClass.LoadSingleString('Close',LangLocaleDir+LangPrefix+'012.lan');
 case BT of
 1:begin
   MsgBoxForm.RzButton2.Visible:=True;
   MsgBoxForm.RzButton1.Caption:=
    STDIClass.LoadSingleString('Yes',LangLocaleDir+LangPrefix+'012.lan');
   MsgBoxForm.RzButton2.Caption:=
    STDIClass.LoadSingleString('No',LangLocaleDir+LangPrefix+'012.lan');
  end;
 2:begin
   MsgBoxForm.RzButton2.Visible:=True;
   MsgBoxForm.RzButton2.Caption:=
    'Run';
//    STDIClass.LoadSingleString('Run',LangLocaleDir+LangPrefix+'012.lan');
  end;
 3:begin
   MsgBoxForm.RzButton2.Visible:=True;
   MsgBoxForm.RzButton1.Caption:=
    STDIClass.LoadSingleString('Remove',LangLocaleDir+LangPrefix+'012.lan');
   MsgBoxForm.RzButton2.Caption:=
    STDIClass.LoadSingleString('Copy',LangLocaleDir+LangPrefix+'012.lan');
  end;
 4:begin
   MsgBoxForm.RzButton1.Visible:=False;
   MsgBoxForm.RzButton2.Visible:=False;
  end;
 end; //end case

 t1:=1;
// t1:=tmTs.Count;
 STDIClass.ReleaseObjects(MsgBoxForm.RzPanel1);

 for i := 0 to tmTs.Count-1 do
  if Trim(tmTs.Strings[i])<>'' then
  begin

{   t1:=STDIClass.AddRzLabel(MsgBoxForm.RzPanel1,Trim(tmTs.ValueFromIndex[i]),t1,1,
    MsgBoxForm.RzPanel1.Width,StrToInt(tmTs.Names[i]),clNone,[]);
   TRzLabel(MsgBoxForm.RzPanel1.Components[MsgBoxForm.RzPanel1.ComponentCount-1]).
    AutoSize:=True;
   TRzLabel(MsgBoxForm.RzPanel1.Components[MsgBoxForm.RzPanel1.ComponentCount-1]).
    Font.Size:=10;
   TRzLabel(MsgBoxForm.RzPanel1.Components[MsgBoxForm.RzPanel1.ComponentCount-1]).
    Align:=alTop;
  }
   tmP:=STDIClass.AddRzPanel(i*15,1,15,MsgBoxForm.RzPanel1.Width,
    MsgBoxForm.RzPanel1,0,alTop,clCream,bvNone,bvNone,bsNone,
     (tmTs.ValueFromIndex[i]));
//   tmP.Color:=0;
   tmP.Font.Color:=StrToInt(tmTs.Names[i]);
   tmP.Alignment:=taLeftJustify;
//   if i=0 then
//    begin
//     tmP.AlignWithMargins:=True;
//    end;

   k:=Length(tmTs.ValueFromIndex[i]) div 42;
   m:=Length(tmTs.ValueFromIndex[i]) mod 42;//39
   if m>0 then inc(k);
//   t1:=t1+k-1;
   t1:=t1+k;
   tmP.Height:=16*k;
  end;
 //!!!
// MsgBoxForm.Caption:=IntToStr(Length(tmTs.Text));
// MsgBoxForm.Caption:=MsgBoxForm.Caption+':'+IntToStr(t1-1);
 MsgBoxForm.Height:=98+(t1-1)*15;


 if MsgBoxForm.Tag=0 then MsgBoxForm.ShowModal
  else MsgBoxForm.Show;
 Result:=MsgBoxForm.C;
end;
//----------------------------------------------------
function TMainForm.LoadParams:Integer;
function GetKBinCurrentDir(s:string):string;
var
// i : Integer;
 FileAttrs: Integer;
 sr: TSearchRec;
 Path : string;
begin
 Result:='';
 try
  FileAttrs:=faNormal;
  Path:=ExtractFileDir(Application.ExeName);

    if SysUtils.
       FindFirst(Path+'\*.*',
                 FileAttrs,
                 sr) = 0
     then
      repeat
       if (System.Pos(s,sr.Name)>0) and
         (sr.Size>0)
        then
         begin
           //return file name
           Result:=Path+'/'+sr.Name;
           Break;
         end;
       until SysUtils.FindNext(sr)<>0;
  SysUtils.FindClose(sr);
 finally;
 end;
end;

var
 i,j  : Integer;
 s,s3,s4 : string;
 tmKB1  : TKnowledgeBase;
 tmTs : TStringList;
 tmT : TTask;
 tTN : TTreeNode;
begin
 if ParamCount>0 then
  begin
   //load with params
   for i:=1 to ParamCount do
    if pos('.ekb',ParamStr(i))>0 then
     begin

      tmKB1:=TKnowledgeBase.Create;
      tmKB1.Init;
      tmKB1.FileName:=ParamStr(i);
//      tmKB1.ID:=GetKBID(KBList);

      if XmlDow.parXML(ParamStr(i),tmKB1)=0 then
       begin
//        MainForm.MakeDump('Открытие базы знаний',7);
        MainForm.MakeDump(
         STDIClass.LoadSingleString('Open: knowledge base',LangLocaleDir+LangPrefix+'012.lan')
          ,7);
        MainForm.LoadAList(MainForm.RzListView1);

        KBList.Add(tmKB1);
        MainForm.LoadTree(KBList,MainForm.TreeView1);
      end;
     end
  end
 else
  begin
   if Self.Tag=1 then  //es mode
    begin
     j:=0;
     //load kb in the current dir
      tmKB1:=TKnowledgeBase.Create;
      tmKB1.Init;
      s:=GetKBinCurrentDir('.ekb');
      if s<>'' then
       begin
        if XmlDow.parXML(s,tmKB1)=0 then
         begin
          KBList.Add(tmKB1);
          MainForm.LoadTree(KBList,MainForm.TreeView1);
          TreeView1.Selected:=
           TreeView1.Items.Item[0].Item[0].Item[4].Item[0];
          Caption:=LS('Expert system: ')+ TTask(TreeView1.Selected.Data).Name+' v.'+
           TTask(TreeView1.Selected.Data).task_Ver;
          pName:=TTask(TreeView1.Selected.Data).Platfotm;
          j:=1;
//          TreeView1Click(TreeView1);
         end;
       end;

      s:=GetKBinCurrentDir('.clp');
      if s<>'' then
       begin
        tmKB1.LoadFromFileAs(ExtractFileDir(Application.ExeName)+'\Dll\cs.dll',
         s);
        KBList.Add(tmKB1);
        MainForm.LoadTree(KBList,MainForm.TreeView1);
        //create task for kb
        tmTs:=TStringList.Create;
        tmTs.Delimiter:=';';
        tmTs.LoadFromFile(s);
        tmT:=TTask.Create;
        tmT.Init;

        tmT.ID:=tmTs.Values[';Task_ID'];
        tmT.Name:=tmTs.Values[';Task_Name'];

        tmT.Description:=tmTs.Values[';Task_Description'];
        tmT.Authors:=tmTs.Values[';Task_Authors'];
        if tmT.Authors='' then tmT.Authors:='Unknown';

        tmT.Creation_date:=tmTs.Values[';Task_Creation_date'];
        if tmT.Creation_date='' then tmT.Creation_date:=DateTimeToStr(Now);

        tmT.Modification_date:=tmTs.Values[';Task_Modification_date'];
        if tmT.Modification_date='' then tmT.Modification_date:=DateTimeToStr(Now);

        tmT.task_Ver:=tmTs.Values[';Task_Ver'];
        if tmT.task_Ver='' then tmT.task_Ver:='1';

        tmT.Platfotm:=tmTs.Values[';Task_Platfotm'];
        if tmT.Platfotm='' then tmT.Platfotm:='Windows/CLIPS-PKBD';

        s3:=GetCurrentDir;
        if tmT.Description='' then tmT.Description:=s3;
        tmTs.Delimiter:='\';
        tmTs.DelimitedText:=s3;
        s4:=tmTs.Strings[tmTs.Count-1];
        tmTs.Delimiter:='_';
        tmTs.DelimitedText:=s4;

        if tmT.ID='' then
         if tmTs.Count>=1 then tmT.ID:=tmTs.Strings[1];

        if tmT.Name='' then
         if tmTs.Count>=0 then tmT.Name:=tmTs.Strings[0];

        tmKB1.Tasks.Add(tmT);
        //------------------
        //add node to tree view
        tTN:=TreeView1.Items.Item[0].Item[0].Item[4];
        TreeView1.Items.AddChildObject(tTN,tmT.Name,tmT);
        TreeView1.Selected:=
         TreeView1.Items.Item[0].Item[0].Item[4].Item[0];
        Caption:=LS('Expert system: ')+ TTask(TreeView1.Selected.Data).Name+' v.'+
         TTask(TreeView1.Selected.Data).task_Ver;
        pName:=TTask(TreeView1.Selected.Data).Platfotm;
        j:=1;
       end;

      if j=0 then
         MMessageBox(1,0,'0='+
          LS('Error: Knobledge base file is missing')
           );
    end
   else
    begin //editor mode
     //select the possible actions
     Application.CreateForm(TStartProjectForm, StartProjectForm);
     StartProjectForm.ShowModal;
     StartProjectForm.Free;
    end;
  end;
end;

procedure TMainForm.KRLMenuItemClick(Sender: TObject);
var
 i  : Integer;
begin
 if TMenuItem(Sender).Checked then
  begin
   ToolButton10.Enabled:=False;
   TMenuItem(Sender).Checked:=False;
   RzPageControl1.Pages[1].TabVisible:=False;
   if RzPageControl1.ActivePageIndex=1 then
    RzPageControl1.ActivePageIndex:=0;
  end
 else
  begin
   ToolButton10.Enabled:=True;
   RzPageControl1.Pages[1].TabVisible:=True;

   for i:=0 to TMenuItem(Sender).Parent.Count-1 do
    TMenuItem(Sender).Parent.Items[i].Checked:=False;

   TMenuItem(Sender).Checked:=True;
   DllIndex:=TMenuItem(Sender).Parent.IndexOf(TMenuItem(Sender));
   RzPageControl1.Pages[1].Caption:=
    STDIClass.LoadSingleString('Programm code: ',LangLocaleDir+LangPrefix+'012.lan')+
//   RzPageControl1.Pages[1].Caption:='Код на '+
    DllList.ValueFromIndex[DllIndex];
   if RzPageControl1.ActivePageIndex=1 then
    TreeView1Click(TreeView1);
  end;
end;

function TMainForm.ReloadMenuItems(var List:TStringList;MenuItem:TMenuItem):Integer;
var
//  i : Integer;
  tMI : TMenuItem;
begin
 try
  MenuItem.Clear;
  ///!!!!!

{  for i:=0 to List.Count-1 do
   begin
    tMI:=TMenuItem.Create(MenuItem);
    tMI.Caption:=List.ValueFromIndex[i];
    tMI.OnClick:=KRLMenuItemClick;
    MenuItem.Add(tMI);
   end;
   }
    tMI:=TMenuItem.Create(MenuItem);
    tMI.Caption:='CLIPS (6.1)';
    tMI.OnClick:=KRLMenuItemClick;
    MenuItem.Add(tMI);

  if List.Count>0 then
   begin
//    MenuItem.Items[0].Checked:=True;
    Result:=0;
    MenuItem.Enabled:=True;
    MenuItem.Items[0].OnClick(MenuItem.Items[0]);
   end
    else
     begin
      Result:=-1;
      MenuItem.Enabled:=False;
     end;
 except
  Result:=-1;
 end;
end;

procedure TMainForm.InternalGetMethodEntryPoint;
begin
 EntryPoint:=nil;
  try
   if ModuleHandle=0
    then
     raise EAccessViolation.
            Create('The DLL identificator is wrong');
   EntryPoint:=Windows.
                GetProcAddress(ModuleHandle,
                               PChar(NameOfMethod));
 finally;
 end;
end;

procedure TMainForm.C1Click(Sender: TObject);
begin
  ToolButton12Click(ToolButton12);
end;

Function TMainForm.CallFunction(DllName,FName: String):String;
type
  TLibraryMethod = function:WideString ;stdcall;
var
 LibraryMethod:TLibraryMethod;

begin
 Result:='';
 IntModuleID:=TStringList.Create;

  IntModuleID.Add(
   sysUtils.IntToStr(LoadLibrary(PChar(DllName))));

 LibraryMethod:=Windows.GetProcAddress(StrToInt(IntModuleID.Strings[0]),
  PChar(FName));

 Result:=LibraryMethod;
end;


procedure TMainForm.CanonicalTablescsvbeta1Click(Sender: TObject);
var
  ext : String;
  i : Integer;
begin
 OpenDialog1.Title:=Application.Title+': '+
    STDIClass.LoadSingleString('Import',LangLocaleDir+LangPrefix+'012.lan');

// if (DllIndex<>-1)and(DllList.Count>0) then
//   begin
//    if pos('CLIPS',DllList.ValueFromIndex[DllIndex])<>0 then

     ext:='.csv';// else ext:='.*';
 OpenDialog1.Filter:='CSV files |'
   +'*'+ext+'|'
   +STDIClass.LoadSingleString('All',LangLocaleDir+LangPrefix+'012.lan')
   +'|*.*';
 OpenDialog1.InitialDir:=ExtractFileDir(Application.ExeName)+'.\Data';
 OpenDialog1.Options:=[ofAllowMultiSelect];

 if OpenDialog1.Execute then
  if OpenDialog1.FileName<>'' then
   begin
    tmKb.Init;

    prP:=STDIClass.CreateProgressIndicator(Self,
     IntToStr(OpenDialog1.Files.Count)
      );

    for i := 0 to OpenDialog1.Files.Count-1 do
     begin
      tmKb.LoadFromCSVFile(OpenDialog1.Files.Strings[i]);
      //-----------------------------
//      prP.Caption:=LS('Please,wait')+' ('+
      prP.Caption:=LS('Transforming')+' ('+
       IntToStr(Round(100*i/OpenDialog1.Files.Count))
       +'%)';
      Application.ProcessMessages;
      //-----------------------------
     end;

     tmKb.Aggregate('');

     prP.Free;
     Application.CreateForm(TExp, Exp);

     Exp.KB:=tmKb;
     Exp.Tag:=3;
     Exp.ShowModal;
   end
{ end
   else
    begin
     MMessageBox(1,0,'0='+
      STDIClass.LoadSingleString('Programming languages support modules are missing',LangLocaleDir+LangPrefix+'012.lan')
       );
    end; }
end;

procedure TMainForm.CFM1Click(Sender: TObject);
var
 K : TKnowledgeBase;
begin
  K:=GetKBForNode(TreeView1.Selected);
  if K<>nil then
    if MMessageBox(1,1,'0='+
      LS('Create CFM specifictions for')+' '+
       K.Name
        +'?')=0  then
     begin
      if K.CreateCFM('Test')=1 then
       MMessageBox(0,0,'0='+LS('CFM specifictions are created in the folder:')+' .../Data/CFM/'+K.Name)
        else
           MMessageBox(1,0,'0='+
            LS('Error CFM')
             );
     end;
end;

Procedure TMainForm.FindDlls(Path:String; const ListOfFiles:TStringList);

var
 FileAttrs: Integer;
 sr: TSearchRec;
 i: Integer;
begin
 try
  FileAttrs:=faAnyFile;
  if Path=''
   then
    Path:=SysUtils.GetCurrentDir;
    if SysUtils.
       FindFirst(Path+'\*.*',
                 FileAttrs,
                 sr) = 0
     then
      repeat
       if (System.Pos('.',sr.Name)=0) and
         (sr.Size=0)
        then
         FindDlls(Path+sr.Name+'\',
                 ListOfFiles)
        else
         if System.Pos('.dll',sr.Name)>0
          then
           begin
            i:=ListOfFiles.IndexOf(Path+sr.Name);
            if i=-1
             then ListOfFiles.Add(Path+sr.Name);
          end;
       until SysUtils.FindNext(sr)<>0;
  SysUtils.FindClose(sr);
 finally;
 end;
end;

function TMainForm.LoadKRLDlls(var List:TStringList;var Index:Integer):Integer;
var
 i,j  : Integer;
 tmTs : TStringList;
begin
 try
 //load dll
 List.Clear;

  tmTs:=TStringList.Create;
  FindDlls(ExtractFileDir(Application.ExeName)+'\Dll\',tmTs);

 for i:=0 to tmTs.Count-1 do
  begin
   ModuleID:=Windows.LoadLibrary(PChar(tmTs.Strings[i]));
   self.InternalGetMethodEntryPoint(ModuleID,'GetKnowledgeBaseInfo',EntryPoint);
   if System.Assigned(EntryPoint) then
    begin
     self.InternalGetMethodEntryPoint(ModuleID,'DllInfoV2',EntryPoint);
     if System.Assigned(EntryPoint) then
      List.Add(tmTs.Strings[i]+'='
       +CallFunction(tmTs.Strings[i],'DllInfoV2'));
    end;
  end;

  //сортировка по алфавиту
  for i:=0 to List.Count-1 do
  for j:=0 to List.Count-2 do
//   if tmTs.Names[j]>tmTs.Names[j+1] then
   if List.ValueFromIndex[j]>List.ValueFromIndex[j+1] then
    List.Exchange(j,j+1);

  Result:=ReloadMenuItems(List,MainMenu.Items.Items[2].Items[1]);

 except
  Result:=-1;
 end;
end;

function TMainForm.CreateProgressPanel:TPanel;
var
 Panel:TPanel;
// tH : THandle;
 tPB  : TProgressBar;
begin
 try

   Panel:=TPanel.Create(nil);

   Panel.Parent:=Self;
   Panel.Top:=250;
   Panel.Left:=270;
   Panel.Width:=250;
   Panel.Height:=15;
   Panel.BorderWidth:=1;
   Panel.BevelOuter:=bvRaised;

   tPB:=TProgressBar.Create(Panel);
   tPB.Parent:=Panel;
   tPB.Align:=alClient;
   Result:=Panel;
  except
//   ShowMessage(SIClass.LoadSingleString('e_60','./Lang/msgs_01.lan')+Name);
   Result:=nil;
  end;
end;

procedure TMainForm.Importdata1Click(Sender: TObject);
var
// K : TKnowledgeBase;
 tmTs : TStringList;
 i : Integer;
begin
 Application.CreateForm(TImportDataForCasesForm, ImportDataForCasesForm);
// addKB.Tag:=2;
 ImportDataForCasesForm.ShowModal;
end;

Function TMainForm.IndexOfKBbyID(L:TList;ID1:string):Integer;
var
 i  : Integer;
begin
try
 Result:=-1;
 for i:=0 to L.Count-1 do
  if TKnowledgeBase(L.Items[i]).ID=ID1 then
   begin
    Result:=i;
    Break;
   end;
except
 Result:=-1;
end
end;

Function TMainForm.IndexOfKBbyName(L:TList;ID1:string):Integer;
var
 i  : Integer;
begin
try
 Result:=-1;
 for i:=0 to L.Count-1 do
  if TKnowledgeBase(L.Items[i]).Name=ID1 then
   begin
    Result:=i;
    Break;
   end;
except
 Result:=-1;
end
end;

Function TMainForm.ReloadHelpMessage(WC:TWinControl;HM_id:Integer):Integer;
var
// i  : Integer;
 tHM  : THelpMessage;
 T  : Integer;
begin
 tHM:=THelpMessage.Create;
if WC.Tag<>HM_id then
begin
 tHM:=GetHelpMessages(HelpMessages,HM_id);
 STDIClass.ReleaseObjects(WC);
 if tHM<>nil then
  begin
   WC.Tag:=tHM.ID;
   if WC is TRzPanel then
    TRzPanel(WC).Caption:='';
   T:=STDIClass.AddLabel(WC,tHM.Title,10,10,WC.Width-15,clNavy,clNone,[fsBold]);
   T:=STDIClass.AddLabel(WC,tHM.Body,T,10,WC.Width-15,clBlack,clNone,[]);
  end
 else
  if WC is TRzPanel then
   TRzPanel(WC).Caption:=LS('The Help message is missed');
end;
end;

Function TMainForm.GetHelpMessages(HML:TList;HM_Id:Integer):THelpMessage;
var
 i  : Integer;
begin
 Result:=nil;
 for i:=0 to HML.Count-1 do
  if THelpMessage(HML.Items[i]).ID=HM_Id then
   begin
    Result:=THelpMessage(HML.Items[i]);
    Break;
   end;
end;

Function TMainForm.LoadHelpMessages(HML:TList; HMF:String):Integer;
var
 i,j  : Integer;
 tmTs : TStringList;
 tmH  : THelpMessage;
begin
 try
  HML.Clear;
  tmTs:=TStringList.Create;
  SEClass.Load(tmTs,HMF,Application.Title);

  j:=0;
  for i:=0 to tmTs.Count-1 do
   begin
    case j of
     0:begin
      tmH:=THelpMessage.Create;
      tmH.ID:=StrToInt(tmTs.Strings[i]);
      Inc(j);
     end;
     1:begin
      tmH.Title:=tmTs.Strings[i];
      Inc(j);
     end;
     2:begin
      tmH.Body:=tmTs.Strings[i];
      HML.Add(tmH);
      j:=0;
     end;
    end;  //end case
   end;
  Result:=0;
 except
  Result:=-1;
 end;
end;

procedure TMainForm.LinkSClick(Sender: TObject);
begin
try
 TreeView1.Select(TreeView1.Selected.Item[TLabel(Sender).Tag],[]);
 TreeView1Click(TreeView1.Selected);
except
end;
end;

Function TMainForm.ReloadKBNames(TN:TTreeNode;KB:TKnowledgeBase):Integer;
var
 i,j  : Integer;
begin
 TKnowledgeBase(TN.Data).Kind:=KB.Kind;
 TKnowledgeBase(TN.Data).Name:=KB.Name;
 for i:=0 to KB.Templates.Count-1 do
  begin
   TN.Item[0].Item[i].Text:='['+TTemplate(KB.Templates.Items[i]).ID+'] '+
    TTemplate(KB.Templates.Items[i]).Name;
   for j:=0 to TTemplate(KB.Templates.Items[i]).Slots.Count-1 do
    TN.Item[0].Item[i].Item[j].Text:=
     TSlot(TTemplate(KB.Templates.Items[i]).Slots.Items[j]).Name;
  end;
 for i:=0 to KB.Rules.Count-1 do
  begin
   TN.Item[1].Item[i].Text:='['+TRule(KB.Rules.Items[i]).ID+'] '+
    TRule(KB.Rules.Items[i]).Name;
   for j:=0 to TRule(KB.Rules.Items[i]).Conditions.Count-1 do
    begin
     TN.Item[1].Item[i].Item[0].Item[j].Text:=
      TCondition(TRule(KB.Rules.Items[i]).Conditions.Items[j]).GetOperator+' '+
       TCondition(TRule(KB.Rules.Items[i]).Conditions.Items[j]).Fact.Name
    end;
   for j:=0 to TRule(KB.Rules.Items[i]).Actions.Count-1 do
    begin
     TN.Item[1].Item[i].Item[1].Item[j].Text:=
      TRAction(TRule(KB.Rules.Items[i]).Actions.Items[j]).GetOperator+' '+
       TRAction(TRule(KB.Rules.Items[i]).Actions.Items[j]).Fact.Name
    end;
  end;
 for i:=0 to KB.Facts.Count-1 do
  begin
   TN.Item[2].Item[i].Text:='['+TFact(KB.Facts.Items[i]).ID+'] '+
    TFact(KB.Facts.Items[i]).Name;
   for j:=0 to TFact(KB.Facts.Items[i]).Slots.Count-1 do
    TN.Item[0].Item[i].Item[j].Text:=
     TSlot(TFact(KB.Facts.Items[i]).Slots.Items[j]).Name;
  end;
end;

Function TMainForm.LoadCDic(DL:TList;SDL:TStringList;nv:Integer):String;
var
 i,c,j  : Integer;
 tmTs : TStringList;
begin
 tmTs:=TStringList.Create;
 for i:=0 to SDL.Count-1 do
  begin
   c:=-1;
   for j:=0 to DL.Count-1 do
    if SDL.Names[i]=
     TCDictionary(DL.Items[j]).Name then
      begin
       if nv=0 then
        for c:=0 to TCDictionary(DL.Items[j]).Names.Count-1 do
         if tmTs.IndexOf(TCDictionary(DL.Items[j]).Names.Strings[c])=-1 then
          tmTs.Add(AnsiLowerCase(Trim(TCDictionary(DL.Items[j]).Names.Strings[c])));
       if nv=1 then
        for c:=0 to TCDictionary(DL.Items[j]).Values.Count-1 do
         if tmTs.IndexOf(TCDictionary(DL.Items[j]).Values.Strings[c])=-1 then
          tmTs.Add(AnsiLowerCase(Trim(TCDictionary(DL.Items[j]).Values.Strings[c])));
   end;
  end;
 Result:=tmTs.Text;
end;

function TMainForm.PutChildCount(pN:TTreeNode):String;
var
 c  : Integer;
 tmTs,tmTs1 : TStringList;
 tmKB : TKnowledgeBase;
begin
if pN.Data=nil then  //only for main packages
begin
 tmTs:=TStringList.Create;
 tmTs1:=TStringList.Create;
 tmTs.Text:=StringReplace(pN.Text,'[','['+#$D#$A,[rfReplaceAll]);

 if ((pos('екты',pN.Text)>0)or(pos('азы',pN.Text)>0)
  or(pos('jects',pN.Text)>0)) then c:=KBList.Count
  else
   begin
     tmKB:=GetKBForNode(pN);
     c:=0;

     if (pos('перем',pN.Text)>0) then c:=tmKB.Vars.Count;

     if (pos(
      STDIClass.LoadSingleString('Templates',LangLocaleDir+LangPrefix+'012.lan')
       ,pN.Text)>0) then c:=tmKB.Templates.Count;

     if (pos('прецедентов',pN.Text)>0) then c:=tmKB.Templates.Count;

     if (pos(
      STDIClass.LoadSingleString('Rules',LangLocaleDir+LangPrefix+'012.lan')
       ,pN.Text)>0) then c:=tmKB.Rules.Count;
     if (pos(
      STDIClass.LoadSingleString('acts',LangLocaleDir+LangPrefix+'012.lan')
       ,pN.Text)>0) then c:=tmKB.Facts.Count;

     if (pos('Функ',pN.Text)>0) then c:=tmKB.Functions.Count;

     if (pos(
      STDIClass.LoadSingleString('Task',LangLocaleDir+LangPrefix+'012.lan')
       ,pN.Text)>0) then c:=tmKB.Tasks.Count;
     if (pos(
      STDIClass.LoadSingleString('Case',LangLocaleDir+LangPrefix+'012.lan')
       ,pN.Text)>0) then c:=tmKB.Facts.Count;
     if (pos(
      STDIClass.LoadSingleString('General',LangLocaleDir+LangPrefix+'012.lan')
       ,pN.Text)>0) then c:=tmKB.GRules.Count;
  end;

 Result:=tmTs.Strings[0]+
  IntToStr(c)+']';
end;
end;

procedure TMainForm.Help2Click(Sender: TObject);
var
 s : string;
begin
 s:=ExtractFileDir(Application.ExeName)+
      '\Help\'+LangPrefix+'PKBD_User_manual.pdf';
 if FileExists(s) then
    ShellExecute(Handle, 'open',
     PWideChar(s), nil, nil, SW_SHOWNORMAL)
    else
     ShellExecute(Handle, 'open',
      PWideChar(ExtractFileDir(Application.ExeName)+
       '\Help\ru\PKBD_User_manual.pdf'), nil, nil, SW_SHOWNORMAL)
end;

procedure TMainForm.HelpAbout1Execute(Sender: TObject);
begin
 Application.CreateForm(TAboutBox, AboutBox);
 AboutBox.ShowModal;
 AboutBox.Free;
end;

procedure TMainForm.FileExit1Execute(Sender: TObject);
begin
  Close;
end;

procedure TMainForm.N8Click(Sender: TObject);
begin
 UserMode:=0;
 ApplyPolicy(UserMode);
 TreeView1Click(TreeView1);
end;

procedure TMainForm.N9Click(Sender: TObject);
begin
 UserMode:=1;
 ApplyPolicy(UserMode);
 TreeView1Click(TreeView1);
end;

procedure TMainForm.N41Click(Sender: TObject);
begin
 ToolButton18Click(ToolButton18);
end;

procedure TMainForm.N4Click(Sender: TObject);
begin
 NewRClick(Self);
end;

procedure TMainForm.N5Click(Sender: TObject);
begin
 NewTClick(Self);
end;
                                                                                        
procedure TMainForm.N6Click(Sender: TObject);
begin
 NewFClick(Self);
end;

procedure TMainForm.N7Click(Sender: TObject);
begin
 Application.CreateForm(TaddKB, addKB);
 addKB.Tag:=2;
 addKB.ShowModal;
end;

//---------------Сохранение--------------------
procedure TMainForm.N11Click(Sender: TObject);
begin
 if (TreeView1.Selected=nil)or(TreeView1.Selected.Level<1) then
  MMessageBox(1,0,'0='+
   STDIClass.LoadSingleString('Please, select the knowledge base for saving',
    LangLocaleDir+LangPrefix+'012.lan')
   )
  else
   begin
     Application.CreateForm(TExp, Exp);
     Exp.KB:=nil;
     Exp.Tag:=2;
     Exp.ShowModal;
   end;
end;

procedure TMainForm.N12Click(Sender: TObject);
begin
 OpenDialog1.Title:=Application.Title+': '+
  STDIClass.LoadSingleString('Open',LangLocaleDir+LangPrefix+'012.lan');
 OpenDialog1.Filter:='EKB files |*.ekb|'+
  STDIClass.LoadSingleString('All',LangLocaleDir+LangPrefix+'012.lan')
  +'|*.*';
 OpenDialog1.InitialDir:=ExtractFileDir(Application.ExeName)+'.\Data';
 if  OpenDialog1.Execute then
  if OpenDialog1.FileName<>'' then
   begin
    if XmlDow.parXML(OpenDialog1.FileName,tmKB)=0 then
     begin
      Application.CreateForm(TExp, Exp);

      Exp.KB:=tmKb;
      Exp.Tag:=1;
      Exp.ShowModal;
     end;
    end;
end;

procedure TMainForm.N13Click(Sender: TObject);
var
  ext : String;
begin
 OpenDialog1.Title:=Application.Title+': '+
    STDIClass.LoadSingleString('Import',LangLocaleDir+LangPrefix+'012.lan');

 if (DllIndex<>-1)and(DllList.Count>0) then
   begin
    if pos('CLIPS',DllList.ValueFromIndex[DllIndex])<>0 then
     ext:='.clp' else ext:='.*';
 OpenDialog1.Filter:=DllList.ValueFromIndex[DllIndex]+' files |'
   +'*'+ext+'|'
   +STDIClass.LoadSingleString('All',LangLocaleDir+LangPrefix+'012.lan')
   +'|*.*';
 OpenDialog1.InitialDir:=ExtractFileDir(Application.ExeName)+'.\Data';

 if OpenDialog1.Execute then
  if OpenDialog1.FileName<>'' then
   begin
    tmKb.LoadFromFileAs(DllList.Names[DllIndex],OpenDialog1.FileName);

     Application.CreateForm(TExp, Exp);

     Exp.KB:=tmKb;
     Exp.Tag:=3;
     Exp.ShowModal;
   end
 end  
   else
    begin
     MMessageBox(1,0,'0='+
      STDIClass.LoadSingleString('Programming languages support modules are missing',LangLocaleDir+LangPrefix+'012.lan')
       );
    end;
end;

procedure TMainForm.N14Click(Sender: TObject);
begin
 //    Application.CreateForm(TExp, Exp);

 //    Exp.KB:=nil;
 //    Exp.Tag:=4;
 //    Exp.ShowModal;
end;

procedure TMainForm.N15Click(Sender: TObject);
begin
 Application.CreateForm(TDicForm, DicForm);
 DicForm.ShowModal;
end;

procedure TMainForm.FormClose(Sender: TObject; var Action: TCloseAction);
var
 i : Integer;
 s : string;
 K : TKnowledgeBase;
 tmTs : TStringList;
begin
 for i := TreeView1.Items[0].Count-1 downto 0 do
  begin
   TreeView1.Selected:=TreeView1.Items[0].Item[i];
   if MMessageBox(1,1,'0='+
    STDIClass.LoadSingleString('Save the knowledge base',LangLocaleDir+LangPrefix+'012.lan')
    +': '+
    TKnowledgeBase(TreeView1.Selected.Data).Name
     +'?')=0
    then
    begin
     K:=GetKBForNode(TreeView1.Selected);
     if (K<>nil) then
      begin
       if K.FileName='' then
        begin
         SaveDialog1.Title:=Application.Title+': '+
          STDIClass.LoadSingleString('Save',LangLocaleDir+LangPrefix+'012.lan');
         SaveDialog1.Filter:='EKB files |*.ekb|'
          +STDIClass.LoadSingleString('All',LangLocaleDir+LangPrefix+'012.lan')
          +'|*.*';
         SaveDialog1.InitialDir:=ExtractFileDir(Application.ExeName)+'.\Data';
         SaveDialog1.FileName:='';

        if SaveDialog1.Execute() then
         if (SaveDialog1.FileName<>'') then
         begin
          if pos('.ekb',SaveDialog1.FileName)=0 then
           SaveDialog1.FileName:=SaveDialog1.FileName+'.ekb';
          K.FileName:=
           SaveDialog1.FileName;
          XmlSave.GXMLStrSF(K.FileName,K);
         end;
        end
       else
        begin
         if Self.Tag=1 then //es mode
          begin
           if pos('CLIPS',pName)>0 then
            begin
             tmTs:=TStringList.Create;
              tmTs.Text:=KB.
               GetDescriptionOnKBLanguage(
                ExtractFileDir(Application.ExeName)+'\Dll\cs.dll'
                 );
              try
               TTask(TreeView1.Items.Item[0].Item[0].Item[4].Item[0]).
                SaveMetaInfotoFile(tmTs);
              except
              end;

              tmTs.SaveToFile(K.FileName);
            end
           else
            if pos('PKBD',pName)>0 then
             begin
              XmlSave.GXMLStrSF(K.FileName,K);
             end;
          end
         else
          XmlSave.GXMLStrSF(K.FileName,K);
        end;
      end;
    end;
  end;

 tmTs:=TStringList.Create;
 tmTs.Add('lang='+Copy(LangPrefix,1,2));
 if Self.Tag=1 then s:='es';
 tmTs.Add('mode='+s);

 tmTs.SaveToFile(
  ExtractFileDir(Application.ExeName)+'/Config/pkbd.cfg'
   );
 Application.Terminate;
end;

function TH_REPORT(p: pointer):integer;
type
  TMethod = Function (KB1: TObject; Vis:Boolean; FileName : WideString):WideString; stdcall;
var
//  tmTs  : TStringList;
  s : WideString;
  LMethod:TMethod;
  i: integer;
begin
 try

    s:=ExtractFileDir(Application.ExeName)+'/Dll/005.dll';
    i:=LoadLibrary(PChar(s));
    if i<>0 then
     begin
      LMethod:=Windows.GetProcAddress(i,PChar('CreateReportV3'));
      if Assigned(LMethod)then
       begin
        RepFileName:=ExtractFileDir(Application.ExeName)+'/Reports/'+
         IntToStr(MilliSecondOfTheYear(Now))+'.doc';
        CoInitialize(nil);
        LMethod(MainForm.GetKBForNode(MainForm.TreeView1.Selected),False,
         RepFileName);
       end;
     end;
 except
 end;
 ExitThread(0);
end;

function TH_REG(p: pointer):integer;
//----------------------------------------------------------
function Load_KBDS_kbList(s:string):Integer;
var
 i : Integer;
 tmTs,tmTs1 : TStringList;
 s1 : string;
 tmKDBS_kb : TKBDS_kb;
begin
 KBDS_kbList.Clear;
 if s<>'false' then
  begin
   tmTs:=TStringList.Create;
   tmTs1:=TStringList.Create;
   tmTs.Delimiter:='~';
   tmTs1.Delimiter:=';';
   tmTs.DelimitedText:=StringReplace(Trim(s),' ','++',[rfReplaceAll]);

   for i := 0 to tmTs.Count-1 do
    begin
     tmTs1.Clear;
     tmTs1.DelimitedText:=tmTs.Strings[i];
     if Trim(tmTs.Strings[i])<>'' then
      begin
       tmKDBS_kb:=TKBDS_kb.Create;
       tmKDBS_kb.ID:=tmTs1.Values['id'];
       tmKDBS_kb.Name:=StringReplace(tmTs1.Values['name'],'++',' ',[rfReplaceAll]);
       tmKDBS_kb.Description:=StringReplace(tmTs1.Values['description'],'++',' ',[rfReplaceAll]);
       tmKDBS_kb.author:=StringReplace(tmTs1.Values['author'],'++',' ',[rfReplaceAll]);
       tmKDBS_kb.subject_domain:=StringReplace(tmTs1.Values['subject_domain'],'++',' ',[rfReplaceAll]);
       s1:=tmTs1.Values['type'];
       IF S1<>'' THEN tmKDBS_kb.kbType:=StrToInt(s1);
       s1:=tmTs1.Values['status'];
       IF S1<>'' THEN tmKDBS_kb.kbStatus:=StrToInt(s1);
       KBDS_kbList.AddObject(tmKDBS_kb.Name,tmKDBS_kb);
      end;
    end;
  end;
 Result:=KBDS_kbList.Count;
 tmTs.Free;
 tmTs1.Free;
end;
//----------------------------------------------------------
function Load_KBDS_mList(s:string):Integer;
var
 i : Integer;
 tmTs,tmTs1 : TStringList;
 s1 : string;
 tmKDBS_module : TKBDS_module;
begin
 KBDS_mList.Clear;
 if s<>'false' then
  begin
   tmTs:=TStringList.Create;
   tmTs1:=TStringList.Create;
   tmTs.Delimiter:='~';
   tmTs1.Delimiter:=';';
   tmTs.DelimitedText:=StringReplace(Trim(s),' ','++',[rfReplaceAll]);

   for i := 0 to tmTs.Count-1 do
    begin
     tmTs1.Clear;
     tmTs1.DelimitedText:=tmTs.Strings[i];
     if Trim(tmTs.Strings[i])<>'' then
      begin
       tmKDBS_module:=TKBDS_module.Create;
       tmKDBS_module.ID:=tmTs1.Values['id'];
       tmKDBS_module.Name:=StringReplace(tmTs1.Values['name'],'++',' ',[rfReplaceAll]);
       tmKDBS_module.Description:=StringReplace(tmTs1.Values['description'],'++',' ',[rfReplaceAll]);
       s1:=tmTs1.Values['type'];
       if s1<>'' then tmKDBS_module.mType:=StrToInt(s1);
       s1:=tmTs1.Values['status'];
       if s1<>'' then tmKDBS_module.mStatus:=StrToInt(s1);
       KBDS_mList.AddObject(tmKDBS_module.Name,tmKDBS_module);
      end;
    end;
  end;
 Result:=KBDS_mList.Count;
 tmTs.Free;
 tmTs1.Free;
end;
//----------------------------------------------------------
type
  TMethod = function (ProxyParams,InStr,URL:WideString):WideString; stdcall;
var
  tmTs,tmTs1  : TStringList;
  s : WideString;
  ModuleID   : Cardinal;
  EntryPoint : Pointer;
  LMethod:TMethod;
begin
 tmTs1:=TStringList.Create;
  if FileExists(ExtractFileDir(Application.ExeName)+'/Config/user.lic') then
    tmTs1.LoadFromFile(
     ExtractFileDir(Application.ExeName)+'/Config/user.lic'
      );
 s:=tmTs1.Values['name'];
 if s='' then s:='Resercher';

 tmTs:=TStringList.Create;
 tmTs.Clear;
 tmTs.Add('hid='+SSClass.GetCN);
 tmTs.Add('login='+s);
// tmTs.Add('passwd=');

   tmTs.Add('ver='+Ver);
    //-------------------------------------------------------------------------
    ModuleID:=Windows.LoadLibrary(PChar(
     ExtractFileDir(Application.ExeName)+'\Dll\001.dll'
    ));

    STDIClass.InternalGetMethodEntryPoint(ModuleID,'SendRequest',EntryPoint);
     if System.Assigned(EntryPoint) then
      try
        LMethod:=Windows.GetProcAddress(ModuleID,
         PChar('SendRequest'));
        if Assigned(LMethod)then
         begin
//          s:=LMethod(CurSession.GetProxyAsString,tmTs.Text,
          s:=Trim(LMethod('',tmTs.Text,
           'http://www.knowledge-core.ru/cgi-bin/pkbd/pkbd_reg.php'));
         end;
      except
      end;
    //-------------------------------------------------------------------------

  if s<>'' then
   begin
    tmTs.Delimiter:=':';
    tmTs.DelimitedText:=s;
    if tmTs.Count>2 then
     begin
//      CurSession.Login:=tmTs.Strings[0];
//      CurSession.Pswd:=tmTs.Strings[1];
     end;
   end
  else
   begin
    F1:=-1;
//    CurSession.Login:='N/A';
   end;
// if CurSession.CurrentTask.Count>0 then
//  CurSession.CurrentTask.ValueFromIndex[0]:='1';

 //check connection to KBDS
 //-----------------------------------------------------------
    tmTs.Clear;
//    tmTs.Add('dump=');
    //-------------------------------------------------------------------------
    s:='';
    ModuleID:=Windows.LoadLibrary(PChar(
     ExtractFileDir(Application.ExeName)+'\Dll\001.dll'
    ));

    STDIClass.InternalGetMethodEntryPoint(ModuleID,'SendRequestForGet',EntryPoint);
     if System.Assigned(EntryPoint) then
      try
        LMethod:=Windows.GetProcAddress(ModuleID,
         PChar('SendRequestForGet'));
        if Assigned(LMethod)then
         begin
//          s:=LMethod(CurSession.GetProxyAsString,tmTs.Text,
         s:=UTF8ToWideString(
                                              Trim(LMethod('',tmTs.Text,
           'http://'+KBDS_server_url+'/api/get-all-modules-list'))
          ) ;
         end;
      except
      end;
    //-------------------------------------------------------------------------
    if s<>'' then
     begin
      tmTs.Text:=s;
      tmTs.SaveToFile(ExtractFileDir(Application.ExeName)+'/Config/KBDS_request.log');
      Load_KBDS_mList(s);
//      MainForm.LoadKBDSMenuItems;
     end;
 //-----------------------------------------------------------
 //-----------------------------------------------------------
    tmTs.Clear;
//    tmTs.Add('dump=');
    //-------------------------------------------------------------------------
    s:='';
    ModuleID:=Windows.LoadLibrary(PChar(
     ExtractFileDir(Application.ExeName)+'\Dll\001.dll'
    ));

    STDIClass.InternalGetMethodEntryPoint(ModuleID,'SendRequestForGet',EntryPoint);
     if System.Assigned(EntryPoint) then
      try
        LMethod:=Windows.GetProcAddress(ModuleID,
         PChar('SendRequestForGet'));
        if Assigned(LMethod)then
         begin
//          s:=LMethod(CurSession.GetProxyAsString,tmTs.Text,
         s:=UTF8ToWideString(
                                              Trim(LMethod('',tmTs.Text,
           'http://'+KBDS_server_url+'/api/get-all-knowledge-bases-list'))
          ) ;
         end;
      except
      end;
    //-------------------------------------------------------------------------
    if s<>'' then
     begin
      tmTs.Text:=s;
      tmTs.SaveToFile(ExtractFileDir(Application.ExeName)+'/Config/KBDS_request.log');
      Load_KBDS_kbList(s);
//      MainForm.LoadKBDSMenuItems;
     end;
 //-----------------------------------------------------------

 MainForm.LoadKBDSMenuItems;

 tmTs.Free;
 tmTs1.Free;
 ExitThread(0);
end;
//--------------------------------------------------------------------------
procedure TMainForm.AddToRecentFiles(FileName:String);
var
 tmTs : TStringList;
 i : Integer;
begin
 tmTs:=TStringList.Create;
 if FileExists(ExtractFileDir(Application.ExeName)+'/Config/recent.log') then
  tmTs.LoadFromFile(ExtractFileDir(Application.ExeName)+'/Config/recent.log');
 i:=tmTs.IndexOf(FileName);
 if i<>-1 then tmTs.Delete(i);
 tmTs.Insert(0,FileName);
 tmTs.SaveToFile(ExtractFileDir(Application.ExeName)+'/Config/recent.log');
 LoadRecentMenuItems;
end;
//--------------------------------------------------------------------------
procedure TMainForm.KBDSkbMenuItemClick(Sender: TObject);
type
  TMethod = function (ProxyParams,InStr,URL:WideString):WideString; stdcall;
var
 s : WideString;
 ModuleID   : Cardinal;
 EntryPoint : Pointer;
 LMethod:TMethod;

 tmTs : TStringList;

// tmKB1 : TKnowledgeBase;
// KBDS_KBID : string;
begin
  if MMessageBox(1,1,'0='+
   'Load the remote knowledge base'
//    LS('Run the expert system')+' ('+
//     TMenuItem(Sender).Caption+')'
     +'?')=0  then
    begin
     //export kb to clips romote
     tmTs:=TStringList.Create;
      //-------------------------------------------------------------------------
      ModuleID:=Windows.LoadLibrary(PChar(
       ExtractFileDir(Application.ExeName)+'\Dll\001.dll'
      ));

      STDIClass.InternalGetMethodEntryPoint(ModuleID,'SendRequestForGet',EntryPoint);
       if System.Assigned(EntryPoint) then
        try
          LMethod:=Windows.GetProcAddress(ModuleID,
           PChar('SendRequestForGet'));
          if Assigned(LMethod)then
           begin
  //          s:=LMethod(CurSession.GetProxyAsString,tmTs.Text,

            s:=Trim(LMethod('',tmTs.Text,
             'http://'+KBDS_server_url+'/api/export-knowledge-base/'+
              IntToStr(TKBDS_kb(KBDS_kbList.Objects[TMenuItem(Sender).Tag]).kbType)));
           end;
        except
        end;
      //-------------------------------------------------------------------------
      if s<>'' then
       begin
     //save clips localy
        tmTs.Text:=Utf8ToAnsi(s);
        tmTs.SaveToFile(ExtractFileDir(Application.ExeName)+'/Config/KBDS_request.log');
       end;
     //-----------------------------------------------------------
     //load from clips localy
     tmKb.Init;
     tmKb.LoadFromFileAs(DllList.Names[DllIndex],
      ExtractFileDir(Application.ExeName)+'/Config/KBDS_request.log'
       );

     //show import form
     Application.CreateForm(TExp, Exp);
     Exp.KB:=tmKb;
     Exp.Tag:=3;
     Exp.ShowModal;
 end;
end;

//--------------------------------------------------------------------------
procedure TMainForm.RecentFileMenuItemClick(Sender: TObject);
var
 tmKB1 : TKnowledgeBase;
begin
  if TMenuItem(Sender).Caption<>'' then
   begin
    tmKB1:=TKnowledgeBase.Create;
    tmKB1.Init;
    tmKB1.FileName:=StringReplace(TMenuItem(Sender).Caption,'&','',[rfReplaceAll]);

//    if tmKB1.FileName[1]='&' then
//     Delete(tmKB1.FileName,1,1);

//    tmKB1.ID:=GetKBID(KBList);
    if XmlDow.parXML(tmKB1.FileName,tmKB1)=0 then
     begin
      AddToRecentFiles(tmKB1.FileName);

      MainForm.MakeDump(
       STDIClass.LoadSingleString('Open: knowledge base',LangLocaleDir+LangPrefix+'012.lan')
        ,7);
      MainForm.LoadAList(MainForm.RzListView1);

      //check ID
      if IndexOfKBbyID(KBList,tmKB1.ID)<>-1 then
       begin //kb is opened
         MainForm.MMessageBox(1,0,'0='+
          STDIClass.LoadSingleString('The knowledge base is already open',LangLocaleDir+LangPrefix+'012.lan')
          );
       end
      else
       begin //kb is not opened
        //check name
        if IndexOfKBbyName(KBList,tmKB1.Name)<>-1 then
         begin //the similar kb is opened
          if MMessageBox(1,1,'0='+
           STDIClass.LoadSingleString('The Knowledge base with the same name is already open. Still open?',LangLocaleDir+LangPrefix+'012.lan')
           )=0
           then
            begin
              KBList.Add(tmKB1);
              MainForm.LoadTree(KBList,MainForm.TreeView1);
            end;
         end
        else
         begin
          KBList.Add(tmKB1);
          MainForm.LoadTree(KBList,MainForm.TreeView1);
         end;
       end;
     end;
   end;
end;

procedure TMainForm.FormCreate(Sender: TObject);
procedure CDicLoad;
var
 FileAttrs: Integer;
 sr: TSearchRec;
 tmDic  : TCDictionary;
 i  : Integer;
begin
 try
  FileAttrs:=faAnyFile;
  if SysUtils.FindFirst(SysUtils.GetCurrentDir+'\Dic\*.*',
   FileAttrs,sr) = 0 then
    repeat
     if System.Pos('.dic',sr.Name)>0 then
      begin
       tmDic:=TCDictionary.Create;
       tmDic.Init;
       tmDic.Load(SysUtils.GetCurrentDir+'\Dic\'+sr.Name);
       CDicList.Add(tmDic);
      end;
    until SysUtils.FindNext(sr)<>0;
  SysUtils.FindClose(sr);
  SelectedCDic.Clear;
  for i:=0 to CDicList.Count-1 do
   SelectedCDic.Add(TCDictionary(CDicList.Items[i]).Name+'='+IntToStr(i));
 finally;
 end;
end;

function LoadDllVersions:Integer;
type
  TMethod = function:WideString ;stdcall;
 var
  i,j : Integer;
  LMethod:TMethod;
begin
 //
 for i := 0 to DllListForAbout.Count-1 do
  if Pos('dll',DllListForAbout.ValueFromIndex[i])>0 then
   try
    j:=LoadLibrary(PChar(ExtractFileDir(Application.ExeName)+'/Dll/'+
     DllListForAbout.ValueFromIndex[i]));
    if j<>0 then
     begin
      LMethod:=Windows.GetProcAddress(j,PChar('DllInfo'));
      if Assigned(LMethod)then
       DllListForAbout.ValueFromIndex[i]:=LMethod;
     end;
   except
   end;
end;

//type
//  TMethod = function (ProxyParams,InStr,URL:WideString):WideString; stdcall;
var
 tmTs : TStringList;
// ModuleID   : Cardinal;
// EntryPoint : Pointer;
// LMethod:TMethod;

// c,cc  : String;
 i  : Integer;
// SerialNumber : string;
// f  : TStringList;

// tmMI : TMenuItem;
begin
// Ver:='3.2015.1015.3 ';
 Ver:='4.2018.0201.6 ';
 RzListView1.Clear;
 RzSplitter3.Percent:=100;
 RzSplitter3.PercentMin:=100;
 //!!!!
 LangLocaleDir:=ExtractFileDir(Application.ExeName)+'/Lang/';


 tmPSO:=nil; //label for drag and drop
 //language
 LangPrefix:='en/';
 tmTs:=TStringList.Create;
 try
  if FileExists(ExtractFileDir(Application.ExeName)+'/Config/pkbd.cfg') then
    tmTs.LoadFromFile(
     ExtractFileDir(Application.ExeName)+'/Config/pkbd.cfg'
      );
  if tmTs.Values['lang']='ru' then N36Click(N36) //ru
   else English1Click(English1);
  KBDS_mList:=TStringList.Create;
  KBDS_kbList:=TStringList.Create;

  KBDS_server_url:='';
  KBDS_server_url:=tmTs.Values['kbds_server_url'];
  //!!!!
  if KBDS_server_url='' then
   KBDS_server_url:='kbds.knowledge-core.ru';
 except
 end;
// English1Click(English1); //eng
// LangPrefix:='ru/';
// LF1:=LangLocaleDir+LangPrefix+'012.lan';

 DllListForAbout:=TStringList.Create;
 //list of modules
 DllListForAbout.Add('CLIPS Support=CS.dll');
 DllListForAbout.Add('CLIPS Inference machine=6.1');
 DllListForAbout.Add('CBR Inference machine=002.dll');
 DllListForAbout.Add('DM Support: ARAMIS=1.2014');
 DllListForAbout.Add('MDL Importer for IBM Rational Rose=2.2016');
 DllListForAbout.Add('MDL Exporter for IBM Rational Rose=1.2016 [beta]');
 DllListForAbout.Add('MDJ Importer for StarUML=1.2016');
 DllListForAbout.Add('OWL Importer for Protege=owl.i.dll');
 DllListForAbout.Add('Report Builder=005.dll');
 DllListForAbout.Add('RVML Support=3.2016');
 DllListForAbout.Add('Rule-based expert system builder=1.2016');
 DllListForAbout.Add('XMI Importer for StarUML=xmi.staruml.i.dll');
 DllListForAbout.Add('XMI Exporter for StarUML=1.2018 [beta]');
 DllListForAbout.Add('XCL Importer for CmapTools=cxl.i.dll');
 DllListForAbout.Add('XTM Exporter for CmapTools=xtm.s.dll');
 DllListForAbout.Add('XMind Importer=xmind.i.dll');
 //load versions of modules
 LoadDllVersions;

 Self.Caption:=Application.Title;

 AList:=TList.Create; //action list (history)

 DllList:=TStringList.Create;
 OLst1:=TStringList.Create;

 DllIndex:=LoadKRLDlls(DllList,DllIndex);

 Translit:=TTranslit.Create;
 Translit.Init;

 HelpMessages:=TList.Create;
// LoadHelpMessages(HelpMessages,
//  ExtractFileDir(Application.ExeName)+'/Lang/_011.lan');
 //!!!!
 LoadHelpMessages(HelpMessages,
  LangLocaleDir+LangPrefix+'011.lan');

 tmKb:=TKnowledgeBase.Create;
 tmKb.Init;
 tmKb.Name:=
  STDIClass.LoadSingleString('Knowledge base',LangLocaleDir+LangPrefix+'012.lan')
  +' '+tmKb.ID;
 tmKb.Kind:=0;
 KBList:=TList.Create;
 CDicList:=TList.Create;
 SelectedCDic:=TStringList.Create;
 CDicLoad;
{
try
 c:=SSClass.GetC03(SerialNumber);
 f:=TStringList.Create;
 f.LoadFromFile(ExtractFileDir(Application.ExeName)+'/version.lic');
 cc:=SSClass.GetData(f.Text,
  StrToInt(SerialNumber[1]+SerialNumber[2]+SerialNumber[3]+SerialNumber[4]
//   +SerialNumber[5]
   )
  ,32);
if c=cc then
 begin  }
  MainForm.Tag:=0;
{ end
else
 begin
  MainForm.Tag:=78;
//  Application.MessageBox(
//   PAnsiChar('Внимание! Система работает в режиме ознакомления.'),
//    PAnsiChar(Application.Title),MB_OK);
 end;
except
 MainForm.Tag:=456;
//  Application.MessageBox(
//   PAnsiChar('Внимание! Система работает в режиме ознакомления.'),
//    PAnsiChar(Application.Title),MB_OK);
// SSClass.AppDestruction('');
end;    }
{ Application.CreateForm(TAboutBox, AboutBox);
 AboutBox.Show;
 Application.ProcessMessages;
 Sleep(3000);

 for i:=254 downto 0 do
  begin
   AboutBox.AlphaBlendValue:=i;
//   Sleep(1);
   Application.ProcessMessages;
  end;
 AboutBox.Free;
 LoadParams;
}
 TreeView1.OnEditing:=OnEditingNode;
 Replacements:=TStringList.Create;
 try
  if FileExists(ExtractFileDir(Application.ExeName)+'/Config/replacements.cfg') then
    Replacements.LoadFromFile(
     ExtractFileDir(Application.ExeName)+'/Config/replacements.cfg'
      );
 except
 end;
 LoadRecentMenuItems;
 BeginThread(nil,1024,TH_REG,nil,0,TID1);

 if tmTs.Values['mode']='es' then
  begin  //es mode
   Self.Tag:=1;
   //------------------------------------------------------------
   for i := 0 to RzPageControl1.PageCount-2 do
    RzPageControl1.Pages[i].TabVisible:=False;

//   RzGroupBox1.Visible:=False;   //navigator
//    RzSplitter2.Visible:=False;
    RzSplitter1.PercentMin:=0;
    RzSplitter1.Percent:=00;
    ToolBar1.Visible:=False;
    ToolBar2.Visible:=False;
    RzPanel3.Visible:=False;
    MainMenu.Items.Items[0].Visible:=False;
    MainMenu.Items.Items[1].Visible:=False;
    MainMenu.Items.Items[2].Visible:=False;
    MainMenu.Items.Items[3].Visible:=False;
    MainMenu.Items.Items[4].Visible:=False;
    MainMenu.Items.Items[5].Visible:=False;

    RzPageControl1.ActivePage:=
     RzPageControl1.Pages[RzPageControl1.PageCount-1];
    RzPageControl3.ActivePage:=
     RzPageControl3.Pages[RzPageControl1.PageCount-1];

    RzPageControl1.ActivePage:=TabSheet6;
   //------------------------------------------------------------
  end
 else  //pkdb mode
  begin
   RzPageControl1.ActivePage:=TabSheet3;
   RzPageControl1.Pages[RzPageControl1.PageCount-1].TabVisible:=False;   //es tab
   if tmTs.Values['mode']='dse' then
    begin //domai-specific editor
     //disable contols
     UserMode:=0; //operator
    end
   else
    UserMode:=1; //administrator - full control

    ApplyPolicy(UserMode);
  end;

end;
//----------------------------------------------------------------------
procedure TMainForm.LoadKBDSMenuItems; //
var
// f  : TStringList;
 tmMI : TMenuItem;
 i : Integer;
begin

 //clear old kBDS modules
 Modules1.Clear;
 //clear old KBDS kbs
 KnowledgeBases1.Clear;

// for i := N13.Count-1 downto 0 do
//  if pos('KBDS',N13.Items[i].Caption)>0 then
//   N13.Delete(i);

 //load new kBDS kbs
   for i := 0 to KBDS_kbList.Count-1 do
//    if
//     (TKBDS_module(KBDS_mList.Objects[i]).mType='0')and //owl
//     (TKBDS_kb(KBDS_kbList.Objects[i]).kbStatus=0)then //open
    begin
     tmMI:=TMenuItem.Create(KnowledgeBases1);
     tmMI.Caption:=KBDS_kbList.Strings[i];
     tmMI.Tag:=i;
     tmMI.OnClick:=KBDSkbMenuItemClick;
     KnowledgeBases1.Add(tmMI);
    end;

 //load new kBDS modules
   for i := 0 to KBDS_mList.Count-1 do
    if
//     (TKBDS_module(KBDS_mList.Objects[i]).mType='0')and //owl
     (TKBDS_module(KBDS_mList.Objects[i]).mStatus=1)then //actual
    begin
     tmMI:=TMenuItem.Create(Modules1);
     tmMI.Caption:=KBDS_mList.Strings[i];
     tmMI.Tag:=i;
//     tmMI.OnClick:=KBDSMenuItemClick;
     Modules1.Add(tmMI);
    end;

    if Modules1.Count=0 then MainForm.Modules1.Enabled:=False
     else MainForm.Modules1.Enabled:=True;
    if KnowledgeBases1.Count=0 then MainForm.KnowledgeBases1.Enabled:=False
     else MainForm.KnowledgeBases1.Enabled:=True;

end;
//----------------------------------------------------------------------
procedure TMainForm.LoadRecentMenuItems;
var
 f  : TStringList;
 tmMI : TMenuItem;
 i : Integer;
begin
 if FileExists(ExtractFileDir(Application.ExeName)+'/Config/recent.log') then
  begin
   RecentFiles1.Clear;
   f:=TStringList.Create;
   f.LoadFromFile(ExtractFileDir(Application.ExeName)+'/Config/recent.log');
   for i := 0 to f.Count-1 do
    begin
     if FileExists(f.Strings[i]) then
      begin
       tmMI:=TMenuItem.Create(RecentFiles1);
       tmMI.Caption:=f.Strings[i];
       tmMI.OnClick:=RecentFileMenuItemClick;
       RecentFiles1.Add(tmMI);
      end;
    end;
  end;
 if RecentFiles1.Count>0 then RecentFiles1.Enabled:=True
  else RecentFiles1.Enabled:=False;
end;
//----------------------------------------------------------------------
procedure TMainForm.NewKBClick(Sender: TObject);
begin
{ if (MainForm.Tag=0)or
  ((MainForm.Tag<>0)and(KBList.Count<675-673)) then
 begin   }
  N7Click(Self);
//  RebulidImagesOnTree(TreeView1);
{ end
  else
    MMessageBox(1,0,'0=В режиме ознакомления можно создать только ОДНУ базу знаний.');
}
end;

procedure TMainForm.RationalRosemdl1Click(Sender: TObject);
var
  ext : String;
begin
 OpenDialog1.Title:=Application.Title+': '+
  STDIClass.LoadSingleString('Import templates and generalized rules from mdl',LangLocaleDir+LangPrefix+'012.lan')
  ;

 ext:='.mdl';
 OpenDialog1.FileName:='';
 OpenDialog1.Filter:='Rational Rose files |'
   +'*'+ext+'|'
   +STDIClass.LoadSingleString('All',LangLocaleDir+LangPrefix+'012.lan')
   +'|*.*';
 OpenDialog1.InitialDir:=ExtractFileDir(Application.ExeName)+'\Models';
 if OpenDialog1.Execute then
  if OpenDialog1.FileName<>'' then
   begin
     tmKb.LoadFromMDLFileV2(OpenDialog1.FileName);
     Application.CreateForm(TExp, Exp);

     Exp.KB:=tmKb;
     Exp.Tag:=3;
     Exp.ShowModal;
   end
end;

procedure TMainForm.RationalRosemdl2Click(Sender: TObject);
begin
 Application.CreateForm(TExp, Exp);

 Exp.KB:=nil;
 Exp.Tag:=5;
 Exp.ShowModal;
end;

Function TMainForm.RebulidImagesOnTree(Tree:TTreeView):Integer;
var
 i  : Integer;
begin

 for i:=0 to Tree.Items.Count-1 do
 begin
//  Tree.Items[i].ImageIndex:=-1;
  Tree.Items[i].ImageIndex:=17;
  if (Tree.Items[i].Level=0)or(Tree.Items[i].Level=1) then
   Tree.Items[i].ImageIndex:=1;
  if (Tree.Items[i].Level=2) then
   begin
    if (pos('перем',Tree.Items[i].Text)>0) then
     Tree.Items[i].ImageIndex:=5;

    if (pos(
     STDIClass.LoadSingleString('acts',LangLocaleDir+LangPrefix+'012.lan')
      ,Tree.Items[i].Text)>0) then
       Tree.Items[i].ImageIndex:=4;
    if (pos(
     STDIClass.LoadSingleString('Templates',LangLocaleDir+LangPrefix+'012.lan')
     ,Tree.Items[i].Text)>0) then
       Tree.Items[i].ImageIndex:=2;
    if (pos(
     'прецедентов'
      ,Tree.Items[i].Text)>0) then
       Tree.Items[i].ImageIndex:=2;
    if (pos(
     STDIClass.LoadSingleString('Rules',LangLocaleDir+LangPrefix+'012.lan')
     ,Tree.Items[i].Text)>0) then
       Tree.Items[i].ImageIndex:=3;

    if (pos('Функ',Tree.Items[i].Text)>0) then

     Tree.Items[i].ImageIndex:=10;
    if (pos(
     STDIClass.LoadSingleString('Task',LangLocaleDir+LangPrefix+'012.lan')
      ,Tree.Items[i].Text)>0) then
       Tree.Items[i].ImageIndex:=14;
    if (pos(
     STDIClass.LoadSingleString('Case',LangLocaleDir+LangPrefix+'012.lan')
      ,Tree.Items[i].Text)>0) then
       Tree.Items[i].ImageIndex:=4;
    if (pos(
     STDIClass.LoadSingleString('General',LangLocaleDir+LangPrefix+'012.lan')
      ,Tree.Items[i].Text)>0) then
       Tree.Items[i].ImageIndex:=16;
   end;
  if (Tree.Items[i].Level>=3) then
   begin
    if TObject(Tree.Items[i].Data) is TTemplate then Tree.Items[i].ImageIndex:=12;
    if TObject(Tree.Items[i].Data) is TRule then Tree.Items[i].ImageIndex:=3;
    if TObject(Tree.Items[i].Data) is TFact then Tree.Items[i].ImageIndex:=13;
    if TObject(Tree.Items[i].Data) is TGlobalVar then Tree.Items[i].ImageIndex:=9;
    if TObject(Tree.Items[i].Data) is TFunct then Tree.Items[i].ImageIndex:=11;
    if TObject(Tree.Items[i].Data) is TTask then Tree.Items[i].ImageIndex:=15;
    if TObject(Tree.Items[i].Data) is TGRule then Tree.Items[i].ImageIndex:=16;
    if TObject(Tree.Items[i].Data) is TSlot then Tree.Items[i].ImageIndex:=8;
    if (pos(
     STDIClass.LoadSingleString('Conditions',LangLocaleDir+LangPrefix+'012.lan')
      ,Tree.Items[i].Text)>0) then
       Tree.Items[i].ImageIndex:=7;
    if (pos(
     STDIClass.LoadSingleString('Actions',LangLocaleDir+LangPrefix+'012.lan')
      ,Tree.Items[i].Text)>0) then
       Tree.Items[i].ImageIndex:=6;
    if TObject(Tree.Items[i].Data) is TCondition then Tree.Items[i].ImageIndex:=7;
    if TObject(Tree.Items[i].Data) is TRAction then Tree.Items[i].ImageIndex:=6;
   end;
  end;
end;

//-----------------------------------------------------------------------------
Function TMainForm.LoadTree(tmKBList:TList; Tree:TTreeView):Integer;

var
 i  : Integer;
 tN : TTreeNode;
begin
 Tree.Items.Clear;
 tN:=Tree.Items.Add(nil,
  STDIClass.LoadSingleString('Knowledge bases (projects)',LangLocaleDir+LangPrefix+'012.lan')
  +' ['+IntToStr(tmKBList.Count)+']');
 for i:=0 to tmKBList.Count-1 do
  begin
   TKnowledgeBase(tmKBList.Items[i]).UpdateIDforGRules;
   if TKnowledgeBase(tmKBList.Items[i]).AddToTreeView(TreeView1,tN).Expanded then
    tN.Expand(False);
  end;
{ tN:=Tree.Items.Add(nil,'Словари/справочники ('+IntToStr(CDicList.Count)+')');
 for i:=0 to CDicList.Count-1 do
  begin
   TCDictionary(CDicList.Items[i]).AddToTreeView(TreeView1,tN);
  end;
}  
 RebulidImagesOnTree(TreeView1);
end;
//-----------------------------------------------------------------------------

procedure TMainForm.LabelClick_V2(Sender: TObject);
begin
 TreeView1.Selected:=TreeView1.Selected.Item[
  TLabel(Sender).Tag
   ];
 TreeView1Click(TreeView1);
end;

procedure TMainForm.TreeView1Click(Sender: TObject);
function getTForLabel(P:TRzPanel):Integer;
begin
 Result:=
  TLabel(P.Components[P.ComponentCount-1]).Top+
   TLabel(P.Components[P.ComponentCount-1]).Height+2;
end;
//----------------------------------------------------------------
label
 l67;
var
 tmWC : TWinControl;
 T,L,T1,T2,T3  : Integer;
 i,j  : Integer;
// nC : TTreeNode;
 c,x  : Integer;
 tmTs : TStringList;
 tmTs1 : TStringList;
 tmS  : String;

 K : TKnowledgeBase;
// tP : TPanel;
 tmP, tmP0, tmP1 : TRzPanel;
 s : string;
 tmRule : TRule;

 tmState : TRMState;
begin
 tmWC:=ScrollBox1;
 RzMemo1.Clear;
 //---------------- controls ----------------------
 EditItem.Enabled:=False;

 RzButton3.Enabled:=False;   //delete
 RzButton4.Enabled:=False;   //edit

 RzMenuButton1.Enabled:=False; //translit
 DeleteItem.ImageIndex:=5;
 DeleteItem.Hint:=
  STDIClass.LoadSingleString('Delete',LangLocaleDir+LangPrefix+'012.lan');
 DeleteItem.Enabled:=False;
 ToolButton11.Enabled:=False;  //pkg
 ToolButton17.Enabled:=False;  //image
 ToolButton18.Enabled:=False;  //create ES
 N41.Enabled:=False;  //create ES
// CFM1.Enabled:=False;  //create ES

   //---------------------------------------------
    ToolButton10.Enabled:=False; //rule run
    N31.Enabled:=False; //rule run

    ToolButton12.Enabled:=False; //case run
    C1.Enabled:=False; //case run

    ToolButton13.Enabled:=False; //grule
    N33.Enabled:=False; //grule

    NewR.Enabled:=False; //rule
    N4.Enabled:=False; //rule

    NewF.Enabled:=False; //fact
    N6.Enabled:=False; //fact

    NewT.Enabled:=False; //templates
    N5.Enabled:=False; //templates

    N34.Enabled:=False; //check
    RzBitBtn1.Enabled:=False; //check

    ToolButton17.Enabled:=False; //save as bmp
    ToolButton21.Enabled:=False; //order by X axis
   //---------------------------------------------

 STDIClass.ReleaseObjects(ScrollBox4);
 //------------------------------------------------
if TreeView1.Selected<>nil then
try
 tmTs:=TStringList.Create;
 tmTs1:=TStringList.Create;
 tmWC.Visible:=False;
 STDIClass.ReleaseObjects(tmWC);
 T:=5;
 L:=5;
 if CheckBox1.Checked then tmS:='0' else tmS:='1';

 if (DllIndex=-1) then
  begin
   RzPageControl1.Pages[1].Enabled:=False;
   RzPageControl1.Pages[1].Caption:=
    STDIClass.LoadSingleString('Programm code:',LangLocaleDir+LangPrefix+'012.lan');
  end
   else
    begin
     RzPageControl1.Pages[1].Enabled:=True;
     RzPageControl1.Pages[1].Caption:=
      STDIClass.LoadSingleString('Programm code:',LangLocaleDir+LangPrefix+'012.lan')+
      ' '+
      DllList.ValueFromIndex[DllIndex];
    end;
 K:=GetKBForNode(TreeView1.Selected);
   //reload controls --------------------------------------
   if K.Kind=0 then
    begin //for rule
     //-------------------------------------------
     ToolButton12.Enabled:=False; //case run
     C1.Enabled:=False; //case run
     NewT.Enabled:=True; //templates
     N5.Enabled:=True; //templates

     N34.Enabled:=True; //check
     RzBitBtn1.Enabled:=True; //check

     //rule run
     if (K.Rules.Count>0)and(K.Facts.Count>0)and(K.Templates.Count>0) then
      begin
       ToolButton10.Enabled:=True;
       N31.Enabled:=True;
      end
       else
        begin
         ToolButton10.Enabled:=False;
         N31.Enabled:=False;
        end;
      //add grule and facts
     if (K.Templates.Count>0) then
      begin
       ToolButton13.Enabled:=True;
       N33.Enabled:=True;
       NewF.Enabled:=True;
       N6.Enabled:=True;
      end
       else
        begin
         ToolButton13.Enabled:=False;
         N33.Enabled:=False;
         NewF.Enabled:=False;
         N6.Enabled:=False;
        end;
      //add rule
     if (K.GRules.Count>0) then
      begin
       NewR.Enabled:=True;
       N4.Enabled:=True;
      end
       else
        begin
         NewR.Enabled:=False;
         N4.Enabled:=False;
        end;
     //-------------------------------------------
    end
   else
    begin  //for case
     //-------------------------------------------
     ToolButton10.Enabled:=False; //rule run
     N31.Enabled:=False; //rule run

     ToolButton13.Enabled:=False; //grule
     N33.Enabled:=False; //grule

     NewR.Enabled:=False; //rule
     N4.Enabled:=False; //rule

     NewT.Enabled:=True; //templates
     N5.Enabled:=True; //templates

     //case run
     if (K.Facts.Count>0) then
      begin
       ToolButton12.Enabled:=True;
       C1.Enabled:=True;
      end
       else
        begin
         ToolButton12.Enabled:=False;
         C1.Enabled:=False;
        end;
      //add cases
     if (K.Templates.Count>0) then
      begin
       NewF.Enabled:=True;
       N6.Enabled:=True;
      end
       else
        begin
         NewF.Enabled:=False;
         N6.Enabled:=False;
        end;
     //-------------------------------------------
    end;
   //end reload controls --------------------------------------

 if TreeView1.Selected.Data<>nil then
  begin
//   K:=GetKBForNode(TreeView1.Selected);
   //-------------------------------------------------------------------------------
   //description of KB
   if TObject(TreeView1.Selected.Data) is TKnowledgeBase then
    begin
     // --- controls for KB ----------------------------
//     DeleteItem.ImageIndex:=30;
     DeleteItem.Hint:=
      STDIClass.LoadSingleString('Close',LangLocaleDir+LangPrefix+'012.lan')
       ;
     RzMenuButton1.Enabled:=True; //translit
     DeleteItem.Enabled:=True;
     EditItem.Enabled:=True;     //edit
     RzButton3.Enabled:=True;    //del
     RzButton4.Enabled:=True;    //edit
     //--------------------------------------------------

     TKnowledgeBase(TreeView1.Selected.Data).FactOrderMark(tmS);

     RzPanel5.Visible:=True;

     T:=STDIClass.AddLabel(tmWC,
      STDIClass.LoadSingleString('Knowledge base',LangLocaleDir+LangPrefix+'012.lan')+':'
       ,T,L,250,clNavy,clNone,[]);
     T:=STDIClass.AddLabel(tmWC,TKnowledgeBase(TreeView1.Selected.Data).Name
      ,T,L+10,tmWC.Width-25-10,clBlack,clNone,[fsBold]);
     T:=STDIClass.AddLabel(tmWC,
      STDIClass.LoadSingleString('Description:',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L,250,clNavy,clNone,[]);
     if TKnowledgeBase(TreeView1.Selected.Data).Description='' then
      T:=STDIClass.AddLabel(tmWC,'ID: '+TKnowledgeBase(TreeView1.Selected.Data).ID
       ,T,L+10,250,clInactiveCaption,clNone,[])
      else
       T:=STDIClass.AddLabel(tmWC,TKnowledgeBase(TreeView1.Selected.Data).Description
        ,T,L+10,tmWC.Width-25-(L+10),clBlack,clNone,[fsBold]);

     s:='';
//     case TKnowledgeBase(TreeView1.Selected.Data).Kind of
//      0: s:='фактов';
//      1: s:='прецедентов';
//     end;

     T:=STDIClass.AddLabel(tmWC,
      STDIClass.LoadSingleString('Templates1',LangLocaleDir+LangPrefix+'012.lan')
       +s+': ('+
      IntToStr(TKnowledgeBase(TreeView1.Selected.Data).Templates.Count)+')'
      ,T,L,250,clNavy,clNone,[]);
     for i:=0 to TKnowledgeBase(TreeView1.Selected.Data).Templates.Count-1 do
      begin
       STDIClass.AddLabel(tmWC,'['+
        TTemplate(TKnowledgeBase(TreeView1.Selected.Data).Templates.Items[i]).ID
         +']',T,10,30,clInactiveCaption,clNone,[fsBold]);

       T1:=STDIClass.AddLabel(tmWC,
        TTemplate(TKnowledgeBase(TreeView1.Selected.Data).Templates.Items[i]).Name
        ,T,L+10+50,150,clBlack,clNone,[fsBold]);
       T2:=STDIClass.AddLabel(tmWC,
        TTemplate(TKnowledgeBase(TreeView1.Selected.Data).Templates.Items[i]).Description
        ,T,L+10+50+160,tmWC.Width-25-(L+10+50+160),clNavy,clNone,[fsBold]);
       if T1<T2 then T1:=T2;
       T:=T1;
      end;
     if TKnowledgeBase(TreeView1.Selected.Data).Templates.Count=0 then
      T:=STDIClass.AddLabel(tmWC,
       STDIClass.LoadSingleString('no data',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L+10,250,clInactiveCaption,clNone,[]);

     case TKnowledgeBase(TreeView1.Selected.Data).Kind of
      0: s:=STDIClass.LoadSingleString('Initial facts',LangLocaleDir+LangPrefix+'012.lan');
      1: s:=STDIClass.LoadSingleString('Cases',LangLocaleDir+LangPrefix+'012.lan');
     end;

     T:=STDIClass.AddLabel(tmWC,s+': ('+
      IntToStr(TKnowledgeBase(TreeView1.Selected.Data).Facts.Count)+')'
      ,T+5,L,250,clNavy,clNone,[]);
     for i:=0 to TKnowledgeBase(TreeView1.Selected.Data).Facts.Count-1 do
      begin
       STDIClass.AddLabel(tmWC,'['+
        TFact(TKnowledgeBase(TreeView1.Selected.Data).Facts.Items[i]).ID
         +']',T,10,30,clInactiveCaption,clNone,[fsBold]);

       T:=STDIClass.AddLabel(tmWC,
        TFact(TKnowledgeBase(TreeView1.Selected.Data).Facts.Items[i]).Name
        ,T,L+10+50,tmWC.Width-25-10-50,clBlack,clNone,[fsBold]);
      end;
     if TKnowledgeBase(TreeView1.Selected.Data).Facts.Count=0 then
      T:=STDIClass.AddLabel(tmWC,
       STDIClass.LoadSingleString('no data',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L+10,250,clInactiveCaption,clNone,[]);

 {    T:=STDIClass.AddLabel(tmWC,'Правила: ('+
      IntToStr(TKnowledgeBase(TreeView1.Selected.Data).Rules.Count)+')'
      ,T+5,L,250,clNavy,clNone,[]);
     for i:=0 to TKnowledgeBase(TreeView1.Selected.Data).Rules.Count-1 do
      begin
       STDIClass.AddLabel(tmWC,'['+
        TRule(TKnowledgeBase(TreeView1.Selected.Data).Rules.Items[i]).ID
         +']',T,10,30,clInactiveCaption,clNone,[fsBold]);

       T1:=STDIClass.AddLabel(tmWC,
        TRule(TKnowledgeBase(TreeView1.Selected.Data).Rules.Items[i]).Name
        ,T,L+10+50,150,clBlack,clNone,[fsBold]);

       T1:=STDIClass.AddLabel(tmWC,
         TRule(TKnowledgeBase(TreeView1.Selected.Data).Rules.Items[i]).Description
        ,T,L+10+50+160,tmWC.Width-25-(L+10+50+160),clNavy,clNone,[fsBold]);
       if T1<T2 then T1:=T2;
       T:=T1;
      end;
     if TKnowledgeBase(TreeView1.Selected.Data).Rules.Count=0 then
      T:=STDIClass.AddLabel(tmWC,'сведений нет'
       ,T,L+10,250,clInactiveCaption,clNone,[]);

     if TKnowledgeBase(TreeView1.Selected.Data).Functions.Count>0 then
      begin
       T:=STDIClass.AddLabel(tmWC,'Функции ('+
        IntToStr(TKnowledgeBase(TreeView1.Selected.Data).Functions.Count)+')'
        ,T,L,250,clNavy,clNone,[]);
      end;
  }
    if (DllIndex<>-1)and(DllList.Count>0) then
      tmTs.Text:=TKnowledgeBase(TreeView1.Selected.Data).
       GetDescriptionOnKBLanguage(DllList.Names[DllIndex]);
    end;
   //-------------------------------------------------------------------------------
   //template description
   if TObject(TreeView1.Selected.Data) is TTemplate then
    begin
     // --- controls for template ----------------------------
//     RzMenuButton1.Enabled:=True; //translit
     if UserMode=1 then //only for adm
      begin
       DeleteItem.Enabled:=True;
       EditItem.Enabled:=True;     //edit
       RzButton3.Enabled:=True;    //del
//       RzButton4.Enabled:=True;    //edit
//       ToolButton11.Enabled:=True;   //pkg

       ToolButton17.Enabled:=True; //save as bmp
      end;
     //--------------------------------------------------

     RzPanel5.Visible:=False;

     T:=STDIClass.AddLabel(tmWC,
      STDIClass.LoadSingleString('Name:',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L,250,clNavy,clNone,[]);
     STDIClass.AddLabel(tmWC,'['+
      TTemplate(TreeView1.Selected.Data).ID
       +']',T,10,30,clInactiveCaption,clNone,[fsBold]);
     T:=STDIClass.AddLabel(tmWC,
      TTemplate(TreeView1.Selected.Data).Name
       ,T,L+10+50,tmWC.Width-25-10-50,clBlack,clNone,[fsBold]);

     T:=STDIClass.AddLabel(tmWC,
      STDIClass.LoadSingleString('Description:',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L,250,clNavy,clNone,[]);
     if TTemplate(TreeView1.Selected.Data).Description='' then
      T:=STDIClass.AddLabel(tmWC,
       STDIClass.LoadSingleString('no data',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L+10,250,clInactiveCaption,clNone,[])
      else
       T:=STDIClass.AddLabel(tmWC,TTemplate(TreeView1.Selected.Data).Description
        ,T,L+10,tmWC.Width-25-(L+10),clBlack,clNone,[fsBold]);

     T:=STDIClass.AddLabel(tmWC,
      STDIClass.LoadSingleString('Properties/slots:',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L,250,clNavy,clNone,[]);
     for i:=0 to TTemplate(TreeView1.Selected.Data).Slots.Count-1 do
      begin
       T1:=STDIClass.AddLabel(tmWC,
        TSlot(TTemplate(TreeView1.Selected.Data).Slots.Items[i]).Name
        ,T,L+10,TreeView1.Width-L-35,clBlack,clNone,[fsBold]);
       TLabel(tmWC.Components[tmWC.ComponentCount-1]).Tag:=i;
       TLabel(tmWC.Components[tmWC.ComponentCount-1]).OnClick:=LinkSClick;
       TLabel(tmWC.Components[tmWC.ComponentCount-1]).Cursor:=crHandPoint;

       if T1<T2 then T1:=T2;
       T:=T1;
      end;
     if TTemplate(TreeView1.Selected.Data).Slots.Count=0 then
      T:=STDIClass.AddLabel(tmWC,
       STDIClass.LoadSingleString('no data',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L+10,250,clInactiveCaption,clNone,[]);

    if (DllIndex<>-1)and(DllList.Count>0) then
      tmTs.Text:=TTemplate(TreeView1.Selected.Data).
       GetDescriptionOnKBLanguage(DllList.Names[DllIndex]);

     STDIClass.ReleaseObjects(ScrollBox4);
//     TTemplate(TreeView1.Selected.Data).DrawParams.Clear;
     TTemplate(TreeView1.Selected.Data).Draw(ScrollBox4);

     CurrentRVMLObject:=TTemplate(TreeView1.Selected.Data);

     TTemplate(CurrentRVMLObject).RVMLImage.DragMode:=dmAutomatic;
//     TTemplate(CurrentRVMLObject).RVMLImage.OnMouseDown:=RVMLImageMouseDown;
 //    TTemplate(CurrentRVMLObject).RVMLImage.OnDragOver:=ScrollBox4.OnDragOver;
 //    TTemplate(CurrentRVMLObject).RVMLImage.OnDragDrop:=ScrollBox4.OnDragDrop;
    end;
   //-------------------------------------------------------------------------------
   //slot description
   if TObject(TreeView1.Selected.Data) is TSlot then
    begin
     RzPanel5.Visible:=False;

     T:=STDIClass.AddLabel(tmWC,
      STDIClass.LoadSingleString('Name:',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L,250,clNavy,clNone,[]);
     T:=STDIClass.AddLabel(tmWC,
      TSlot(TreeView1.Selected.Data).Name
       ,T,L+10,tmWC.Width-25-10,clBlack,clNone,[fsBold]);

     T:=STDIClass.AddLabel(tmWC,
      STDIClass.LoadSingleString('Description:',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L,250,clNavy,clNone,[]);
     if TSlot(TreeView1.Selected.Data).Description='' then
      T:=STDIClass.AddLabel(tmWC,
       STDIClass.LoadSingleString('no data',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L+10,250,clInactiveCaption,clNone,[])
      else
       T:=STDIClass.AddLabel(tmWC,TSlot(TreeView1.Selected.Data).Description
        ,T,L+10,tmWC.Width-25-10,clBlack,clNone,[fsBold]);

{     STDIClass.AddLabel(tmWC,'Тип значения:',T,L,80,clNavy,clNone,[]);
     if TSlot(TreeView1.Selected.Data).DataType='String' then
       T:=STDIClass.AddLabel(tmWC,'строка'
        ,T,L+80,tmWC.Width-25-80,clBlack,clNone,[fsBold])
      else
       T:=STDIClass.AddLabel(tmWC,'число'
        ,T,L+80,tmWC.Width-25-80,clBlack,clNone,[fsBold]);
}
     T:=STDIClass.AddLabel(tmWC,
      STDIClass.LoadSingleString('Possible value:',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L,250,clNavy,clNone,[]);
     if TSlot(TreeView1.Selected.Data).Value='' then
       T:=STDIClass.AddLabel(tmWC,
        STDIClass.LoadSingleString('no data',LangLocaleDir+LangPrefix+'012.lan')
        ,T,L+10,tmWC.Width-25-10,clInactiveCaption,clNone,[])
      else
       T:=STDIClass.AddLabel(tmWC,
//        '('+TSlot(TreeView1.Selected.Data).Constraint+') '+
         StringReplace(TSlot(TreeView1.Selected.Data).Value,';','; ',[rfReplaceAll])
         ,T,L+10,tmWC.Width-25-10,clBlack,clNone,[fsBold]);

    if (DllIndex<>-1)and(DllList.Count>0) then
      tmTs.Text:=TSlot(TreeView1.Selected.Data).
       GetDescriptionOnKBLanguage('2',DllList.Names[DllIndex]);
    end;
   //-------------------------------------------------------------------------------
   //var description
{   if TObject(TreeView1.Selected.Data) is TGlobalVar then
    begin
     RzButton3.Enabled:=False; //del
     RzButton4.Enabled:=False; //edit

     RzPanel5.Visible:=False;

     T:=STDIClass.AddLabel(tmWC,'Имя переменной:',T,L,250,clNavy,clNone,[]);
     T:=STDIClass.AddLabel(tmWC,
      TGlobalVar(TreeView1.Selected.Data).Name
       ,T,L+10,tmWC.Width-25-10,clBlack,clNone,[fsBold]);

     T:=STDIClass.AddLabel(tmWC,'Короткое имя:',T,L,250,clNavy,clNone,[]);
     T:=STDIClass.AddLabel(tmWC,
      TGlobalVar(TreeView1.Selected.Data).ShortName
       ,T,L+10,tmWC.Width-25-10,clInactiveCaption,clNone,[fsBold]);

     T:=STDIClass.AddLabel(tmWC,'Описание:',T,L,250,clNavy,clNone,[]);
     if TGlobalVar(TreeView1.Selected.Data).Description='' then
      T:=STDIClass.AddLabel(tmWC,'сведений нет'
       ,T,L+10,250,clInactiveCaption,clNone,[])
      else
       T:=STDIClass.AddLabel(tmWC,TGlobalVar(TreeView1.Selected.Data).Description
        ,T,L+10,tmWC.Width-25-10,clBlack,clNone,[fsBold]);

     STDIClass.AddLabel(tmWC,'Тип значения:',T,L,80,clNavy,clNone,[]);
     if TGlobalVar(TreeView1.Selected.Data).DataType='String' then
       T:=STDIClass.AddLabel(tmWC,'строка'
        ,T,L+80,tmWC.Width-25-80,clBlack,clNone,[fsBold])
      else
       T:=STDIClass.AddLabel(tmWC,'число'
        ,T,L+80,tmWC.Width-25-80,clBlack,clNone,[fsBold]);

     T:=STDIClass.AddLabel(tmWC,'Начальное значение:',T,L,250,clNavy,clNone,[]);
     if TGlobalVar(TreeView1.Selected.Data).Value='' then
       T:=STDIClass.AddLabel(tmWC,'сведений нет'
        ,T,L+10,tmWC.Width-25-10,clInactiveCaption,clNone,[])
      else
       T:=STDIClass.AddLabel(tmWC,
//        '('+TSlot(TreeView1.Selected.Data).Constraint+') '+
         TGlobalVar(TreeView1.Selected.Data).Value
         ,T,L+10,tmWC.Width-25-10,clBlack,clNone,[fsBold]);

    if (DllIndex<>-1)and(DllList.Count>0) then
      tmTs.Text:=TGlobalVar(TreeView1.Selected.Data).
       GetDescriptionOnKBLanguage(DllList.Names[DllIndex]);
    end;
   //-------------------------------------------------------------------------------
   //function description
   if TObject(TreeView1.Selected.Data) is TFunct then
    begin
     RzPanel5.Visible:=False;

     T:=STDIClass.AddLabel(tmWC,'Имя функции:',T,L,250,clNavy,clNone,[]);
     STDIClass.AddLabel(tmWC,'['+
      TFunct(TreeView1.Selected.Data).ID
       +']',T,10,30,clInactiveCaption,clNone,[fsBold]);
     T:=STDIClass.AddLabel(tmWC,
      TFunct(TreeView1.Selected.Data).Name
       ,T,L+10+50,tmWC.Width-25-10-50,clBlack,clNone,[fsBold]);

     T:=STDIClass.AddLabel(tmWC,'Короткое имя:',T,L,250,clNavy,clNone,[]);
     T:=STDIClass.AddLabel(tmWC,
      TFunct(TreeView1.Selected.Data).ShortName
       ,T,L+10,tmWC.Width-25-10,clInactiveCaption,clNone,[fsBold]);

     T:=STDIClass.AddLabel(tmWC,'Описание:',T,L,250,clNavy,clNone,[]);
     if TFunct(TreeView1.Selected.Data).Description='' then
      T:=STDIClass.AddLabel(tmWC,'сведений нет'
       ,T,L+10,250,clInactiveCaption,clNone,[])
      else
       T:=STDIClass.AddLabel(tmWC,TFunct(TreeView1.Selected.Data).Description
        ,T,L+10,tmWC.Width-25-(L+10),clBlack,clNone,[fsBold]);

     T:=STDIClass.AddLabel(tmWC,'Тип возвращаемого значения:',T,L,250,clNavy,clNone,[]);
     T:=STDIClass.AddLabel(tmWC,TFunct(TreeView1.Selected.Data).DataType
        ,T,L+10,tmWC.Width-25-(L+10),clBlack,clNone,[fsBold]);

     T:=STDIClass.AddLabel(tmWC,'Аргументы:',T,L,250,clNavy,clNone,[]);
     for i:=0 to TFunct(TreeView1.Selected.Data).Args.Count-1 do
      begin
       T1:=STDIClass.AddLabel(tmWC,
        TArgument(TFunct(TreeView1.Selected.Data).Args.Items[i]).Name
        ,T,L+10,100,clBlack,clNone,[fsBold]);
//       TLabel(tmWC.Components[tmWC.ComponentCount-1]).Tag:=i;
//      TLabel(tmWC.Components[tmWC.ComponentCount-1]).OnClick:=LinkSClick;
//       TLabel(tmWC.Components[tmWC.ComponentCount-1]).Cursor:=crHandPoint;

       T2:=STDIClass.AddLabel(tmWC,
         TArgument(TFunct(TreeView1.Selected.Data).Args.Items[i]).Description
        ,T,L+120,tmWC.Width-25-(L+120),clNavy,clNone,[fsBold]);

//       TLabel(tmWC.Components[tmWC.ComponentCount-1]).Tag:=i;
//       TLabel(tmWC.Components[tmWC.ComponentCount-1]).OnClick:=LinkSClick;
//       TLabel(tmWC.Components[tmWC.ComponentCount-1]).Cursor:=crHandPoint;

       if T1<T2 then T1:=T2;
//       T2:=STDIClass.AddLabel(tmWC,
//         TSlot(TTemplate(TreeView1.Selected.Data).Slots.Items[i]).GetSimpleDataType
//        ,T,L+280,50,clInactiveCaption,clNone,[fsBold]);
//       if T1<T2 then T1:=T2;
       T:=T1;
      end;
     if TFunct(TreeView1.Selected.Data).Args.Count=0 then
      T:=STDIClass.AddLabel(tmWC,'сведений нет'
       ,T,L+10,250,clInactiveCaption,clNone,[]);

     T:=STDIClass.AddLabel(tmWC,'Тело функции:',T,L,250,clNavy,clNone,[]);
     if TFunct(TreeView1.Selected.Data).Body='' then
      T:=STDIClass.AddLabel(tmWC,'сведений нет'
       ,T,L+10,250,clInactiveCaption,clNone,[])
      else
       T:=STDIClass.AddLabel(tmWC,TFunct(TreeView1.Selected.Data).Body
        ,T,L+10,tmWC.Width-25-(L+10),clBlack,clNone,[fsBold]);

    if (DllIndex<>-1)and(DllList.Count>0) then
      tmTs.Text:=TFunct(TreeView1.Selected.Data).
       GetDescriptionOnKBLanguage(DllList.Names[DllIndex]);
    end;
   //-------------------------------------------------------------------------------
}
   //rule description
   if TObject(TreeView1.Selected.Data) is TRule then
    begin
     // --- controls for rule ----------------------------
//     RzMenuButton1.Enabled:=True; //translit
      DeleteItem.Enabled:=True;
      EditItem.Enabled:=True;     //edit
      RzButton3.Enabled:=True;    //del
      RzButton4.Enabled:=True;    //edit

      ToolButton17.Enabled:=True; //save as bmp
      ToolButton21.Enabled:=True; //order by X axis
     //--------------------------------------------------

     TRule(TreeView1.Selected.Data).FactOrderMark(tmS);
     RzPanel5.Visible:=True;

     TRule(TreeView1.Selected.Data).ShowAsList(1,1,T,L,tmWC,K);

    if (DllIndex<>-1)and(DllList.Count>0) then
      tmTs.Text:=TRule(TreeView1.Selected.Data).
       GetDescriptionOnKBLanguage(DllList.Names[DllIndex]);

     STDIClass.ReleaseObjects(ScrollBox4);
     TRule(TreeView1.Selected.Data).Draw(ScrollBox4);

//     CurrentRVMLObject:=TRule(TreeView1.Selected.Data);

     TRule(TreeView1.Selected.Data).RVMLImage.OnMouseDown:=RVMLImageMouseDown;
     TRule(TreeView1.Selected.Data).RVMLImage.OnDragOver:=ScrollBox4.OnDragOver;
     TRule(TreeView1.Selected.Data).RVMLImage.OnDragDrop:=ScrollBox4.OnDragDrop;
//       TRule(TreeView1.Selected.Data).RVMLImage.DragMode:=dmAutomatic;

     for i:=0 to TRule(TreeView1.Selected.Data).DrawnObjects.Count-1 do
      begin
//       TImage(TRule(TreeView1.Selected.Data).DrawnObjects.Items[i]).OnMouseDown:=
//        RVMLImageMouseDown;
//       TImage(TRule(TreeView1.Selected.Data).DrawnObjects.Items[i]).OnDragOver:=
//        ScrollBox4.OnDragOver;
//       TImage(TRule(TreeView1.Selected.Data).DrawnObjects.Items[i]).OnDragDrop:=
//        RVMLImageDragDrop;
      TImage(TRule(TreeView1.Selected.Data).DrawnObjects.Items[i]).DragMode:=
        dmAutomatic;
      end;
    end;

   //-------------------------------------------------------------------------------
   //generalised rule description
   if TObject(TreeView1.Selected.Data) is TGRule then
    begin
     // --- controls for template ----------------------------
//     RzMenuButton1.Enabled:=True; //translit
     if UserMode=1 then //only for adm
      begin
       DeleteItem.Enabled:=True;
       EditItem.Enabled:=True;     //edit
       RzButton3.Enabled:=True;    //del

       //       RzButton4.Enabled:=True;    //edit
//       ToolButton11.Enabled:=True;  //pkg

       ToolButton17.Enabled:=True; //save as bmp
       ToolButton21.Enabled:=True; //order by X axis
      end;
     //--------------------------------------------------
//     TGRule(TreeView1.Selected.Data).FactOrderMark(tmS);
     RzPanel5.Visible:=True;

     T:=STDIClass.AddLabel(tmWC,
      STDIClass.LoadSingleString('Name:',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L,250,clNavy,clNone,[]);
     STDIClass.AddLabel(tmWC,'['+
      TGRule(TreeView1.Selected.Data).ID
       +']',T,10,30,clInactiveCaption,clNone,[fsBold]);
     T:=STDIClass.AddLabel(tmWC,
      TGRule(TreeView1.Selected.Data).Name
       ,T,L+10+50,tmWC.Width-25-10-50,clBlack,clNone,[fsBold]);

{     T:=STDIClass.AddLabel(tmWC,'Короткое имя:',T,L,250,clNavy,clNone,[]);
     T:=STDIClass.AddLabel(tmWC,
      TGRule(TreeView1.Selected.Data).ShortName
       ,T,L+10,tmWC.Width-25-10,clInactiveCaption,clNone,[fsBold]);

{     STDIClass.AddLabel(tmWC,'Важность/приоритет:',T,L,80,clNavy,clNone,[]);
     if TRule(TreeView1.Selected.Data).Salience='' then
      T:=STDIClass.AddLabel(tmWC,'сведений нет'
       ,T,L+120,200,clInactiveCaption,clNone,[])
      else
       T:=STDIClass.AddLabel(tmWC,TRule(TreeView1.Selected.Data).Salience
        ,T,L+120,tmWC.Width-25-120,clBlack,clNone,[fsBold]);
}
     T:=STDIClass.AddLabel(tmWC,
      LS('Description:')
       ,T,L,250,clNavy,clNone,[]);
     if TGRule(TreeView1.Selected.Data).Description='' then
      T:=STDIClass.AddLabel(tmWC,
       STDIClass.LoadSingleString('no data',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L+10,250,clInactiveCaption,clNone,[])
      else
       T:=STDIClass.AddLabel(tmWC,TGRule(TreeView1.Selected.Data).Description
        ,T,L+10,tmWC.Width-25-10,clBlack,clNone,[fsBold]);

     T:=STDIClass.AddLabel(tmWC,
      LS('Condition (IF):')
       ,T,L,250,clNavy,clNone,[]);
     for i:=0 to TGRule(TreeView1.Selected.Data).Conditions.Count-1 do
      begin
//       if i>0 then
//        T:=STDIClass.AddLabel(tmWC,
//        TTemplate(TRule(TreeView1.Selected.Data).Conditions.Items[i]).GetOperator
//         ,T,L+10,tmWC.Width-25-10,clGreen,clNone,[fsBold]);
       T:=STDIClass.AddLabel(tmWC,
        TTemplate(TGRule(TreeView1.Selected.Data).Conditions.Items[i]).Name
  //      GetInfo(0,0,
  //       TKnowledgeBase(TreeView1.Selected.Parent.Parent.Data)
  //       )
         ,T,L+10,tmWC.Width-25-10,clBlack,clNone,[fsBold]);

//      j:=TKnowledgeBase(TreeView1.Selected.Parent.Parent.Data).IndexOfTemplate(
//       TCondition(TRule(TreeView1.Selected.Data).Conditions.Items[i]).Fact
//        );
{
      if j>-1 then
       tmTs1.Add(TTemplate(TKnowledgeBase(TreeView1.Selected.Parent.Parent.Data).
        Templates.Items[j]).ShortName)
        else
         tmTs1.Add('Noname');
}
      end;

     if TGRule(TreeView1.Selected.Data).Conditions.Count=0 then
      T:=STDIClass.AddLabel(tmWC,
       STDIClass.LoadSingleString('no data',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L+10,250,clInactiveCaption,clNone,[]);

     T:=STDIClass.AddLabel(tmWC,
      LS('Action (THEN):')
       ,T,L,250,clNavy,clNone,[]);
     for i:=0 to TGRule(TreeView1.Selected.Data).Actions.Count-1 do
      begin
//       T:=STDIClass.AddLabel(tmWC,
//        TTemplate(TGRule(TreeView1.Selected.Data).Actions.Items[i]).GetOperator
//         ,T,L+10,tmWC.Width-25-10,clRed,clNone,[fsBold]);
       T:=STDIClass.AddLabel(tmWC,
        TTemplate(TGRule(TreeView1.Selected.Data).Actions.Items[i]).Name
//        GetInfo(0,0,
//         TKnowledgeBase(TreeView1.Selected.Parent.Parent.Data)
//          )
          ,T,L+10,tmWC.Width-25-10,clBlack,clNone,[fsBold]);

{      j:=TKnowledgeBase(TreeView1.Selected.Parent.Parent.Data).IndexOfTemplate(
       TRAction(TRule(TreeView1.Selected.Data).Actions.Items[i]).Fact
        );
      if j>-1 then
       tmTs1.Add(TTemplate(TKnowledgeBase(TreeView1.Selected.Parent.Parent.Data).
        Templates.Items[j]).ShortName)
        else
         tmTs1.Add('Noname');
}
      end;

     if TGRule(TreeView1.Selected.Data).Actions.Count=0 then
      T:=STDIClass.AddLabel(tmWC,
       STDIClass.LoadSingleString('no data',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L+10,250,clInactiveCaption,clNone,[]);

//    if (DllIndex<>-1)and(DllList.Count>0) then
//      tmTs.Text:=TRule(TreeView1.Selected.Data).
//       GetDescriptionOnKBLanguage(DllList.Names[DllIndex]);
     tmTs.Text:=
      STDIClass.LoadSingleString('no data',LangLocaleDir+LangPrefix+'012.lan');

     STDIClass.ReleaseObjects(ScrollBox4);
     TGRule(TreeView1.Selected.Data).Draw(ScrollBox4);

     TGRule(TreeView1.Selected.Data).RVMLImage.OnMouseDown:=RVMLImageMouseDown;
     TGRule(TreeView1.Selected.Data).RVMLImage.OnDragOver:=ScrollBox4.OnDragOver;
     TGRule(TreeView1.Selected.Data).RVMLImage.OnDragDrop:=ScrollBox4.OnDragDrop;
//     TGRule(TreeView1.Selected.Data).RVMLImage.DragMode:=dmAutomatic;

     for i:=0 to TGRule(TreeView1.Selected.Data).DrawnObjects.Count-1 do
      begin
       TImage(TGRule(TreeView1.Selected.Data).DrawnObjects.Items[i]).DragMode:=
        dmAutomatic;
//       TImage(TGRule(TreeView1.Selected.Data).DrawnObjects.Items[i]).OnMouseDown:=
//        RVMLImageMouseDown;
//       TImage(TGRule(TreeView1.Selected.Data).DrawnObjects.Items[i]).OnDragOver:=
//        ScrollBox4.OnDragOver;
//       TImage(TGRule(TreeView1.Selected.Data).DrawnObjects.Items[i]).OnDragDrop:=
//        RVMLImageDragDrop;
      end;
    end;

   //-------------------------------------------------------------------------------
   //condition description
   if TObject(TreeView1.Selected.Data) is TCondition then
    begin
     TRule(TreeView1.Selected.Parent.Parent.Data).FactOrderMark(tmS);
     RzPanel5.Visible:=True;
    T:=STDIClass.AddLabel(tmWC,
     STDIClass.LoadSingleString('Name:',LangLocaleDir+LangPrefix+'012.lan')
      ,T,L,250,clNavy,clNone,[]);
     T:=STDIClass.AddLabel(tmWC,
      TCondition(TreeView1.Selected.Data).Fact.Name
       ,T,L+10,tmWC.Width-25-10,clBlack,clNone,[fsBold]);
     T:=STDIClass.AddLabel(tmWC,
      STDIClass.LoadSingleString('Condition:',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L,250,clNavy,clNone,[]);
     T:=STDIClass.AddLabel(tmWC,
      TCondition(TreeView1.Selected.Data).GetInfo(0,0,
       TKnowledgeBase(TreeView1.Selected.Parent.Parent.Parent.Parent.Data))
       ,T,L+10,tmWC.Width-25-10,clBlack,clNone,[fsBold]);
    end;
   //-------------------------------------------------------------------------------
   //action description
   if TObject(TreeView1.Selected.Data) is TRAction then
    begin
     TRule(TreeView1.Selected.Parent.Parent.Data).FactOrderMark(tmS);
     RzPanel5.Visible:=True;

     T:=STDIClass.AddLabel(tmWC,
      STDIClass.LoadSingleString('Name:',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L,250,clNavy,clNone,[]);
     T:=STDIClass.AddLabel(tmWC,
      TRAction(TreeView1.Selected.Data).Fact.Name
       ,T,L+10,tmWC.Width-25-10,clBlack,clNone,[fsBold]);
     T:=STDIClass.AddLabel(tmWC,
      STDIClass.LoadSingleString('Action:',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L,250,clNavy,clNone,[]);
     T:=STDIClass.AddLabel(tmWC,
      TRAction(TreeView1.Selected.Data).GetOperator
       ,T,L+10,tmWC.Width-25-10,clRed,clNone,[fsBold]);
     T:=STDIClass.AddLabel(tmWC,
      TRAction(TreeView1.Selected.Data).GetInfo(0,0,
       TKnowledgeBase(TreeView1.Selected.Parent.Parent.Parent.Parent.Data))
       ,T,L+10,tmWC.Width-25-10,clBlack,clNone,[fsBold]);
    end;
   //-------------------------------------------------------------------------------
   //fact description
   if TObject(TreeView1.Selected.Data) is TFact then
    begin
     tmWC.Visible:=False;
     // --- controls for fact ----------------------------
     DeleteItem.Enabled:=True;
     EditItem.Enabled:=True;
     RzButton3.Enabled:=True;
     RzButton4.Enabled:=True;

//     ToolButton11.Enabled:=True;  //pkg
     ToolButton17.Enabled:=True; //save as bmp
     //----------------------------------------------------

     TFact(TreeView1.Selected.Data).FactOrderMark(tmS);
     RzPanel5.Visible:=True;

     tmP:=STDIClass.AddRzPanel(1,1,55,500,
      tmWC,i,alTop,clCream,bvNone,bvNone,bsNone,'');

     T:=STDIClass.AddLabel(tmP,
      STDIClass.LoadSingleString('Name',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L,250,clNavy,clNone,[]);
//     T:=STDIClass.AddLabel(tmP,'Имя факта (прецедента):',T,L,250,clNavy,clNone,[]);
     STDIClass.AddLabel(tmP,'['+
      TFact(TreeView1.Selected.Data).ID
       +']',T,10,30,clInactiveCaption,clNone,[fsBold]);
     T:=STDIClass.AddLabel(tmP,
      TFact(TreeView1.Selected.Data).Name
       ,T,L+10+50,tmP.Width-25-10-50,clBlack,clNone,[fsBold]);

     T:=STDIClass.AddLabel(tmP,
      STDIClass.LoadSingleString('Properties/slots and their values:',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L,250,clNavy,clNone,[]);
     T:=TFact(TreeView1.Selected.Data).ShowAsTable(tmWC,T,0);
  {
     for i:=0 to TFact(TreeView1.Selected.Data).Slots.Count-1 do
     if TSlot(TFact(TreeView1.Selected.Data).Slots.Items[i]).Value<>'' then
      begin

       tmP:=STDIClass.AddRzPanel(i*5+60,1,20,500,
        tmWC,i,alTop,clCream,bvNone,bvNone,bsNone,'');

       STDIClass.AddRzPanel(1,1,10,Round(tmP.Width/2),
        tmP,i,alLeft,clCream,bvNone,bvNone,bsSingle,
         TSlot(TFact(TreeView1.Selected.Data).Slots.Items[i]).Name);
       tmP1:=STDIClass.AddRzPanel(1,100,10,Round(tmP.Width/2),
        tmP,i,alClient,clCream,bvNone,bvNone,bsSingle,
         TSlot(TFact(TreeView1.Selected.Data).Slots.Items[i]).Value);
       tmP1.Font.Style:=[fsBold];
       tmP1.Font.Color:=clGreen;
      end;  }

     if (TFact(TreeView1.Selected.Data).Slots.Count=0)or
      (TLabel(tmWC.Components[tmWC.ComponentCount-1]).Font.Color=clNavy) then
      T:=STDIClass.AddLabel(tmWC,
       STDIClass.LoadSingleString('no data',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L+10,250,clInactiveCaption,clNone,[]);
    tmWC.Visible:=True;

    if (DllIndex<>-1)and(DllList.Count>0) then
      tmTs.Text:=TFact(TreeView1.Selected.Data).
       GetDescriptionOnKBLanguage(DllList.Names[DllIndex]);

     STDIClass.ReleaseObjects(ScrollBox4);
  //   TFact(TreeView1.Selected.Data).DrawParams.Clear;
     TFact(TreeView1.Selected.Data).Draw(ScrollBox4,2);

     CurrentRVMLObject:=TFact(TreeView1.Selected.Data);
//     TFact(CurrentRVMLObject).RVMLImage.OnMouseDown:=RVMLImageMouseDown;
//     TFact(CurrentRVMLObject).RVMLImage.OnMouseUp:=RVMLImageMouseUp;
//     TFact(CurrentRVMLObject).RVMLImage.OnDragOver:=ScrollBox4.OnDragOver;
//     TFact(CurrentRVMLObject).RVMLImage.OnDragDrop:=ScrollBox4.OnDragDrop;
//     TFact(CurrentRVMLObject).RVMLImage.OnClick:=RVMLImageMouseClick;
     TFact(CurrentRVMLObject).RVMLImage.DragMode:=dmAutomatic;
    end;
   //-------------------------------------------------------------------------------
   //task description
   if TObject(TreeView1.Selected.Data) is TTask then
    begin
     tmWC.Visible:=False;

     // --- controls for tasks ----------------------------
     DeleteItem.Enabled:=True;
//     EditItem.Enabled:=True;
     RzButton3.Enabled:=True;
     //     RzButton4.Enabled:=True;
//     ToolButton11.Enabled:=True;      //pkg
     //----------------------------------------------------
     //-----------------------------------------
     //for es mode
     //-----------------------------------------
     ToolButton17.Enabled:=False;  //make image
     RzEdit1.Text:=TTask(TreeView1.Selected.Data).Name;
     RzEdit3.Text:=TTask(TreeView1.Selected.Data).Authors;
     RzEdit2.Text:=TTask(TreeView1.Selected.Data).Creation_date;
     RzEdit5.Text:=TTask(TreeView1.Selected.Data).Modification_date;
     RzEdit4.Text:=TTask(TreeView1.Selected.Data).Platfotm;
     RzPanel19.Width:=317;

     Memo1.Text:=TTask(TreeView1.Selected.Data).Description;
     if Trim(TTask(TreeView1.Selected.Data).Logo_file)<>'' then
       try
        ProgramIcon.Picture.LoadFromFile(Trim(TTask(TreeView1.Selected.Data).Logo_file));
       except
       end;
     RzComboBox1Change(RzComboBox1);
     //-----------------------------------------
     tmP:=STDIClass.AddRzPanel(1,1,55,500,
      tmWC,i,alTop,clCream,bvNone,bvNone,bsNone,'');

     T:=STDIClass.AddLabel(tmP,
      STDIClass.LoadSingleString('Task:',LangLocaleDir+LangPrefix+'012.lan')
       ,1,L,250,clNavy,clNone,[]);
     T:=STDIClass.AddLabel(tmP,'['+
      TTask(TreeView1.Selected.Data).ID
       +']',T,10,30,clInactiveCaption,clNone,[fsBold]);
//     tmP.AutoSize:=True;
//     tmP.Height:=tmP.Height+5;
//     T:=getTForLabel(tmP);

//     T:=STDIClass.AddLabel(tmP,
//      TFact(TreeView1.Selected.Data).Name
//       ,T,L+10+50,tmP.Width-25-10-50,clBlack,clNone,[fsBold]);
     T:=T+tmP.Height;
//     T:=STDIClass.AddLabel(tmWC,'Целевые свойства/слоты и их значения:',
//      T,L,250,clNavy,clNone,[]);

   //for case-base
   if (K.Kind=1)and(TTask(TreeView1.Selected.Data).K1<>nil) then
    begin  //cbr (crp) results publication
     tmP0:=STDIClass.AddRzPanel(T,1,20,500,
      tmWC,i,alTop,clCream,bvNone,bvNone,bsNone,
       STDIClass.LoadSingleString('  Targerted properties/slots and their values:',LangLocaleDir+LangPrefix+'012.lan')
        );
     tmP0.Alignment:=taLeftJustify;
     tmP0.Font.Color:=clNavy;
     T:=T+tmP0.Height;

     T:=TTask(TreeView1.Selected.Data).F1.ShowAsTable(tmWC,T,0);

     if (TTask(TreeView1.Selected.Data).F1.Slots.Count=0)or
      (TLabel(tmWC.Components[tmWC.ComponentCount-1]).Font.Color=clNavy) then
      T:=STDIClass.AddLabel(tmWC,
       STDIClass.LoadSingleString('no data',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L+10,250,clInactiveCaption,clNone,[]);

     //-------------------------------------------
       tmP1:=STDIClass.AddRzPanel(T,1,20,500,
        tmWC,i,alTop,clCream,bvNone,bvNone,bsNone,
         STDIClass.LoadSingleString('  Results of case retrieval:',LangLocaleDir+LangPrefix+'012.lan')
          );
       tmP1.Alignment:=taLeftJustify;
       tmP1.Font.Color:=clNavy;

     T:=T+tmP1.Height;

     for i := 0 to TTask(TreeView1.Selected.Data).CBRPResults.Count-1 do
      begin
       tmP0:=STDIClass.AddRzPanel(T+i*5+30,1,20,500,
        tmWC,i,alTop,clCream,bvNone,bvNone,bsNone,'');

       STDIClass.AddRzPanel(1,1,10,30,
        tmP0,i,alLeft,clCream,bvNone,bvNone,bsSingle,
         IntToStr(i+1));

       tmP1:=STDIClass.AddRzPanel(1,100,10,45,
        tmP0,i,alLeft,clCream,bvNone,bvNone,bsSingle,
         '['+TTask(TreeView1.Selected.Data).CBRPResults.Names[i]+']');
       tmP1.Font.Style:=[fsBold];
       tmP1.Font.Color:=cl3DDkShadow;
       tmP1.Tag:=i;
       tmP1.OnClick:=ResultPanelClick;
       tmP1.Cursor:=crHandPoint;

       c:=TTask(TreeView1.Selected.Data).K1.IndexOfFactByID(
        TTask(TreeView1.Selected.Data).CBRPResults.Names[i]
         );
       if c=-1 then tmS:=STDIClass.LoadSingleString('no data',LangLocaleDir+LangPrefix+'012.lan')
        else
         begin
          tmS:=TFact(TTask(TreeView1.Selected.Data).K1.Facts.Items[c]).Name;
         end;

       tmP1:=STDIClass.AddRzPanel(1,100,10,45,
        tmP0,i,alClient,clCream,bvNone,bvNone,bsSingle,
         tmS);
       tmP1.Font.Style:=[fsBold];
       tmP1.Tag:=i;
       tmP1.OnClick:=ResultPanelClick;
       tmP1.Cursor:=crHandPoint;
       //on click

       tmP1:=STDIClass.AddRzPanel(1,500,10,45,
        tmP0,i,alRight,clCream,bvNone,bvNone,bsSingle,
         TTask(TreeView1.Selected.Data).CBRPResults.ValueFromIndex[i]);
       tmP1.Font.Style:=[fsBold];
    //   tmP1.Font.Color:=clWhite;
       tmP1.Color:=CRPManager.GetColorForOutputResultsPublication(
        TTask(TreeView1.Selected.Data).CBRPResults.ValueFromIndex[i],1);
       tmP1.Tag:=i;
       tmP1.OnClick:=ResultPanelClick;
       tmP1.Cursor:=crHandPoint;

       T:=T+tmP0.Height;
      end;

     tmP1:=STDIClass.AddRzPanel(T,1,20,500,
     tmWC,i,alTop,clCream,bvNone,bvNone,bsNone,
      STDIClass.LoadSingleString('Results of multi-criteria methods:',LangLocaleDir+LangPrefix+'012.lan')
       );
     tmP1.Alignment:=taLeftJustify;
     tmP1.Font.Color:=clNavy;

     T:=tmP1.Top+tmP1.Height;
     TTask(TreeView1.Selected.Data).ShowDSPResults(tmWC,T);
     //-------------------------------------
     end; //end crp results publication
l67:
   //for rule base
   if (K.Kind=0)then
    begin
    if(TTask(TreeView1.Selected.Data).K2<>nil) then
     begin //rrp results publication
       ToolButton18.Enabled:=True;  //create ES
       N41.Enabled:=True;  //create ES
//       CFM1.Enabled:=True;  //create ES

       tmP0:=STDIClass.AddRzPanel(T,1,20,500,
        tmWC,i,alTop,clCream,bvNone,bvNone,bsNone,'  '+
         STDIClass.LoadSingleString('Initial facts',LangLocaleDir+LangPrefix+'012.lan')+
          ':');
       tmP0.Alignment:=taLeftJustify;
       tmP0.Font.Color:=clNavy;
       T:=T+tmP0.Height;

        if K.Facts.Count>0 then
         for i := 0 to K.Facts.Count-1 do
          begin
           T:=TFact(K.Facts.Items[i]).ShowAsTable(tmWC,T+5,1);
          end
        else
         begin
          tmP:=STDIClass.AddRzPanel(T,1,20,500,
           tmWC,i,alTop,clCream,bvNone,bvNone,bsNone,
            STDIClass.LoadSingleString('no data',LangLocaleDir+LangPrefix+'012.lan')
             );
          tmP.Font.Color:=clRed;
          tmP.Font.Style:=[fsBold];
         end;

       tmP1:=STDIClass.AddRzPanel(T,1,20,500,
        tmWC,i,alTop,clCream,bvNone,bvNone,bsNone,
         STDIClass.LoadSingleString('Inference results:',LangLocaleDir+LangPrefix+'012.lan')
          );
       tmP1.Alignment:=taLeftJustify;
       tmP1.Font.Color:=clNavy;

      T:=T+20;
      x:=0; T3:=1; T2:=1;
      if TTask(TreeView1.Selected.Data).K2.FiredRules.Count>0 then
      begin
       for i := 0 to TTask(TreeView1.Selected.Data).K2.FiredRules.Count-1 do
        begin
         s:=Trim(TTask(TreeView1.Selected.Data).K2.FiredRules.Strings[i]);
         j:=K.IndexOfRuleByName(s);
         if j>-1 then
          begin
           Inc(x);
           tmRule:=TRule(K.Rules.Items[j]);
           T:=TRule(K.Rules.Items[j]).ShowAsPanel(K,tmWC,T,x);

           for j := 0 to tmRule.Actions.Count-1 do
            begin
             Inc(x);
             T:=TRAction(tmRule.Actions.Items[j]).Fact.ShowAsPanel(
              TRAction(tmRule.Actions.Items[j]).Operator,
               tmWC,T,x);
            end;
          end;
        end;
        //********************** публикация результата ***********
      //    ShowResults(RzListView24,RRPManager.States.Count-1);
      end
      else
      begin
       tmP:=STDIClass.AddRzPanel(T,1,20,500,
        tmWC,i,alTop,clCream,bvNone,bvNone,bsNone,
         STDIClass.LoadSingleString('No new facts',LangLocaleDir+LangPrefix+'012.lan')
          );
       tmP.Font.Style:=[fsBold];
       tmP.Font.Color:=clRed;
      end;

     T:=T+tmP1.Height;
     end
     else //k2=nil
      begin
       //restart
       //-----------------------------
    //    ImageList4.GetBitmap((i mod 20),prIm.Picture.Bitmap);
        prP.Caption:=LS('Please,wait')+' ...';
        Application.ProcessMessages;
        //-----------------------------
       //----------------------------------------------------------
         try
          tmTs:=TStringList.Create;

          tmState:=TRMState.Create;
          tmState.Init;
          RRPManager:=TRRPManager.Create;
          RRPManager.Init;

          if RRPManager.States.Count=0 then
           RRPManager.States.Add(tmState);

         //*******************************************************************
          //******************** ввод фактов и правил в рабочую память ********
          //*******************************************************************
          if (DllIndex<>-1)and(DllList.Count>0) then
           tmTs.Text:=KB.
            GetDescriptionOnKBLanguage(DllList.Names[DllIndex]);
          tmTs.SaveToFile(ExtractFileDir(Application.ExeName)+'\Data\rrp.tmp');

          tmTs.Clear;
          tmTs.Add(ExtractFileDir(Application.ExeName)+'\Data\rrp.tmp');
          RRPManager.KB:=TRRPKnowledgeBase.Create;
          RRPManager.KB.Init;
          i:=RRPManager.KB.LoadKnowledgeBaseViaDll(tmTs,3);  //load knowledge bases to clips
         if i<>-1 then
          begin
          i:=RRPManager.KB.RunCLIPSViaDll(ExtractFileDir(Application.ExeName)+
           '\Data\rrp_oudata'); //run clips
          end;
          TTask(TreeView1.Selected.Data).K2:=RRPManager.KB;
         except
         end;
       //-------------------------------------------------------------------

        prP.Free;
       //return
       goto l67;
      end;
    end; //end task for rules
     tmWC.Visible:=True;

    end;  //end task
   //-------------------------------------------------------------------------------

    //-------------------------------------------------------------------------------
   //pakage description
   if TObject(TreeView1.Selected.Data) is TTmObj then
    begin
     // --- controls for pkg ----------------------------
     if UserMode=1 then
      begin
       DeleteItem.Enabled:=True;
       EditItem.Enabled:=True;
       RzButton3.Enabled:=True;
       RzButton4.Enabled:=True;
//       ToolButton11.Enabled:=True;     //pkg
       if //(TreeView1.Selected.Level=3)or
        (TreeView1.Selected.Level>1) then ToolButton11.Enabled:=True
          else ToolButton11.Enabled:=False;
      end;
     //----------------------------------------------------
     T:=STDIClass.AddLabel(tmWC,TreeView1.Selected.Text
      ,T,L,250,clBlack,clNone,[fsBold]);
     for i := 0 to TreeView1.Selected.Count-1  do
      begin
       T:=STDIClass.AddLabel(tmWC,TreeView1.Selected.Item[i].Text
        ,T,L+10,tmWC.Width-30,clNavy,clNone,[]);
       TLabel(tmWC.Components[tmWC.ComponentCount-1]).Cursor:=crHandPoint;
       TLabel(tmWC.Components[tmWC.ComponentCount-1]).Tag:=i;
       TLabel(tmWC.Components[tmWC.ComponentCount-1]).OnClick:=
        LabelClick_V2;
      end;
     end;
   end
 else //nil
  begin

     if UserMode=1 then
      begin
       ToolButton11.Enabled:=True;
       if (TreeView1.Selected.Level=3)or
        (TreeView1.Selected.Level=2) then ToolButton11.Enabled:=True
          else ToolButton11.Enabled:=False;
      end;
   //!!! description for package

   T:=STDIClass.AddLabel(tmWC,TreeView1.Selected.Text
    ,T,L,250,clBlack,clNone,[fsBold]);
     for i := 0 to TreeView1.Selected.Count-1  do
      begin
       T:=STDIClass.AddLabel(tmWC,TreeView1.Selected.Item[i].Text
        ,T,L+10,tmWC.Width-30,clNavy,clNone,[]);
       TLabel(tmWC.Components[tmWC.ComponentCount-1]).Cursor:=crHandPoint;
       TLabel(tmWC.Components[tmWC.ComponentCount-1]).Tag:=i;
       TLabel(tmWC.Components[tmWC.ComponentCount-1]).OnClick:=
        LabelClick_V2;
      end;
  end;
try
 Screen.Cursor:=crHourGlass;
 RzProgressStatus1.TotalParts:=tmTs.Count;;
 RzMemo1.Text:=tmTs.Text;
 Screen.Cursor:=crDefault;
except
// tP.Free;
 RzProgressStatus1.PartsComplete:=0;
 Screen.Cursor:=crDefault;
end;

 if tmTs.Count=0 then
  RzMemo1.Clear;
//  T:=STDIClass.AddLabel(tmWC,'сведений нет'
//  ,T,L+10,tmWC.Width-25-10,clInactiveCaption,clNone,[]);
// end;
// tmWC.Visible:=True;
except
end;
 tmWC.Visible:=True;
end;

procedure TMainForm.N16Click(Sender: TObject);
var
// s: string;
 tmKB1  : TKnowledgeBase;
begin
 OpenDialog1.Title:=Application.Title+': '+
  STDIClass.LoadSingleString('Open',LangLocaleDir+LangPrefix+'012.lan');
 OpenDialog1.Filter:='EKB files |*.ekb|'+
  STDIClass.LoadSingleString('All',LangLocaleDir+LangPrefix+'012.lan')+
   '|*.*';
 OpenDialog1.InitialDir:=ExtractFileDir(Application.ExeName)+'\Data';
 if OpenDialog1.Execute then
  if OpenDialog1.FileName<>'' then
   begin
    tmKB1:=TKnowledgeBase.Create;
    tmKB1.Init;
    tmKB1.FileName:=OpenDialog1.FileName;
    AddToRecentFiles(OpenDialog1.FileName);
//    tmKB1.ID:=GetKBID(KBList);
    if XmlDow.parXML(OpenDialog1.FileName,tmKB1)=0 then
     begin
      MainForm.MakeDump(
       STDIClass.LoadSingleString('Open: knowledge base',LangLocaleDir+LangPrefix+'012.lan')
        ,7);
      MainForm.LoadAList(MainForm.RzListView1);

      //check ID
      if IndexOfKBbyID(KBList,tmKB1.ID)<>-1 then
       begin //kb is opened
         MainForm.MMessageBox(1,0,'0='+
          STDIClass.LoadSingleString('The knowledge base is already open',LangLocaleDir+LangPrefix+'012.lan')
          );
       end
      else
       begin //kb is not opened
        //check name
        if IndexOfKBbyName(KBList,tmKB1.Name)<>-1 then
         begin //the similar kb is opened
          if MMessageBox(1,1,'0='+
           STDIClass.LoadSingleString('The Knowledge base with the same name is already open. Still open?',LangLocaleDir+LangPrefix+'012.lan')
           )=0
           then
            begin
              KBList.Add(tmKB1);
              MainForm.LoadTree(KBList,MainForm.TreeView1);
            end;
         end
        else
         begin
          KBList.Add(tmKB1);
          MainForm.LoadTree(KBList,MainForm.TreeView1);
         end;
       end;
     end;
   end;

end;

procedure TMainForm.N18Click(Sender: TObject);
begin
 doc1Click(Self);
end;

procedure TMainForm.N19Click(Sender: TObject);
var
 K : TKnowledgeBase;
begin
 if (TreeView1.Selected=nil)or(TreeView1.Selected.Level<1) then
  MMessageBox(1,0,'0='+
   STDIClass.LoadSingleString('Select the knowledge base for saving',LangLocaleDir+LangPrefix+'012.lan')
   )
else
 begin
  if MMessageBox(1,1,'0='+
   STDIClass.LoadSingleString('Save the knowledge base?',LangLocaleDir+LangPrefix+'012.lan')
   )=0
   then
    begin
     K:=GetKBForNode(TreeView1.Selected);
     if (K<>nil) then
      begin
       if K.FileName='' then
        begin
         SaveDialog1.Title:=Application.Title+': '+
          STDIClass.LoadSingleString('Save',LangLocaleDir+LangPrefix+'012.lan');
         SaveDialog1.Filter:='EKB files |*.ekb|'+
          STDIClass.LoadSingleString('All',LangLocaleDir+LangPrefix+'012.lan')+
           '|*.*';
         SaveDialog1.InitialDir:=ExtractFileDir(Application.ExeName)+'.\Data';
         SaveDialog1.FileName:='';

        if SaveDialog1.Execute() then
         if (SaveDialog1.FileName<>'') then
         begin
          if pos('.ekb',SaveDialog1.FileName)=0 then
           SaveDialog1.FileName:=SaveDialog1.FileName+'.ekb';
          K.FileName:=
           SaveDialog1.FileName;
          XmlSave.GXMLStrSF(K.FileName,K);
          AddToRecentFiles(K.FileName);
         end;
        end
       else
        XmlSave.GXMLStrSF(K.FileName,K);
        AddToRecentFiles(K.FileName);
      end;
    end;
 end;
end;

procedure TMainForm.TabSheet1Show(Sender: TObject);
begin
 ToolBar3.Visible:=False;
end;

procedure TMainForm.TabSheet3Show(Sender: TObject);
begin
 ToolBar3.Visible:=False;
end;

procedure TMainForm.TabSheet5Exit(Sender: TObject);
begin
 ToolBar3.Visible:=False;
end;

procedure TMainForm.TabSheet5Show(Sender: TObject);
begin
 ToolBar3.Visible:=True;
end;

procedure TMainForm.TabSheet6Show(Sender: TObject);
begin
   TabSheet6.Caption:=LS('Expert system');
   TabSheet7.Caption:=LS('General information');
   RzTabSheet3.Caption:=LS('Initial facts');
   RzTabSheet2.Caption:=LS('Results: Facts changed');
   RzTabSheet1.Caption:=LS('Results: Rules fired');

   RzComboBox1.Clear;
   RzComboBox1.Add(LS('Templates4'));
   RzComboBox1.Add(LS('Rules1'));
   RzComboBox1.ItemIndex:=0;

   RzLabel2.Caption:=LS('Name:');
   RzLabel3.Caption:=LS('Author(s):');
   RzLabel4.Caption:=LS('Platform:');
   RzLabel5.Caption:=LS('Modification date:');
   RzLabel6.Caption:=LS('Description:');
   RzLabel7.Caption:=LS('Creation date:');

   GroupBox5.Caption:=' '+LS('General information')+': ';

end;

procedure TMainForm.Timer1Timer(Sender: TObject);
begin
{
// STDIClass.ReleaseObjects(ScrollBox4);
 if CurrentRVMLObject<>nil then
  begin
   if CurrentRVMLObject is TGRule then
    begin
     TGRule(CurrentRVMLObject).DrawArrows(
      TGRule(CurrentRVMLObject).RVMLImage.Canvas,
       TScrollBox(TGRule(CurrentRVMLObject).RVMLImage.Parent).HorzScrollBar.Position,
       TScrollBox(TGRule(CurrentRVMLObject).RVMLImage.Parent).VertScrollBar.Position);
    end;
   if CurrentRVMLObject is TRule then
    begin
     TRule(CurrentRVMLObject).DrawArrows(
      TRule(CurrentRVMLObject).RVMLImage.Canvas,
       TScrollBox(TRule(CurrentRVMLObject).RVMLImage.Parent).HorzScrollBar.Position,
       TScrollBox(TRule(CurrentRVMLObject).RVMLImage.Parent).VertScrollBar.Position);
    end;
  end;    }
     if fUpadate<>'' then
      begin
       TTimer(Sender).Enabled:=False;
        if MMessageBox(1,1,'0='+LS('New version of software is awailable:')+' '+fUpadate+#10+
          '$000E9A0E='+LS('Do Update?'))=0 then
            begin
              try
               ShellExecute(Handle, 'open',
                PWideChar(ExtractFileDir(Application.ExeName)+'\PKBD_uc.exe'), nil, nil, SW_SHOWNORMAL);
               Application.Terminate;
              except
               MMessageBox(2,0,'255=Извините, модуль обновления не обнаружен, но Вы можете самостоятельно скачать обновление программы с нашего сайта');
              end;
            end
           else
            begin
             //reg

            Self.Caption:=Application.Title;
            if FileExists(ExtractFileDir(Application.ExeName)+'/tmp.exe') then
             DeleteFile(ExtractFileDir(Application.ExeName)+'/tmp.exe');
            end;
       end;
 TTimer(Sender).Tag:=TTimer(Sender).Tag+1;
 if TTimer(Sender).Tag=30 then
  begin
   TTimer(Sender).Enabled:=False;
   CloseHandle(TH1);
  end;
end;

procedure TMainForm.ToolBar1DragOver(Sender, Source: TObject; X, Y: Integer;
  State: TDragState; var Accept: Boolean);
begin
  if tmPSO1<>nil then
   begin
    tmPSO1.Free;
    tmPSO1:=nil;
    tmPSO2.Free;
    tmPSO2:=nil;
    tmPSO3.Free;
    tmPSO3:=nil;
    tmPSO4.Free;
    tmPSO4:=nil;
   end;
end;

procedure TMainForm.ToolButton10Click(Sender: TObject);
var
 K : TKnowledgeBase;
 tmTs : TStringList;
 i : Integer;
begin
 //rule-base reasoning
try
 begin
 if KBList.Count>0 then
 try
   RzPageControl1.ActivePageIndex:=1;
   Application.CreateForm(TRBRForm, RBRForm);
   if RBRForm.ComboBox1.Items.Count=0 then RBRForm.Free
    else
     begin
       if TreeView1.Selected<>nil then
        begin
         K:=GetKBForNode(TreeView1.Selected);
         if K<>nil then
          begin
           K.ShowCErrors(RzListView2);
           if RzListView2.Items.Count>0 then
            begin
             tmTs:=TStringList.Create;
             for i := 0 to K.CErrors.Count-1 do
              tmTs.Add('255='+K.CErrors.Strings[i]);
             MMessageBox(1,0,'0='+
      //        MainForm.LS('The violations of the knowledge base consistency are detected')+': '+
      //        #10+tmTs.Text);
              IntToStr(tmTs.Count)+
               MainForm.LS('The violations of the knowledge base consistency are detected'));
             RzPanel8.Visible:=True;
            end
           else
            begin
             RBRForm.Tag:=4;   //for rules (rbr)
             RBRForm.ShowModal;

             RebulidImagesOnTree(TreeView1);
             end;
        end;
       end;
     end;
 except
  on e:Exception do
   ShowMessage(e.Message);
 end;
 TreeView1Click(TreeView1);
 end
except
end;
end;

procedure TMainForm.ToolButton11Click(Sender: TObject);
var
 nN : TTreeNode;
 tmObj : TTmObj;
// tmKB1 : TKnowledgeBase;
 i : Integer;
 a : Boolean;
 KB44 : TKnowledgeBase;
// j : Integer;
 s1,s2 : string;
begin
 i:=-1;
 if (pos('ны для фактов',TreeView1.Selected.Text)>0) then i:=10;
 if (pos('plates',TreeView1.Selected.Text)>0) then i:=10;

 if (TObject(TreeView1.Selected.Data) is TTemplate)
   then i:=0; //templates

 if (pos('ты',TreeView1.Selected.Text)>0)then i:=11;
 if (pos('acts',TreeView1.Selected.Text)>0)then i:=11;
 if (TObject(TreeView1.Selected.Data) is TFact)
   then i:=1; //facts

 if (pos('ны для правил',TreeView1.Selected.Text)>0)then i:=12;
 if (pos('eneral',TreeView1.Selected.Text)>0)then i:=12;
 if (TObject(TreeView1.Selected.Data) is TGRule)
   then i:=2; //TGRules

 if (pos('Правила',TreeView1.Selected.Text)>0)then i:=13;
 if (pos('Rules',TreeView1.Selected.Text)>0)then i:=13;
 if (TObject(TreeView1.Selected.Data) is TRule)
   then i:=3; //rules

 if i>-1 then
    begin
     s1:=IntToStr(SecondOfTheYear(Now));
     s2:=s1+'='+
      STDIClass.LoadSingleString('New package',LangLocaleDir+LangPrefix+'012.lan');
     tmObj:=TTmObj.Create;
     tmObj.ID:=s1;
     tmObj.Name:=
      STDIClass.LoadSingleString('New package',LangLocaleDir+LangPrefix+'012.lan');
     tmObj.ID2:=i;
     if i<10 then
      begin
       if TObject(TreeView1.Selected.Parent.Data) is TTmObj then
        tmObj.ID_Root:=TTmObj(TreeView1.Selected.Parent.Data).ID;
       nN:=TreeView1.Items.AddChildObject(TreeView1.Selected.Parent,
        STDIClass.LoadSingleString('New package',LangLocaleDir+LangPrefix+'012.lan')
         ,tmObj);
      end
       else
        begin
         if TObject(TreeView1.Selected.Data) is TTmObj then
          tmObj.ID_Root:=TTmObj(TreeView1.Selected.Data).ID;
         nN:=TreeView1.Items.AddChildObject(TreeView1.Selected,
          STDIClass.LoadSingleString('New package',LangLocaleDir+LangPrefix+'012.lan')
           ,tmObj);
        end;
     nN.ImageIndex:=17;
//     TreeView1.tag:=i;

    // ShowMessage(DateTimeToStr(Now));
     KB44:=GetKBForNode(nN);
     if KB44<>nil then
       case i of
         0,10:begin //for templates
            KB44.TempPackageList.AddObject(s2,tmObj);
         end;
         1,11:begin //for facts
            KB44.FactPackageList.AddObject(s2,tmObj);
         end;
         2,12:begin //for grules
            KB44.GRulePackageList.AddObject(s2,tmObj);
         end;
         3,13:begin //for rules
            KB44.RulePackageList.AddObject(s2,tmObj);
         end;
       end; //end case
     KB44.SortPackages;

//     TreeView1.one
//     OnEditingNode(Self,nN,a);
     a:=nN.EditText;
//   nN.EndEdit(True);
    end;
end;

procedure TMainForm.ToolButton12Click(Sender: TObject);
begin
try
 //case retrieval + decision-making
 begin
 if KBList.Count>0 then
 try
// Application.CreateForm(TaddFact, addFact);
 Application.CreateForm(TAddFactForm2, AddFactForm2);
 if AddFactForm2.ComboBox1.Items.Count=0 then AddFactForm2.Free
  else
   begin
     AddFactForm2.Tag:=3;
     AddFactForm2.ShowModal;
     RebulidImagesOnTree(TreeView1);
   end;

 except
  on e:Exception do
   ShowMessage(e.Message);
 end;
 TreeView1Click(TreeView1);
 end
except
end;
end;

procedure TMainForm.ToolButton13Click(Sender: TObject);
begin
//try
// if (MainForm.Tag=0)or
//  ((MainForm.Tag<>0)and(KBList.Count<=675-673)and
//   (TKnowledgeBase(KBList.Items[0]).Rules.Count<=792-782)) then
// begin
 if KBList.Count>0 then
 try
  Application.CreateForm(TAddGRuleForm, AddGRuleForm);
   if AddGRuleForm.ComboBox1.Items.Count=0 then AddGRuleForm.Free
    else
     begin
       AddGRuleForm.Tag:=1;
       AddGRuleForm.G1:=nil;
       AddGRuleForm.ShowModal;
       RebulidImagesOnTree(TreeView1);
     end;
 except
  on e:Exception do
   ShowMessage(e.Message);
 end;
 TreeView1Click(TreeView1);

// end
//  else
//  MMessageBox(1,0,'0=В режиме ознакомления можно создать только ДЕСЯТЬ правил');
//except
//end;
end;

procedure TMainForm.ToolButton17Click(Sender: TObject);
begin
 N29Click(N29);
end;

procedure TMainForm.ToolButton18Click(Sender: TObject);
var
 nF : TESDescriptionForm;
begin
  if MMessageBox(1,1,'0='+
    LS('Create the expert system for this task')+' ('+
     TTask(TreeView1.Selected.Data).Name+')'
//    STDIClass.LoadSingleString('Save the knowledge base',LangLocaleDir+LangPrefix+'012.lan')
//    +': '+
//    TKnowledgeBase(TreeView1.Selected.Data).Name
     +'?')=0  then
   begin
    Application.CreateForm(TESDescriptionForm, nF);
    nF.T1:=TTask(TreeView1.Selected.Data);
    nF.ShowModal;
   end;
end;

procedure TMainForm.ToolButton19Click(Sender: TObject);
begin
 if TObject(TreeView1.Selected.Data) is TGRule then
  TGRule(TreeView1.Selected.Data).Order;
 if TObject(TreeView1.Selected.Data) is TRule then
  TRule(TreeView1.Selected.Data).Order;
 TreeView1.OnClick(TreeView1);
end;

procedure TMainForm.ToolButton1Click(Sender: TObject);
begin
 N16Click(N16);
end;

procedure TMainForm.ToolButton20Click(Sender: TObject);
begin
 N29Click(N29);
end;

procedure TMainForm.ToolButton20MouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin
 ReloadHelpMessage(ScrollBox3,TWinControl(Sender).Tag);
end;

procedure TMainForm.ToolButton21Click(Sender: TObject);
begin
 if TObject(TreeView1.Selected.Data) is TGRule then
  TGRule(TreeView1.Selected.Data).Order;
 if TObject(TreeView1.Selected.Data) is TRule then
  TRule(TreeView1.Selected.Data).Order;
 TreeView1.OnClick(TreeView1);
end;

procedure TMainForm.ToolButton2Click(Sender: TObject);
begin
 N19Click(N19);
end;

procedure TMainForm.ToolButton9Click(Sender: TObject);
begin
 N7Click(Self);
 MainForm.RebulidImagesOnTree(MainForm.TreeView1);
end;

procedure TMainForm.DeleteItemClick(Sender: TObject);
function GetRootPackage(N:TTreeNode):TTreeNode;
begin
 while N.Data<>nil do
  N:=N.Parent;
 Result:=N;
end;

var
 pN : TTreeNode;
 KB1  : TKnowledgeBase;
 T1 : TTemplate;
 s  : String;
 s1,s2  : String;
 tmTs,tmTs1 : TStringList;
 i  : Integer;
begin
 if TreeView1.Selected.Data<>nil then
  begin
  s:='0='+
   STDIClass.LoadSingleString('Delete',LangLocaleDir+LangPrefix+'012.lan')
   +'?';
  s2:=STDIClass.LoadSingleString('Deletion',LangLocaleDir+LangPrefix+'012.lan')+' ';
  if TObject(TreeView1.Selected.Data) is TKnowledgeBase then
   begin
    s:='0='+
     STDIClass.LoadSingleString('Close the knowledge base?',LangLocaleDir+LangPrefix+'012.lan')
      ;
    s2:=
     STDIClass.LoadSingleString('Close',LangLocaleDir+LangPrefix+'012.lan')
     +' ';
   end;

  if MMessageBox(1,1,s)=0
   then
    begin
     pN:=TreeView1.Selected.Parent;

     s:='';
     if TObject(TreeView1.Selected.Data) is TKnowledgeBase then
      begin
       S:='K';
       s1:='базы знаний: '+TKnowledgeBase(TreeView1.Selected.Data).Name;
      end;
     if TObject(TreeView1.Selected.Data) is TTmObj then
      begin
       S:='A';
       s1:='папки: '+TreeView1.Selected.Text;
      end;
     if TObject(TreeView1.Selected.Data) is TRule then
      begin
       s:='R';
       s1:='правила: '+TRule(TreeView1.Selected.Data).Name;
      end;
     if TObject(TreeView1.Selected.Data) is TTemplate then
      begin
       s:='T';
       s1:='образца/шаблона: '+TTemplate(TreeView1.Selected.Data).Name;
      end;
     if TObject(TreeView1.Selected.Data) is TGRule then
      begin
       s:='G';
       s1:='образца/шаблона правила: '+TGRule(TreeView1.Selected.Data).Name;
      end;
     if TObject(TreeView1.Selected.Data) is TFact then
      begin
       s:='F';
       s1:='факта: '+TFact(TreeView1.Selected.Data).Name;
      end;
     if TObject(TreeView1.Selected.Data) is TSlot then
      begin
       s:='S';
       s1:='свойства/слота: '+TSlot(TreeView1.Selected.Data).Name;
      end;
     if TObject(TreeView1.Selected.Data) is TGlobalVar then
      begin
       s:='V';
       s1:='переменной: '+TGlobalVar(TreeView1.Selected.Data).Name;
      end;
     if TObject(TreeView1.Selected.Data) is TTask then
      begin
       s:='P';
       s1:='задачи: '+TTask(TreeView1.Selected.Data).ID;
      end;
     MainForm.MakeDump(s2+s1,5);

     case s[1] of
      'K':begin
        for i:=0 to KBList.Count-1 do
         if TKnowledgeBase(TreeView1.Selected.Data).ID=
          TKnowledgeBase(KBList.Items[i]).ID then
           begin
//            if MMessageBox(1,1,'0=Сохранить изменения?')=0
//             then
//              begin
               N19Click(N19);
{
               if TKnowledgeBase(TreeView1.Selected.Data).FileName='' then
                begin
                 SaveDialog1.Title:=Application.Title+': Сохранение базы знаний';
                 SaveDialog1.Filter:='EKB files |*.ekb|Все файлы |*.*';
                 SaveDialog1.InitialDir:=ExtractFileDir(Application.ExeName)+'.\Data';
                 SaveDialog1.FileName:='';

                if SaveDialog1.Execute() then
                 if (SaveDialog1.FileName<>'') then
                 begin
                  if pos('.ekb',SaveDialog1.FileName)=0 then
                   SaveDialog1.FileName:=SaveDialog1.FileName+'.ekb';
                  TKnowledgeBase(TreeView1.Selected.Data).FileName:=
                   SaveDialog1.FileName;
                  XmlSave.GXMLStrSF(TKnowledgeBase(TreeView1.Selected.Data).FileName,
                   TKnowledgeBase(TreeView1.Selected.Data));
                 end;
                end
               else
                XmlSave.GXMLStrSF(TKnowledgeBase(TreeView1.Selected.Data).FileName,
                 TKnowledgeBase(TreeView1.Selected.Data));
}
//              end;
            KBList.Delete(i);
            RzPanel8.Visible:=False;
            RzSplitter3.Percent:=100;
            RzSplitter3.PercentMin:=100;
            Break;
           end;

        TreeView1.Selected.Delete;
        pN.Text:=PutChildCount(pN);
        TreeView1.Selected:=pN;
//        TKnowledgeBase(TreeView1.Selected.Data).Destroy;
        TreeView1Click(TreeView1);
       end;
      'A':begin
        KB1:=GetKBForNode(TreeView1.Selected);
        if MMessageBox(1,1,'0=Удалить папку и все ее содержимое?')=0
         then
          begin
           case TTmObj(TreeView1.Selected.Data).ID2 of
            0:begin
             for i := KB1.Templates.Count-1 downto 0 do
              if TTemplate(KB1.Templates.Items[i]).PackageName=
               TTmObj(TreeView1.Selected.Data).ID then
                KB1.Templates.Delete(i);
              KB1.TempPackageList.Delete(
               KB1.TempPackageList.IndexOfName(TTmObj(TreeView1.Selected.Data).ID));
            end;
            1:begin
             for i := KB1.Facts.Count-1 downto 0 do
              if TFact(KB1.Facts.Items[i]).PackageName=
               TTmObj(TreeView1.Selected.Data).ID then
                KB1.Facts.Delete(i);
              KB1.FactPackageList.Delete(
               KB1.FactPackageList.IndexOfName(TTmObj(TreeView1.Selected.Data).ID));
            end;
            2:begin
             for i := KB1.GRules.Count-1 downto 0 do
              if TGRule(KB1.GRules.Items[i]).PackageName=
               TTmObj(TreeView1.Selected.Data).ID then
                KB1.GRules.Delete(i);
              KB1.GRulePackageList.Delete(
               KB1.GRulePackageList.IndexOfName(TTmObj(TreeView1.Selected.Data).ID));
            end;
            3:begin
             for i := KB1.Rules.Count-1 downto 0 do
              if TRule(KB1.Rules.Items[i]).PackageName=
               TTmObj(TreeView1.Selected.Data).ID then
                KB1.Rules.Delete(i);
              KB1.RulePackageList.Delete(
               KB1.RulePackageList.IndexOfName(TTmObj(TreeView1.Selected.Data).ID));
            end;
           end; //end case
           TreeView1.Selected.Delete;
           pN.Text:=PutChildCount(pN);
           TreeView1.Selected:=pN;
           TreeView1Click(TreeView1);
          end;
      end;
      'R','F','V','P','G':begin
        KB1:=GetKBForNode(TreeView1.Selected);
        KB1.Delete(S,pN.IndexOf(TreeView1.Selected));
//        MainForm.LoadTree(KBList,MainForm.TreeView1);

        if (TObject(pN.Data) is TTmObj)//or(pN.Data=nil)
         then pN:=GetRootPackage(pN);

        TreeView1.Selected.Delete;

        pN.Text:=PutChildCount(pN);
        TreeView1.Selected:=pN;
        TreeView1Click(TreeView1);
       end;
      'T':begin
        KB1:=GetKBForNode(TreeView1.Selected);
        tmTs:=TStringList.Create;
        tmTs.AddStrings(KB1.IndexesOfGUT(TTemplate(TreeView1.Selected.Data)));
        tmTs.AddStrings(KB1.IndexesOfRUT(TTemplate(TreeView1.Selected.Data)));
        tmTs.AddStrings(KB1.IndexesOfFUT(TTemplate(TreeView1.Selected.Data)));
        if tmTs.Count=0 then
         begin
          KB1.Delete(S,pN.IndexOf(TreeView1.Selected));
          TreeView1.Selected.Delete;
          if (TObject(pN.Data) is TTmObj)//or(pN.Data=nil)
           then pN:=GetRootPackage(pN);
          pN.Text:=PutChildCount(pN);
          TreeView1.Selected:=pN;
          TreeView1Click(TreeView1);
         end
         else
          begin

           tmTs1:=TStringList.Create;
           for i := 0 to tmTs.Count-1 do
            tmTs1.Add('255='+tmTs.Strings[i]);

           MMessageBox(1,0,'0=Удалить образец/шаблон нельзя, так как он используется в фактах и/или правилах: '+#10+
//            '0='+s)
            tmTs1.Text)
            end;
       end;
      'S':begin
        T1:=TTemplate(pN.Data);
        T1.Delete(pN.IndexOf(TreeView1.Selected));
        TreeView1.Selected.Delete;
        TreeView1.Selected:=pN;
        TreeView1Click(TreeView1);
       end;
     end; //end case
     MainForm.LoadAList(MainForm.RzListView1);
    end;
  end;
end;

procedure TMainForm.doc1Click(Sender: TObject);
var
 KB44 : TKnowledgeBase;
begin
// s:=ExtractFileDir(Application.ExeName)+'/Dll/005.dll';
  try
    if TreeView1.Selected<>nil then
     begin
       KB44:=GetKBForNode(TreeView1.Selected);
       if KB44<>nil then
       try
        MsgBoxForm.RzProgressStatus1.Visible:=True;
        MsgBoxForm.RzProgressStatus1.TotalParts:=
         KB44.Rules.Count+KB44.Facts.Count+KB44.GRules.Count+
          KB44.Templates.Count;
        MsgBoxForm.RzProgressStatus1.PartsComplete:=0;
        MsgBoxForm.Timer1.Enabled:=True;
        BeginThread(nil,1024,TH_REPORT,nil,0,TID1);

        MMessageBox(0,4,'0='+MainForm.LS('Create a report'));
       except
       end;
     end;
  except
   MMessageBox(1,0,'0='+MainForm.LS('Please, select the knowledge base'))
  end;
end;

procedure TMainForm.Edit1Click(Sender: TObject);
begin
 if TreeView1.Selected<>nil then
  RVMLElementDBClick(ScrollBox4);
end;

procedure TMainForm.EditItemClick(Sender: TObject);
var
// pN : TTreeNode;
 a : Boolean;
// s  : String;
// tmTs : TStringList;
 i,j  : Integer;
 KB1  : TKnowledgeBase;
begin
if TToolButton(Sender).Enabled then
begin
 if TreeView1.Selected.Data<>nil then
  begin
   if TObject(TreeView1.Selected.Data) is TKnowledgeBase then
    begin
     Application.CreateForm(TaddKB, addKB);

     addKB.KB1:=TKnowledgeBase(TreeView1.Selected.Data);
     addKB.Tag:=1;
     addKB.ShowModal;
     TreeView1Click(TreeView1);
    end;

   if TObject(TreeView1.Selected.Data) is TTemplate then
    begin
     try
      Application.CreateForm(TAddTempForm, AddTempForm);
      //copy
      KB.CopyTemplate(1,
       TTemplate(TreeView1.Selected.Data),AddTempForm.T1
        );
//      AddTempForm.T1:=TTemplate(TreeView1.Selected.Data);
      AddTempForm.Tag:=0;    //edit temp
      AddTempForm.ShowModal;

      RebulidImagesOnTree(TreeView1);
     except
      on e:Exception do
       ShowMessage(e.Message);
     end;
     TreeView1Click(TreeView1);
    end;

   if TObject(TreeView1.Selected.Data) is TGRule then
    begin
     try
      Application.CreateForm(TAddGRuleForm, AddGRuleForm);
      KB.CopyGRule(1,
       TGRule(TreeView1.Selected.Data),AddGRuleForm.G1
        );
//      AddGRuleForm.G1:=TGRule(TreeView1.Selected.Data);
      AddGRuleForm.Tag:=0;    //edit grule
      AddGRuleForm.ShowModal;

      RebulidImagesOnTree(TreeView1);
     except
      on e:Exception do
       ShowMessage(e.Message);
     end;
     TreeView1Click(TreeView1);
    end;
{     pN:=TreeView1.Selected.Parent;
     KB1:=TKnowledgeBase(pN.Parent.Data);
     tmTs:=TStringList.Create;
     tmTs.AddStrings(KB1.IndexesOfRUT(TTemplate(TreeView1.Selected.Data)));
     tmTs.AddStrings(KB1.IndexesOfFUT(TTemplate(TreeView1.Selected.Data)));

     if tmTs.Count=0 then i:=0;

      if MMessageBox(1,1,'0=Изменение образца/шаблона вызовет измение следующих фактов и правил: '+#10+
       '255='+tmTs.Text+#10+
       '0=Продолжить?')=0 then i:=0 else i:=-1;
        if i=0 then
         begin
//       tmTs:=KB1.IndexesOfFUT(TTemplate(TreeView1.Selected.Data));
//       if tmTs.Count=0 then
//        begin

          Application.CreateForm(TaddPattern, addPattern);

          addPattern.T1:=TTemplate(TreeView1.Selected.Data);
          addPattern.Tag:=1;
          addPattern.ShowModal;
          TreeView1Click(TreeView1);
         end;
//        end
//           else
//            begin
//             s:='';
//             for i:=0 to tmTs.Count-1 do
//              s:=s+TRule(KB1.Facts.Items[StrToInt(tmTs.Strings[i])]).ID+#13#10;
//             Application.MessageBox(
//              PAnsiChar('Изменить образец/шаблон нельзя, так как он используется в фактах: '+#13#10+s+'.'),
//               PAnsiChar(' Внимание!'),MB_OK);
//            end;
//         end
//         else
 //         begin
 //          s:='';
//           for i:=0 to tmTs.Count-1 do
//            s:=s+TRule(KB1.Rules.Items[StrToInt(tmTs.Strings[i])]).ID+#13#10;
//           Application.MessageBox(
//            PAnsiChar('Изменить образец/шаблон нельзя, так как он используется в правилах: '+#13#10+s+'.'),
 //            PAnsiChar(' Внимание!'),MB_OK);
//          end;
    end;   }
   if TObject(TreeView1.Selected.Data) is TRule then
    begin
     Application.CreateForm(TAddRuleForm2, AddRuleForm2);

//     AddRuleForm2.R1:=
//      TRule(TreeView1.Selected.Data);

     AddRuleForm2.Tag:=0; //edit mode

     KB1:= GetKBForNode(TreeView1.Selected);
     KB1.CopyRule(1,
       TRule(TreeView1.Selected.Data),AddRuleForm2.R1
        );

     j:=KB1.IndexOfGRule(AddRuleForm2.R1);
     if j>-1 then
      AddRuleForm2.G1:=TGRule(KB1.GRules.Items[j]);

     for i := 0 to AddRuleForm2.ComboBox1.Items.Count-1 do
      if AddRuleForm2.ComboBox1.Items[i]=
       KB1.Name then
        begin
         AddRuleForm2.ComboBox1.ItemIndex:=i;
         Break;
        end;
     AddRuleForm2.RzPageControl1.ActivePageIndex:=1;
     AddRuleForm2.ShowModal;
     TreeView1Click(TreeView1);
    end;

   if TObject(TreeView1.Selected.Data) is TFact then
    begin
     Application.CreateForm(TAddFactForm2, AddFactForm2);

     AddFactForm2.Tag:=0;
//     AddFactForm2.F1:=TFact(TreeView1.Selected.Data);
     KB1:= GetKBForNode(TreeView1.Selected);
     //copy
     KB1.CopyFact(1,
       TFact(TreeView1.Selected.Data),AddFactForm2.F1
        );
     j:=KB1.IndexOfTemplate(AddFactForm2.F1);

     if j>-1 then
      AddFactForm2.T1:=TTemplate(KB1.Templates.Items[j]);

     AddFactForm2.RzPageControl1.ActivePageIndex:=1;
     AddFactForm2.ShowModal;
     TreeView1Click(TreeView1);
    end;

   if TObject(TreeView1.Selected.Data) is TTmObj then
    begin
     a:=True;
     if UserMode=1 then
      TreeView1.Selected.EditText;
    end;

   if TObject(TreeView1.Selected.Data) is TTask then
    begin
     KB1:= GetKBForNode(TreeView1.Selected);
     if KB1.Kind=0 then
      begin  //for rule base
       Application.CreateForm(TRBRForm, RBRForm);
       RBRForm.Tag:=4;   //for rules (rbr)
       RBRForm.ShowModal;
       RebulidImagesOnTree(TreeView1);
      end
     else //for case base
      begin
       Application.CreateForm(TAddFactForm2, AddFactForm2);
       AddFactForm2.Tag:=3;
       AddFactForm2.T3:=TTask(TreeView1.Selected.Data);
       AddFactForm2.ShowModal;
      end;
     TreeView1Click(TreeView1);
    end;
{
   if TObject(TreeView1.Selected.Data) is TSlot then
    begin
     TreeView1.Selected:=TreeView1.Selected.Parent;
     EditItemClick(Sender);
    end;
}
  end;
end;
end;

procedure TMainForm.English1Click(Sender: TObject);
begin
 LangPrefix:='en/';
 LF1:=LangLocaleDir+LangPrefix+'012.lan';

 LoadHelpMessages(HelpMessages,
  LangLocaleDir+LangPrefix+'011.lan');
 STDIClass.LoadLocalLang(Self,LangLocaleDir+LangPrefix+'013.lan');
 TMenuItem(Sender).Checked:=True;
 N36.Checked:=False;

 TabSheet1.Caption:=STDIClass.LoadSingleString('TabSheet1c',LangLocaleDir+LangPrefix+'013.lan');
 TabSheet2.Caption:=STDIClass.LoadSingleString('TabSheet2c',LangLocaleDir+LangPrefix+'013.lan');
 TabSheet3.Caption:=STDIClass.LoadSingleString('TabSheet3c',LangLocaleDir+LangPrefix+'013.lan');
 TabSheet4.Caption:=STDIClass.LoadSingleString('TabSheet4c',LangLocaleDir+LangPrefix+'013.lan');
 TabSheet5.Caption:=STDIClass.LoadSingleString('TabSheet5c',LangLocaleDir+LangPrefix+'013.lan');

 RzGroupBox1.Caption:=STDIClass.LoadSingleString('RzGroupBox1c',LangLocaleDir+LangPrefix+'013.lan');
 TreeView1.Items[0].Text:=StringReplace(TreeView1.Items[0].Text,
  'Базы знаний (проекты)','Knowledge bases (projects)',[rfReplaceAll]);
end;

procedure TMainForm.NewTClick(Sender: TObject);
begin
try
// if (MainForm.Tag=0)or
//  ((MainForm.Tag<>0)and(KBList.Count<=675-674)and
//   (TKnowledgeBase(KBList.Items[0]).Templates.Count<=782-777)) then
 begin
 if KBList.Count>0 then
 try
  Application.CreateForm(TAddTempForm, AddTempForm);

  AddTempForm.Tag:=1;    //add temp
  AddTempForm.ShowModal;

  RebulidImagesOnTree(TreeView1);
 except
  on e:Exception do
   ShowMessage(e.Message);
 end;
 TreeView1Click(TreeView1);

 end
//  else
//  MMessageBox(1,0,'0=В режиме ознакомления можно создать только ПЯТЬ шаблонов');
except
end;
end;

procedure TMainForm.RzBitBtn1Click(Sender: TObject);
begin
 N34Click(N34);
end;

procedure TMainForm.RzBitBtn2Click(Sender: TObject);
var
 i,j,k,j1 : Integer;
 WC : TScrollBox;
 tmP,tmP1,tmP2 : TRzPanel;

 F : TFact;
// tmSlot : TSlot;
 T1 : TTemplate;
 tmTs : TStringList;
 tmState : TRMState;
begin
 //clear facts
 KB.Facts.Clear;

 //add new facts
 WC:=ScrollBox5;
 for i := 0 to WC.ControlCount-1 do
  begin
   tmP1:=TRzPanel(WC.Controls[i]);
   if TCheckBox(TRzPanel(tmP1.Controls[0]).Controls[0]).Checked then
    begin //template is selected
     //add facts
     //---------------------------------------------------------------
     for k := 1 to tmP1.ComponentCount-1 do
      begin
       tmP:=TRzPanel(tmP1.Components[k]);

       T1:=TTemplate(KB.Templates.Items[tmP.Tag]);
       F:=TFact.Create;
       F.Init;
       F.Name:=T1.Name;
       F.ShortName:=T1.ShortName;
       F.GetSlotsFrom(T1);
       if tmP.ComponentCount>0 then
       for j1 := 1 to tmP.ComponentCount-1 do
        begin
         tmP2:=TRzPanel(tmP.Components[j1]);

         for j := 1 to tmP2.ComponentCount-1 do
          begin
            if tmP2.Components[j] is TComboBox then
             begin
              if tmP2.Components[j].Tag<1000 then
               begin
                TSlot(F.Slots[tmP2.Components[j].Tag]).Value:=
                 Trim(TComboBox(tmP2.Components[j]).Text)
               end
                 else  //use the constaraint field for store information about weigth
                  begin
                   TSlot(F.Slots[tmP2.Components[j].Tag-1000]).Constraint:=
                    Trim(TComboBox(tmP2.Components[j]).Text);
                  end;
             end
           else   //for edit
            begin
              if tmP2.Components[j].Tag<1000 then
               begin
                TSlot(F.Slots[tmP2.Components[j].Tag]).Value:=
                 Trim(TEdit(tmP2.Components[j]).Text)
               end
                 else  //use the constaraint field for store information about weigth
                  begin
                   TSlot(F.Slots[tmP2.Components[j].Tag-1000]).Constraint:=
                    Trim(TEdit(tmP2.Components[j]).Text);
                  end;
            end;
          end;

       end;
       F.ID:=KB.NewID('F');
       F.Mode:='1';
       KB.Facts.Add(F);
      end;
     //---------------------------------------------------------------

    end;
  end;

 //run clips in silent mode
 //-------------------------------------------------------------------
 //----------------------------------------------------------
   try
    tmTs:=TStringList.Create;

    tmState:=TRMState.Create;
    tmState.Init;
    RRPManager:=TRRPManager.Create;
    RRPManager.Init;

    if RRPManager.States.Count=0 then
     RRPManager.States.Add(tmState);

   //*******************************************************************
    //******************** ввод фактов и правил в рабочую память ********
    //*******************************************************************
    if (DllIndex<>-1)and(DllList.Count>0) then
     tmTs.Text:=KB.
      GetDescriptionOnKBLanguage(DllList.Names[DllIndex]);
    tmTs.SaveToFile(ExtractFileDir(Application.ExeName)+'\Data\rrp.tmp');

    tmTs.Clear;
    tmTs.Add(ExtractFileDir(Application.ExeName)+'\Data\rrp.tmp');
    RRPManager.KB:=TRRPKnowledgeBase.Create;
    RRPManager.KB.Init;
    i:=RRPManager.KB.LoadKnowledgeBaseViaDll(tmTs,3);  //load knowledge bases to clips
   if i<>-1 then
    begin
    i:=RRPManager.KB.RunCLIPSViaDll(ExtractFileDir(Application.ExeName)+
     '\Data\rrp_oudata'); //run clips
    end;
   except
   end;
 //-------------------------------------------------------------------
 ScrollBox2.Tag:=1;
 ScrollBox6.Tag:=1;
 RzPageControl3.ActivePage:=RzTabSheet2;
end;

procedure TMainForm.RzButton2Click(Sender: TObject);
begin
 if TreeView1.Selected<>nil then
  GetKBForNode(TreeView1.Selected).ShowCErrors(RzListView2);
end;

procedure TMainForm.RzButton3Click(Sender: TObject);
begin
 DeleteItemClick(Self);
end;

procedure TMainForm.RzButton4Click(Sender: TObject);
begin
 EditItemClick(Self);
end;

procedure TMainForm.RzComboBox1Change(Sender: TObject);
var
 i : Integer;
begin
 RzListView3.Clear;
 RzListView3.Align:=alClient;
 if KB=nil then
  KB:=GetKBForNode(TreeView1.Selected);
 if TRzComboBox(Sender).ItemIndex=0 then
  begin  //temlpates
   for i := 0 to KB.Templates.Count-1 do
    begin
     RzListView3.AddItem(TTemplate(KB.Templates.Items[i]).Name,
      TTemplate(KB.Templates.Items[i]));
    end;
  end
 else
  begin  //rules
   for i := 0 to KB.Rules.Count-1 do
    begin
     RzListView3.AddItem(TRule(KB.Rules.Items[i]).Name,
      TRule(KB.Rules.Items[i]));
    end;
  end;
 if RzListView3.Items.Count>0 then
  begin
   RzListView3.ItemIndex:=0;
   RzListView3Click(RzListView3);
  end;
end;

procedure TMainForm.NewRClick(Sender: TObject);
begin
//try
// if (MainForm.Tag=0)or
//  ((MainForm.Tag<>0)and(KBList.Count<=675-673)and
//   (TKnowledgeBase(KBList.Items[0]).Rules.Count<=792-782)) then
// begin
 if KBList.Count>0 then
 try
  Application.CreateForm(TAddRuleForm3Unit, AddRuleForm3);
   if AddRuleForm3.ComboBox1.Items.Count=0 then AddRuleForm3.Free
    else
     begin
       AddRuleForm3.Tag:=1;
       AddRuleForm3.ShowModal;
       RebulidImagesOnTree(TreeView1);
     end;
 except
  on e:Exception do
   ShowMessage(e.Message);
 end;
 TreeView1Click(TreeView1);

// end
//  else
//  MMessageBox(1,0,'0=В режиме ознакомления можно создать только ДЕСЯТЬ правил');
//except
//end;
end;

procedure TMainForm.NewFClick(Sender: TObject);
begin
try
// if (MainForm.Tag=0)or
//  ((MainForm.Tag<>0)and(KBList.Count<=675-674)and
//   (TKnowledgeBase(KBList.Items[0]).Facts.Count<=782-772)) then
 begin
 if KBList.Count>0 then
 try
// Application.CreateForm(TaddFact, addFact);
 Application.CreateForm(TAddFactForm2, AddFactForm2);

 AddFactForm2.Tag:=1;
 AddFactForm2.ShowModal;
 RebulidImagesOnTree(TreeView1);
 except
  on e:Exception do
   ShowMessage(e.Message);
 end;
 TreeView1Click(TreeView1);

 end
//  else
//   MMessageBox(1,0,'0=В режиме ознакомления можно создать только ДЕСЯТЬ фактов');
except
end;
end;

procedure TMainForm.ScrollBox1MouseMove(Sender: TObject;
  Shift: TShiftState; X, Y: Integer);
begin
 try
  SetFocusedControl(TScrollBox(Sender));
  ReloadHelpMessage(ScrollBox3,TWinControl(Sender).Tag);
 except
 end; 
end;

procedure TMainForm.ScrollBox1MouseWheelDown(Sender: TObject;
  Shift: TShiftState; MousePos: TPoint; var Handled: Boolean);
var
 m  : Integer;
begin
if Sender is TScrollBox then
begin
 m:=15;
 if TScrollBox(Sender).VertScrollBar.Position+m>
  TScrollBox(Sender).VertScrollBar.Range then
  m:=m-abs(TScrollBox(Sender).VertScrollBar.Range-
   TScrollBox(Sender).VertScrollBar.Position-m);
 TScrollBox(Sender).VertScrollBar.Position:=
  TScrollBox(Sender).VertScrollBar.Position+m;
 end;
end;


procedure TMainForm.ScrollBox1MouseWheelUp(Sender: TObject;
  Shift: TShiftState; MousePos: TPoint; var Handled: Boolean);
var
 m  : Integer;
begin
if Sender is TScrollBox then
begin
 m:=15;
 if TScrollBox(Sender).VertScrollBar.Position-m<0 then
  m:=m-abs(TScrollBox(Sender).VertScrollBar.Position-m);
  TScrollBox(Sender).VertScrollBar.Position:=
   TScrollBox(Sender).VertScrollBar.Position-m;
end;
end;

procedure TMainForm.RVMLImageDragDrop(Sender, Source: TObject; X, Y: Integer);
var
 x1,y1 : Integer;
begin
 if Source is TImage then // Если перетаскиваем компонент Image то
  begin
    x1:=x;
    y1:=y;
    if TObject(TreeView1.Selected.Data) is TTemplate then
     begin
      x1:=TTemplate(TreeView1.Selected.Data).RVMLImage.Left+x;
      y1:=TTemplate(TreeView1.Selected.Data).RVMLImage.Top+y;
      TTemplate(TreeView1.Selected.Data).DrawParams.Values['x']:=IntToStr(x1);
      TTemplate(TreeView1.Selected.Data).DrawParams.Values['y']:=IntToStr(y1);
     end;
    if TObject(TreeView1.Selected.Data) is TFact then
     begin
      x1:=TFact(TreeView1.Selected.Data).RVMLImage.Left+x;
      y1:=TFact(TreeView1.Selected.Data).RVMLImage.Top+y;
      TFact(TreeView1.Selected.Data).DrawParams.Values['x']:=IntToStr(x1);
      TFact(TreeView1.Selected.Data).DrawParams.Values['y']:=IntToStr(y1);
     end;

    if TObject(TreeView1.Selected.Data) is TGRule then
    begin
     TGRule(TreeView1.Selected.Data).DrawArrows(
      TGRule(TreeView1.Selected.Data).RVMLImage.Canvas,
       TScrollBox(TGRule(TreeView1.Selected.Data).RVMLImage.Parent).HorzScrollBar.Position,
       TScrollBox(TGRule(TreeView1.Selected.Data).RVMLImage.Parent).VertScrollBar.Position);
    end;
    if TObject(TreeView1.Selected.Data) is TRule then
    begin
     TRule(TreeView1.Selected.Data).DrawArrows(
      TRule(TreeView1.Selected.Data).RVMLImage.Canvas,
       TScrollBox(TRule(TreeView1.Selected.Data).RVMLImage.Parent).HorzScrollBar.Position,
       TScrollBox(TRule(TreeView1.Selected.Data).RVMLImage.Parent).VertScrollBar.Position);
    end;

   TImage(Source).Left := X1; //Переместить компонент Image в координаты //курсора по X
   TImage(Source).Top := Y1; //Переместить компонент Image в координаты //курсора по Y

 //  CurrentRVMLObject:=nil;
  end;
end;

procedure TMainForm.ScrollBox4DragDrop(Sender, Source: TObject; X, Y: Integer);
var
 x1,y1 : Integer;
begin
try
 if Source is TImage then // Если перетаскиваем компонент Image то
  if TImage(Source).Tag>0 then
  begin
   X:=tmPSO1.Left;
   Y:=tmPSO1.Top;

   x1:=TImage(Source).Left;
   y1:=TImage(Source).Top;
   if TObject(CurrentRVMLObject) is TTemplate then
    begin
     TTemplate(CurrentRVMLObject).DrawParams.Values['x']:=IntToStr(x);
     TTemplate(CurrentRVMLObject).DrawParams.Values['y']:=IntToStr(y);
     TImage(Source).Left := X; //Переместить компонент Image в координаты //курсора по X
     TImage(Source).Top := Y; //Переместить компонент Image в координаты //курсора по Y
    end;
   if TObject(CurrentRVMLObject) is TFact then
    begin
     TFact(CurrentRVMLObject).DrawParams.Values['x']:=IntToStr(x);
     TFact(CurrentRVMLObject).DrawParams.Values['y']:=IntToStr(y);
     TImage(Source).Left := X; //Переместить компонент Image в координаты //курсора по X
     TImage(Source).Top := Y; //Переместить компонент Image в координаты //курсора по Y
    end;

    if TObject(TreeView1.Selected.Data) is TGRule then
    begin
     TGRule(TreeView1.Selected.Data).UpdateElementPosition(x1,y1,x,y);
     TGRule(TreeView1.Selected.Data).DrawArrows(
      TGRule(TreeView1.Selected.Data).RVMLImage.Canvas,
       TScrollBox(TGRule(TreeView1.Selected.Data).RVMLImage.Parent).HorzScrollBar.Position,
       TScrollBox(TGRule(TreeView1.Selected.Data).RVMLImage.Parent).VertScrollBar.Position
      );
    end;
    if TObject(TreeView1.Selected.Data) is TRule then
    begin
     TRule(TreeView1.Selected.Data).UpdateElementPosition(x1,y1,x,y);
     TRule(TreeView1.Selected.Data).DrawArrows(
      TRule(TreeView1.Selected.Data).RVMLImage.Canvas,
       TScrollBox(TRule(TreeView1.Selected.Data).RVMLImage.Parent).HorzScrollBar.Position,
       TScrollBox(TRule(TreeView1.Selected.Data).RVMLImage.Parent).VertScrollBar.Position
      );
    end;
//   TreeView1Click(TreeView1);
  end;
 except
 end;
 if tmPSO1<>nil then
  begin
   tmPSO1.Free;
   tmPSO1:=nil;
   tmPSO2.Free;
   tmPSO2:=nil;
   tmPSO3.Free;
   tmPSO3:=nil;
   tmPSO4.Free;
   tmPSO4:=nil;
  end;
end;

procedure TMainForm.ScrollBox4DragOver(Sender, Source: TObject; X, Y: Integer;
  State: TDragState; var Accept: Boolean);
//var
// nX, nY : Integer;
begin
   begin
     Accept:= (Source is TImage);
     if (Accept)and(TImage(Source).Tag>0) then
     try
     if tmPSO1=nil then
      begin //create a frame
       X:= TImage(Source).Left;
       Y:= TImage(Source).Top;

      //left side
 //      TImage(Source).Canvas.Brush.Color:=clYellow;
       tmPSO1:=STDIClass.AddLine(ScrollBox4,
        X,Y,TImage(Source).Height,1);
       tmPSO1.LineColor:=clRed;
       tmPSO1.ArrowLength:=0;
       tmPSO1.Width:=1;
       tmPSO1.LineWidth:=2;
       tmPSO1.OnDragOver:=tmPSODragOver;
       tmPSO1.OnDragDrop:=tmPSODragDrop;

      //top side
       tmPSO2:=STDIClass.AddLine(ScrollBox4,
        Y,X,1,TImage(Source).Width);
       tmPSO2.LineColor:=clRed;
       tmPSO2.ArrowLength:=0;
       tmPSO2.Height:=1;
       tmPSO2.LineWidth:=2;
       tmPSO2.OnDragOver:=tmPSODragOver;
       tmPSO2.OnDragDrop:=tmPSODragDrop;

      //bottom side
       tmPSO3:=STDIClass.AddLine(ScrollBox4,
        Y+TImage(Source).Height,X,
         1,TImage(Source).Width);
       tmPSO3.LineColor:=clRed;
       tmPSO3.ArrowLength:=0;
       tmPSO3.Height:=1;
       tmPSO3.LineWidth:=2;
       tmPSO3.OnDragOver:=tmPSODragOver;
       tmPSO3.OnDragDrop:=tmPSODragDrop;

      //right side
       tmPSO4:=STDIClass.AddLine(ScrollBox4,
        Y,X+TImage(Source).Width,TImage(Source).Height,1);
       tmPSO4.LineColor:=clRed;
       tmPSO4.ArrowLength:=0;
       tmPSO4.Width:=1;
       tmPSO4.LineWidth:=2;
       tmPSO4.OnDragOver:=tmPSODragOver;
       tmPSO4.OnDragDrop:=tmPSODragDrop;
      end
     else
      begin  //move a frame
       if Sender is TImage then
        begin
         X:=X+TImage(Sender).Left;
         Y:=Y+TImage(Sender).Top;
        end;
       //left side
       tmPSO1.Top:=Y;
       tmPSO1.Left:=X;
       //top side
       tmPSO2.Top:=Y;
       tmPSO2.Left:=X;
       //bottom
       tmPSO3.Top:=Y+TImage(Source).Height;
       tmPSO3.Left:=X;
       //right
       tmPSO4.Top:=Y;
       tmPSO4.Left:=X+TImage(Source).Width;
      end;
     except
      if tmPSO1<>nil then
       begin
        tmPSO1.Free;
        tmPSO1:=nil;
        tmPSO2.Free;
        tmPSO2:=nil;
        tmPSO3.Free;
        tmPSO3:=nil;
        tmPSO4.Free;
        tmPSO4:=nil;
       end;
     end;
  end;
end;

procedure TMainForm.ScrollBox4StartDrag(Sender: TObject;
  var DragObject: TDragObject);
begin
 //
end;

procedure TMainForm.CheckBox1Click(Sender: TObject);
begin
 TreeView1Click(TreeView1);
end;

procedure TMainForm.Clips1Click(Sender: TObject);
begin
 if Clips1.Checked=True then
  begin
   Clips1.Checked:=False;
   ToolButton10.Enabled:=False;
  end
 else
  begin
   Clips1.Checked:=True;
   ToolButton10.Enabled:=True;
  end;
end;

procedure TMainForm.CLIPSclp1Click(Sender: TObject);
begin
 Application.CreateForm(TExp, Exp);

 Exp.KB:=nil;
 Exp.Tag:=4;
 Exp.ShowModal;
end;

procedure TMainForm.CmapToolsCXLbeta1Click(Sender: TObject);
var
  ext : String;
  KB55 : TKnowledgeBase;
begin
 OpenDialog1.Title:=Application.Title+': '+
  STDIClass.LoadSingleString('Import templates and generalized rules from cxl',LangLocaleDir+LangPrefix+'012.lan')
  ;

 ext:='.cxl';
 OpenDialog1.FileName:='';
 OpenDialog1.Filter:='Cmap Tools files |'
   +'*'+ext+'|'
   +STDIClass.LoadSingleString('All',LangLocaleDir+LangPrefix+'012.lan')
   +'|*.*';
 OpenDialog1.InitialDir:=ExtractFileDir(Application.ExeName)+'\Models';
 if OpenDialog1.Execute then
  if OpenDialog1.FileName<>'' then
   begin
     KB55:=TKnowledgeBase.Create;
     KB55.Init;
     KB55.LoadFromCXLFile(
      ExtractFileDir(Application.ExeName)+'\Dll\cxl.i.dll',
       OpenDialog1.FileName);
     Application.CreateForm(TExp, Exp);

     Exp.KB:=KB55;
     Exp.Tag:=3;
     Exp.ShowModal;
   end
end;

procedure TMainForm.CmapToolsxmi1Click(Sender: TObject);
begin
 Application.CreateForm(TExp, Exp);

 Exp.KB:=nil;
 Exp.Tag:=6;
 Exp.ShowModal;
end;

procedure TMainForm.TreeView1DblClick(Sender: TObject);
begin
 if UserMode=1 then
  EditItemClick(Sender);
end;

procedure TMainForm.TreeView1Edited(Sender: TObject; Node: TTreeNode;
  var S: string);
var
 KB44 : TKnowledgeBase;
// i,j : Integer;
// s1 : string;
begin
// s1:=IntToStr(MilliSecondOfTheYear(Now))+'='+s;

// ShowMessage(DateTimeToStr(Now));
 KB44:=GetKBForNode(Node);
 if (KB44<>nil)and(TObject(Node.Data) is TTmObj) then
  begin
   TTmObj(Node.Data).Name:=s;
   case TTmObj(Node.Data).ID2 of
     0,10:begin //for templates
      KB44.TempPackageList.Values[TTmObj(Node.Data).ID]:=s;
     end;
     1,11:begin //for facts
      KB44.FactPackageList.Values[TTmObj(Node.Data).ID]:=s;
     end;
     2,12:begin //for grules
      KB44.GRulePackageList.Values[TTmObj(Node.Data).ID]:=s;
     end;
     3,13:begin //for rules
      KB44.RulePackageList.Values[TTmObj(Node.Data).ID]:=s;
     end;
   end; //end case
  end;
 KB44.SortPackages;
 Node.Text:=s;
 TreeView1Click(TreeView1);
end;


procedure TMainForm.TreeView1KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
// if Key=45 then EventAddBtnClick(b_01);
 if Key=46 then DeleteItemClick(DeleteItem);
// if Key=32 then EventEditBtnClick(b_03);

// if (GetKeyState(VK_CONTROL) < 0) and (GetKeyState(Ord('A') )< 0)then
//  TRzListView(Sender).SelectAll;
end;

procedure TMainForm.N20Click(Sender: TObject);
begin
 if TreeView1.Selected.Level=0 then NewKBClick(NewKB);
 if TreeView1.Selected.Level=2 then
 case TreeView1.Selected.Index of
  0: NewTClick(NewT);
  1: NewRClick(NewR);
  2: NewFClick(NewF);
 end;
end;

procedure TMainForm.N29Click(Sender: TObject);
function SavePicture (WC:TWinControl; FileName:string):Integer;
var
 i,j,maxH, new_maxH : Integer;
 bmp,bmp1 : TBitmap;
begin
try
 bmp := TBitmap.Create;
 bmp1 := TBitmap.Create;
 j:=0;
 maxH:=0;
 new_maxH:=0;
 for i := 0 to WC.ComponentCount-1 do
  if WC.Components[i] is TImage then
   begin
    if j=0 then
     begin
      bmp.Assign(TImage(WC.Components[i]).Picture.Graphic);
      bmp.Width:=bmp.Width+5;
      Inc(j);
     end
     else
      begin
       bmp1.Assign(TImage(WC.Components[i]).Picture.Graphic);
       bmp1.Mask(clRed);
       bmp.Canvas.Draw(TImage(WC.Components[i]).Left-5,
        TImage(WC.Components[i]).Top-5,
         TImage(WC.Components[i]).Picture.Graphic);
       maxH:=TImage(WC.Components[i]).Top+TImage(WC.Components[i]).Height;
       if maxH>new_maxH then new_maxH:=maxH;

      end;
   end;
  if pos('.bmp',FileName)=0 then FileName:=FileName+'.bmp';
  if new_maxH<>0 then  bmp.Height:=new_maxH-5;
  bmp.SaveToFile(FileName);
  Result:=0;
 except
  Result:=-1;
 end;
end;

begin
 CurrentRVMLObject:=TreeView1.Selected.Data;

 SavePictureDialog1.Title:=Application.Title+': Сохранение RVML-схемы';
 SavePictureDialog1.Filter:='BMP files |*.bmp|'+LS('All')+' |*.*';
 SavePictureDialog1.InitialDir:=ExtractFileDir(Application.ExeName)+'\Data';
 if (SavePictureDialog1.Execute)and(CurrentRVMLObject<>nil)  then
  if SavePictureDialog1.FileName<>'' then
    begin
     if SavePicture(ScrollBox4,SavePictureDialog1.FileName)=0 then
      MMessageBox(0,0,'0='+LS('RVML-scheme is saved'))
       else
        MMessageBox(1,0,'0=Извините, произошла ошибка');
    end;
end;

procedure TMainForm.N31Click(Sender: TObject);
begin
  ToolButton10Click(ToolButton10);
end;

procedure TMainForm.N34Click(Sender: TObject);
var
 K : TKnowledgeBase;
 tmTs : TStringList;
 i : Integer;
begin
 if TreeView1.Selected<>nil then
  begin
   K:=GetKBForNode(TreeView1.Selected);
   if K<>nil then
    begin
     K.ShowCErrors(RzListView2);
     if RzListView2.Items.Count>0 then
      begin
       tmTs:=TStringList.Create;
       for i := 0 to K.CErrors.Count-1 do
        tmTs.Add('255='+K.CErrors.Strings[i]);
       MMessageBox(1,0,'0='+
//        MainForm.LS('The violations of the knowledge base consistency are detected')+': '+
//        #10+tmTs.Text);
        IntToStr(tmTs.Count)+
         MainForm.LS('The violations of the knowledge base consistency are detected'));
       RzPanel8.Visible:=True;
       RzSplitter3.PercentMin:=50;
       RzSplitter3.Percent:=80;
      end
     else
      begin
       RzPanel8.Visible:=False;
       RzSplitter3.Percent:=100;
       RzSplitter3.PercentMin:=100;
       MMessageBox(0,0,'0='+
        MainForm.LS('The violations of the knowledge base consistency are not detected'))
      end;
  end;
 end;
end;

procedure TMainForm.N36Click(Sender: TObject);
begin
 LangPrefix:='ru/';
 LF1:=LangLocaleDir+LangPrefix+'012.lan';
 LoadHelpMessages(HelpMessages,
  LangLocaleDir+LangPrefix+'011.lan');
 STDIClass.LoadLocalLang(Self,LangLocaleDir+LangPrefix+'013.lan');
 TMenuItem(Sender).Checked:=True;
 English1.Checked:=False;

 TabSheet1.Caption:=STDIClass.LoadSingleString('TabSheet1c',LangLocaleDir+LangPrefix+'013.lan');
 TabSheet2.Caption:=STDIClass.LoadSingleString('TabSheet2c',LangLocaleDir+LangPrefix+'013.lan');
 TabSheet3.Caption:=STDIClass.LoadSingleString('TabSheet3c',LangLocaleDir+LangPrefix+'013.lan');
 TabSheet4.Caption:=STDIClass.LoadSingleString('TabSheet4c',LangLocaleDir+LangPrefix+'013.lan');
 TabSheet5.Caption:=STDIClass.LoadSingleString('TabSheet5c',LangLocaleDir+LangPrefix+'013.lan');

 RzGroupBox1.Caption:=STDIClass.LoadSingleString('RzGroupBox1c',LangLocaleDir+LangPrefix+'013.lan');
 TreeView1.Items[0].Text:=StringReplace(TreeView1.Items[0].Text,
  'Knowledge bases (projects)','Базы знаний (проекты)',[rfReplaceAll]);
end;

procedure TMainForm.N38Click(Sender: TObject);
var
 K : TKnowledgeBase;
 s,s1,s2 : string;
 i : Integer;
begin
 if TreeView1.Selected<>nil then
  try
   K:=GetKBForNode(TreeView1.Selected);

  s:='0='+
   STDIClass.LoadSingleString('Close the knowledge base?',LangLocaleDir+LangPrefix+'012.lan')
    ;
  s2:=
   STDIClass.LoadSingleString('Close',LangLocaleDir+LangPrefix+'012.lan')
    +' ';

  if MMessageBox(1,1,s)=0
   then
    begin
     s1:='базы знаний: '+K.Name;

        for i:=0 to KBList.Count-1 do
         if K.ID=
          TKnowledgeBase(KBList.Items[i]).ID then
           begin
            if MMessageBox(1,1,'0='+
             STDIClass.LoadSingleString('Save the knowledge base?',LangLocaleDir+LangPrefix+'012.lan')
             )=0
             then
              begin
                if K.FileName='' then
                begin
                 SaveDialog1.Title:=Application.Title+': '+
                  STDIClass.LoadSingleString('Save',LangLocaleDir+LangPrefix+'012.lan');
                 SaveDialog1.Filter:='EKB files |*.ekb|'+
                  STDIClass.LoadSingleString('All',LangLocaleDir+LangPrefix+'012.lan')+
                   '|*.*';
                 SaveDialog1.InitialDir:=ExtractFileDir(Application.ExeName)+'.\Data';
                 SaveDialog1.FileName:='';

                if SaveDialog1.Execute() then
                 if (SaveDialog1.FileName<>'') then
                 begin
                  if pos('.ekb',SaveDialog1.FileName)=0 then
                   SaveDialog1.FileName:=SaveDialog1.FileName+'.ekb';
                  K.FileName:=
                   SaveDialog1.FileName;
                  XmlSave.GXMLStrSF(K.FileName,K);
                 end;
                end
               else
                XmlSave.GXMLStrSF(K.FileName,K);
              end;

            KBList.Delete(i);
            RzPanel8.Visible:=False;
            RzSplitter3.Percent:=100;
            RzSplitter3.PercentMin:=100;
            Break;
           end;

     TreeView1.Items.Item[0].Item[i].Delete;
     TreeView1.Items.Item[0].Text:=PutChildCount(TreeView1.Items.Item[0]);
     TreeView1.Selected:=TreeView1.Items.Item[0];
     TreeView1Click(TreeView1);
     MainForm.LoadAList(MainForm.RzListView1);
    end;
  except
  end;
end;

procedure TMainForm.PopupMenu1Popup(Sender: TObject);
Function AddSubItems(LV:TTreeView;MI:TMenuItem):Integer;
var
 i,j : 	Integer;
 tMI : TMenuItem;
 M : TPopupMenu;
 tmTs : TStringList;
 KB17 : TKnowledgeBase;
 CurrentPackage : string;
begin
 MI.Clear;
 M:=LV.PopupMenu;

 if LV.Selected<>nil then
  begin
   CurrentPackage:='';
   //type of selected item
   if TObject(LV.Selected.Data) is TTemplate then
    begin
     j:=0;
     CurrentPackage:=TTemplate(LV.Selected.Data).PackageName;
    end;
   if TObject(LV.Selected.Data) is TFact then
    begin
     j:=1;
     CurrentPackage:=TFact(LV.Selected.Data).PackageName;
    end;
   if TObject(LV.Selected.Data) is TGRule then
    begin
     j:=2;
     CurrentPackage:=TGRule(LV.Selected.Data).PackageName;
    end;
   if TObject(LV.Selected.Data) is TRule then
    begin
     j:=3;
     CurrentPackage:=TRule(LV.Selected.Data).PackageName;
    end;

   //get list of packages
   KB17:=GetKBForNode(LV.Selected);
   case j of
    0: tmTs:=KB17.TempPackageList;
    1: tmTs:=KB17.FactPackageList;
    2: tmTs:=KB17.GRulePackageList;
    3: tmTs:=KB17.RulePackageList;
   end;

   for i := 0 to tmTs.Count-1 do
    if CurrentPackage<>tmTs.Names[i] then
      begin
       tMI:=TMenuItem.Create(M);
       tMI.Caption:=StringReplace(Trim(tmTs.ValueFromIndex[i]),'&','',[rfReplaceAll]);
       tMI.ImageIndex:=36;
       tMI.Tag:=StrToInt(tmTs.Names[i]);
//       tMI.Tag:=i;
       tMI.OnClick:=MenuItemClick;
       MI.Add(tMI);
      end;
   if MI.Count=0 then MI.Enabled:=False
    else MI.Enabled:=True;
  end;
 Result:=MI.Count;
end;

var
 i  : Integer;
begin
 if TreeView1.Selected<>nil then
  begin
    // TreeView1Click(TreeView1);
    // ShowMessage(IntToStr(TreeView1.Selected.Level));
     for i:=0 to TPopupMenu(Sender).Items.Count-1 do
      TPopupMenu(Sender).Items.Items[i].Visible:=False;

     case TreeView1.Selected.Level of
      0,2: TPopupMenu(Sender).Items.Items[1].Visible:=True;
      1: begin
       TPopupMenu(Sender).Items.Items[0].Visible:=True;
    //   TPopupMenu(Sender).Items.Items[4].Visible:=True;
      end;
      3,4: begin
       TPopupMenu(Sender).Items.Items[2].Visible:=True;
       TPopupMenu(Sender).Items.Items[3].Visible:=True;
       TPopupMenu(Sender).Items.Items[4].Visible:=True;
       AddSubItems(TreeView1,TPopupMenu(Sender).Items.Items[4]);
      end;
      5: begin
       TPopupMenu(Sender).Items.Items[4].Visible:=True;
       AddSubItems(TreeView1,TPopupMenu(Sender).Items.Items[4]);
      end;
     end; //end case
     TPopupMenu(Sender).Items.Items[6].Visible:=True;
  end;
end;

procedure TMainForm.PopupMenu3Popup(Sender: TObject);
begin
// get
// ScrollBox4.get
// ShowMessage(IntToStr(TImage(TPopupMenu(Sender).PopupComponent).Left));

 imX:=Mouse.CursorPos.X-ScrollBox4.Top;
 imY:=Mouse.CursorPos.Y-ScrollBox4.Left;

 if TreeView1.Selected<>nil then
  begin
   if (TObject(TreeView1.Selected.Data) is TRule) or
    (TObject(TreeView1.Selected.Data) is TGRule) or
    (TObject(TreeView1.Selected.Data) is TFact) or
    (TObject(TreeView1.Selected.Data) is TTemplate) then
      TPopupMenu(Sender).Items.Items[0].Enabled:=True //edit
      else
       TPopupMenu(Sender).Items.Items[0].Enabled:=False; //edit
  end
 else
  TPopupMenu(Sender).Items.Items[0].Enabled:=False; //edit
end;

procedure TMainForm.Protege1Click(Sender: TObject);
var
  ext : String;
  KB55 : TKnowledgeBase;
begin
 OpenDialog1.Title:=Application.Title+': '+
  STDIClass.LoadSingleString('Import templates and generalized rules from owl',LangLocaleDir+LangPrefix+'012.lan')
  ;

 ext:='.owl';
 OpenDialog1.FileName:='';
 OpenDialog1.Filter:='Protege files |'
   +'*'+ext+'|'
   +STDIClass.LoadSingleString('All',LangLocaleDir+LangPrefix+'012.lan')
   +'|*.*';
 OpenDialog1.InitialDir:=ExtractFileDir(Application.ExeName)+'\Models';
 if OpenDialog1.Execute then
  if OpenDialog1.FileName<>'' then
   begin
     KB55:=TKnowledgeBase.Create;
     KB55.Init;
     KB55.LoadFromCXLFile(
      ExtractFileDir(Application.ExeName)+'\Dll\owl.i.dll',
       OpenDialog1.FileName);
     Application.CreateForm(TExp, Exp);

     Exp.KB:=KB55;
     Exp.Tag:=3;
     Exp.ShowModal;
   end
end;
procedure TMainForm.Protegeowlbeta1Click(Sender: TObject);
begin
 Application.CreateForm(TExp, Exp);

 Exp.KB:=nil;
 Exp.Tag:=8;
 Exp.ShowModal;
end;

procedure TMainForm.RUENG1Click(Sender: TObject);
begin
 if TreeView1.Selected.Data<>nil then
  begin
   if TObject(TreeView1.Selected.Data) is TKnowledgeBase then
    TKnowledgeBase(TreeView1.Selected.Data).Trans(Translit.FL);
   if TObject(TreeView1.Selected.Data) is TTemplate then
    TTemplate(TreeView1.Selected.Data).Trans(Translit.FL);
   if TObject(TreeView1.Selected.Data) is TRule then
    TRule(TreeView1.Selected.Data).Trans(Translit.FL);
   if TObject(TreeView1.Selected.Data) is TFact then
    TFact(TreeView1.Selected.Data).Trans(Translit.FL);
//   LoadTree(KBList,TreeView1);
   ReloadKBNames(TreeView1.Selected,TKnowledgeBase(TreeView1.Selected.Data));
   TreeView1Click(TreeView1);
  end;
end;

procedure TMainForm.ENGRU1Click(Sender: TObject);
begin
 if TreeView1.Selected.Data<>nil then
  begin
   if TObject(TreeView1.Selected.Data) is TKnowledgeBase then
    TKnowledgeBase(TreeView1.Selected.Data).Trans(Translit.BL);
   if TObject(TreeView1.Selected.Data) is TTemplate then
    TTemplate(TreeView1.Selected.Data).Trans(Translit.BL);
   if TObject(TreeView1.Selected.Data) is TRule then
    TRule(TreeView1.Selected.Data).Trans(Translit.BL);
   if TObject(TreeView1.Selected.Data) is TFact then
    TFact(TreeView1.Selected.Data).Trans(Translit.BL);
//   LoadTree(KBList,TreeView1);
   ReloadKBNames(TreeView1.Selected,TKnowledgeBase(TreeView1.Selected.Data));

   TreeView1Click(TreeView1);
  end;
end;
procedure TMainForm.TreeView1MouseMove(Sender: TObject; Shift: TShiftState;
  X, Y: Integer);
begin
 ReloadHelpMessage(ScrollBox3,TWinControl(Sender).Tag);
end;

procedure TMainForm.XMindbeta1Click(Sender: TObject);
var
  ext : String;
  KB55 : TKnowledgeBase;
begin
 OpenDialog1.Title:=Application.Title+': '+
  STDIClass.LoadSingleString('Import templates and generalized rules from xmind',LangLocaleDir+LangPrefix+'012.lan')
  ;

 ext:='.xmind';
 OpenDialog1.FileName:='';
 OpenDialog1.Filter:='XMind files |'
   +'*'+ext+'|'
   +STDIClass.LoadSingleString('All',LangLocaleDir+LangPrefix+'012.lan')
   +'|*.*';
 OpenDialog1.InitialDir:=ExtractFileDir(Application.ExeName)+'\Models';
 if OpenDialog1.Execute then
  if OpenDialog1.FileName<>'' then
   begin
     KB55:=TKnowledgeBase.Create;
     KB55.Init;
     KB55.LoadFromCXLFile(
      ExtractFileDir(Application.ExeName)+'\Dll\xmind.i.dll',
       OpenDialog1.FileName);
     Application.CreateForm(TExp, Exp);

     Exp.KB:=KB55;
     Exp.Tag:=3;
     Exp.ShowModal;
   end
end;

Function TMainForm.MakeDump(AName:String;AKind:Integer):Integer;
var
 tmA  : TActionItem;
begin
 try
  tmA:=TActionItem.Create;
  tmA.Init;
  tmA.ID:=AList.Count+1;
  tmA.Name:=AName;
  tmA.Date:=TimeToStr(Now);
  tmA.CopyKBs(KBList,tmA.KBs);
  tmA.Kind:=AKind;
  tmA.SelectedNode:=TreeView1.Selected;
  AList.Insert(0,tmA);
  Result:=AList.Count;
 except
  on E:Exception do
   begin
    ShowMessage(e.Message);
    Result:=-1;
   end;
 end
end;

Function TMainForm.LoadDump(DID:Integer):Integer;
var
 tN  : TTreeNode;
begin
 try
  Result:=TActionItem(AList.Items[DID]).CopyKBs(
   TActionItem(AList.Items[DID]).KBs,KBList);
  tN:=TActionItem(AList.Items[DID]).SelectedNode;

  MainForm.LoadAList(MainForm.RzListView1);
  LoadTree(KBList,TreeView1);
//  TreeView1.Select(tN,[]);
//  TreeView1.Selected:=tN;
//  TreeView1Click(TreeView1);
 except
  on E:Exception do
   begin
    ShowMessage(e.Message);
    Result:=-1;
   end;
 end
end;

Function TMainForm.LoadAList(WC:TWinControl):Integer;
var
 i  : Integer;
begin
 if WC is TRzListView then
  begin
   TRzListView(WC).Clear;
   for i:=0 to AList.Count-1 do
    begin
     TRzListView(WC).AddItem(TActionItem(AList.Items[i]).Date+' '+
//      IntToStr(TActionItem(AList.Items[i]).KBs.Count)+' '+
      TActionItem(AList.Items[i]).Name
      ,AList.Items[i]);
     TRzListView(WC).Items.Item[TRzListView(WC).Items.Count-1].ImageIndex:=
      TActionItem(AList.Items[i]).Kind;
//     TRzListView(WC).Items.Item[TRzListView(WC).Items.Count-1].Caption:=
//      TActionItem(AList.Items[i]).Date;
//     TRzListView(WC).Items.Item[TRzListView(WC).Items.Count-1].SubItems.Add(
//      TActionItem(AList.Items[i]).Name);
//     TRzListView(WC).Items.Item[TRzListView(WC).Items.Count-1].SubItems.Strings[0]:=
//      TActionItem(AList.Items[i]).Name;
    end;
  end;
end;

procedure TMainForm.RzListView1DblClick(Sender: TObject);
begin
 if RzListView1.ItemIndex>-1 then
 if  MMessageBox(1,1,'0='+
  STDIClass.LoadSingleString('Undo',LangLocaleDir+LangPrefix+'012.lan')
   +'?')=0 then
   begin
    MainForm.MakeDump(
     STDIClass.LoadSingleString('Undo',LangLocaleDir+LangPrefix+'012.lan')
      +': '+
     MainForm.RzListView1.Items.Item[RzListView1.ItemIndex].Caption,3);
    LoadDump(RzListView1.ItemIndex+1);
   end;
end;

procedure TMainForm.RzListView2Change(Sender: TObject; Item: TListItem;
  Change: TItemChange);
function FindObject(s,ID:string):Integer;
var
 i : Integer;
begin
 for i := 0 to TreeView1.Items.Count-1 do
  begin
   case s[1] of
    'T':begin
      if TObject(TreeView1.Items.Item[i].Data) is TTemplate then
       if TTemplate(TreeView1.Items.Item[i].Data).ID=ID then
        begin
         TreeView1.Selected:=TreeView1.Items.Item[i];
         TreeView1Click(TreeView1);
         Break;
        end;
     end;
    'F':begin
      if TObject(TreeView1.Items.Item[i].Data) is TFact then
       if TFact(TreeView1.Items.Item[i].Data).ID=ID then
        begin
         TreeView1.Selected:=TreeView1.Items.Item[i];
         TreeView1Click(TreeView1);
         Break;
        end;
     end;
    'R':begin
      if TObject(TreeView1.Items.Item[i].Data) is TRule then
       if TRule(TreeView1.Items.Item[i].Data).ID=ID then
        begin
         TreeView1.Selected:=TreeView1.Items.Item[i];
         TreeView1Click(TreeView1);
         Break;
        end;
     end;
    'G':begin
      if TObject(TreeView1.Items.Item[i].Data) is TGRule then
       if TGRule(TreeView1.Items.Item[i].Data).ID=ID then
        begin
         TreeView1.Selected:=TreeView1.Items.Item[i];
         TreeView1Click(TreeView1);
         Break;
        end;
     end;
   end; //end case
  end;
end;

var
 K : TKnowledgeBase;
 i : Integer;
 s,ID : string;
begin
 i:=-1;

 K:=GetKBForNode(TreeView1.Selected);
 if TObject(Item.Data) is TTemplate then
  begin
   i:=K.IndexOfTemplateByID(TTemplate(Item.Data).ID);
   s:='T';
   ID:=TTemplate(Item.Data).ID;
  end;
 if TObject(Item.Data) is TFact then
  begin
   i:=K.IndexOfFactByID(TFact(Item.Data).ID);
   s:='F';
   ID:=TFact(Item.Data).ID;
  end;
 if TObject(Item.Data) is TRule then
  begin
   i:=K.IndexOfRuleByShortName(TRule(Item.Data));
   s:='R';
   ID:=TRule(Item.Data).ID;
  end;
 if TObject(Item.Data) is TGRule then
  begin
   i:=K.IndexOfGRuleByID(TGRule(Item.Data).ID);
   s:='G';
   ID:=TGRule(Item.Data).ID;
  end;

 if (i<>-1)and(s<>'') then FindObject(s,ID);
end;

procedure TMainForm.RzListView3Click(Sender: TObject);
var
 T,L,T1,i,T2 : Integer;
 tmWC : TScrollBox;
begin
 tmWC:=ScrollBox7;
 STDIClass.ReleaseObjects(tmWC);
 T:=5;
 L:=5;

 if TRzListView(Sender).ItemIndex>-1 then
  if TObject(TRzListView(Sender).Selected.Data) is TTemplate then
   begin  //for templates

     T:=STDIClass.AddLabel(tmWC,
      STDIClass.LoadSingleString('Name:',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L,250,clNavy,clNone,[]);
     STDIClass.AddLabel(tmWC,'['+
      TTemplate(TRzListView(Sender).Selected.Data).ID
       +']',T,10,30,clInactiveCaption,clNone,[fsBold]);
     T:=STDIClass.AddLabel(tmWC,
      TTemplate(TRzListView(Sender).Selected.Data).Name
       ,T,L+10+50,tmWC.Width-25-10-50,clBlack,clNone,[fsBold]);

     T:=STDIClass.AddLabel(tmWC,
      STDIClass.LoadSingleString('Description:',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L,250,clNavy,clNone,[]);
     if TTemplate(TRzListView(Sender).Selected.Data).Description='' then
      T:=STDIClass.AddLabel(tmWC,
       STDIClass.LoadSingleString('no data',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L+10,250,clInactiveCaption,clNone,[])
      else
       T:=STDIClass.AddLabel(tmWC,TTemplate(TRzListView(Sender).Selected.Data).Description
        ,T,L+10,tmWC.Width-25-(L+10),clBlack,clNone,[fsBold]);

     T:=STDIClass.AddLabel(tmWC,
      STDIClass.LoadSingleString('Properties/slots:',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L,250,clNavy,clNone,[]);
     for i:=0 to TTemplate(TRzListView(Sender).Selected.Data).Slots.Count-1 do
      begin
       T1:=STDIClass.AddLabel(tmWC,
        TSlot(TTemplate(TRzListView(Sender).Selected.Data).Slots.Items[i]).Name
        ,T,L+10,TreeView1.Width-L-35,clBlack,clNone,[fsBold]);
//       TLabel(tmWC.Components[tmWC.ComponentCount-1]).Tag:=i;
//       TLabel(tmWC.Components[tmWC.ComponentCount-1]).OnClick:=LinkSClick;
//       TLabel(tmWC.Components[tmWC.ComponentCount-1]).Cursor:=crHandPoint;

       if T1<T2 then T1:=T2;
       T:=T1;
      end;
     if TTemplate(TRzListView(Sender).Selected.Data).Slots.Count=0 then
      T:=STDIClass.AddLabel(tmWC,
       STDIClass.LoadSingleString('no data',LangLocaleDir+LangPrefix+'012.lan')
       ,T,L+10,250,clInactiveCaption,clNone,[]);
   end
  else
   begin  //for rules
     TRule(TRzListView(Sender).Selected.Data).ShowAsList(1,1,T,L,tmWC,KB);
   end;
end;

procedure TMainForm.RzMaskEdit1Change(Sender: TObject);
begin
 if Trim(TRzMaskEdit(Sender).Text)='test' then
  begin
   UserMode:=1;
   ApplyPolicy(UserMode);
   TRzMaskEdit(Sender).Visible:=False;
   RzPanel6.Caption:='Внимание! Активирован режим Администратора';
   TreeView1Click(TreeView1);
  end;
end;

procedure TMainForm.RzMaskEdit1Click(Sender: TObject);
begin
 TRzMaskEdit(Sender).Text:='';
end;

procedure TMainForm.RzPageControl1DragOver(Sender, Source: TObject; X,
  Y: Integer; State: TDragState; var Accept: Boolean);
begin
  if tmPSO1<>nil then
   begin
    tmPSO1.Free;
    tmPSO1:=nil;
    tmPSO2.Free;
    tmPSO2:=nil;
    tmPSO3.Free;
    tmPSO3:=nil;
    tmPSO4.Free;
    tmPSO4:=nil;
   end;
end;

procedure TMainForm.RzSplitter3ULDockOver(Sender: TObject;
  Source: TDragDockObject; X, Y: Integer; State: TDragState;
  var Accept: Boolean);
begin
  if tmPSO1<>nil then
   begin
    tmPSO1.Free;
    tmPSO1:=nil;
    tmPSO2.Free;
    tmPSO2:=nil;
    tmPSO3.Free;
    tmPSO3:=nil;
    tmPSO4.Free;
    tmPSO4:=nil;
   end;
end;

procedure TMainForm.RzTabSheet1Show(Sender: TObject);
var
 i,j,T2 : Integer;
 s : string;
// tmRule : TRule;
 tmP : TRzPanel;
begin
 if ScrollBox2.Tag=1 then   //if results are not presented
  begin
    T2:=1;
     ScrollBox2.Visible:=False;
     STDIClass.ReleaseObjects(ScrollBox2);
    if (RRPManager<>nil)and(RRPManager.KB<>nil) then
     begin
      if RRPManager.KB.FiredRules.Count>0 then
      begin
       prP:=STDIClass.CreateProgressIndicator(Self,
        IntToStr(RRPManager.KB.FiredRules.Count)
         );

       for i := 0 to RRPManager.KB.FiredRules.Count-1 do
        begin
          //-----------------------------
          prP.Caption:=LS('Please,wait')+' ('+
           IntToStr(Round(100*i/RRPManager.KB.FiredRules.Count))
           +'%)';
          Application.ProcessMessages;
          //-----------------------------
         s:=RRPManager.KB.FiredRules.Strings[i];
         j:=KB.IndexOfRuleByName(s);
         if j>-1 then
          begin
           T2:=TRule(KB.Rules.Items[j]).ShowAsPanel(
            KB,ScrollBox2,T2,ScrollBox2.ControlCount+1);
          end;
        end;
       prP.Free;
      end
       else
        begin
         tmP:=STDIClass.AddRzPanel(1,1,20,ScrollBox2.Width,
          ScrollBox2,0,alTop,clCream,bvNone,bvNone,bsNone,
           LS('No results'));
         tmP.Font.Style:=[fsBold];
         tmP.Font.Color:=clRed;
        end;
     end
      else
       begin
         tmP:=STDIClass.AddRzPanel(1,1,20,ScrollBox2.Width,
          ScrollBox2,0,alTop,clCream,bvNone,bvNone,bsNone,
           LS('No results'));
         tmP.Font.Style:=[fsBold];
         tmP.Font.Color:=clRed;
       end;

  ScrollBox2.Visible:=True;
  TRzTabSheet(Sender).Enabled:=True;
  ScrollBox2.Tag:=0;   //results are presented
 end;
//    STDIClass.AddLabel(ScrollBox2,
//     'No data. Please enter the initial facts and click RUN buttion'
//      ,1,1,10,clBlack,clNone,[fsBold]);

end;

procedure TMainForm.RzTabSheet2Show(Sender: TObject);
var
 i,j,T2,j1,c : Integer;
 s : string;
 tmRule : TRule;
 tmP : TRzPanel;
 tmTs : TStringList;
begin
 c:=0;
 if ScrollBox6.Tag=1 then   //if results are not presented
  begin
   ScrollBox6.Visible:=False;
     STDIClass.ReleaseObjects(ScrollBox6);
    if (RRPManager<>nil)and(RRPManager.KB<>nil) then
     begin
      T2:=1;
      if RRPManager.KB.FiredRules.Count>0 then
      begin

       prP:=STDIClass.CreateProgressIndicator(Self,
        IntToStr(RRPManager.KB.FiredRules.Count)
         );

       for i := 0 to RRPManager.KB.FiredRules.Count-1 do
        begin
          //-----------------------------
      //    ImageList4.GetBitmap((i mod 20),prIm.Picture.Bitmap);
          prP.Caption:=LS('Please,wait')+' ('+IntToStr(Round(100*i/RRPManager.KB.FiredRules.Count))
           +'%)';
          Application.ProcessMessages;
          //-----------------------------

         s:=RRPManager.KB.FiredRules.Strings[i];
         j1:=KB.IndexOfRuleByName(s);
         if j1>-1 then
          begin
           tmRule:=TRule(KB.Rules.Items[j1]);
           for j := 0 to tmRule.Actions.Count-1 do
            begin
             Inc(c);
             //-----------------------------------------
             //for es mode
             T2:=TRAction(tmRule.Actions.Items[j]).Fact.ShowAsPanel(
              TRAction(tmRule.Actions.Items[j]).Operator,
               ScrollBox6,T2,ScrollBox6.ControlCount+1);
             //-----------------------------------------
            end;
          end;
        end;
       prP.Free;
      end
       else
        begin
         tmP:=STDIClass.AddRzPanel(1,1,20,ScrollBox6.Width,
          ScrollBox6,0,alTop,clCream,bvNone,bvNone,bsNone,
           LS('No results'));
         tmP.Font.Style:=[fsBold];
         tmP.Font.Color:=clRed;
        end;
     end
      else
       begin
         tmP:=STDIClass.AddRzPanel(1,1,20,ScrollBox6.Width,
          ScrollBox6,0,alTop,clCream,bvNone,bvNone,bsNone,
           LS('No results'));
         tmP.Font.Style:=[fsBold];
         tmP.Font.Color:=clRed;
       end;

  ScrollBox6.Visible:=True;
  TRzTabSheet(Sender).Enabled:=True;
  ScrollBox6.Tag:=0;   //results are presented
  tmTs:=TStringList.Create;
  tmTs.Add('0='+LS('Knowledge base RUN report:'));
  tmTs.Add('255=   '+LS('Facts changed:')+' '+IntToStr(c));
  tmTs.Add('255=   '+LS('Rules fired:')+' '+IntToStr(RRPManager.KB.FiredRules.Count));
  MMessageBox(0,0,tmTs.Text)
 end;
end;

procedure TMainForm.RzTabSheet3Show(Sender: TObject);
var
 i  : Integer;
 T  : Integer;
 tmTs2 : TStringList;
begin
//  ToolButton17.Visible:=True;
  //show templates
 RzBitBtn2.Visible:=False;
 ScrollBox5.Visible:=False;


  KB:=GetKBForNode(TreeView1.Selected);

  if KB.Templates.Count>0 then
   begin
     prP:=STDIClass.CreateProgressIndicator(Self,
      IntToStr(KB.Templates.Count)
       );

     for i := 0 to KB.Templates.Count-1 do
      begin
       T:=STDIClass.AddContainerForDataModule(i,T+5,1,10,
        ScrollBox5.Width,ScrollBox5,
         TTemplate(KB.Templates.Items[i]).Name);
      //-----------------------------
  //    ImageList4.GetBitmap((i mod 20),prIm.Picture.Bitmap);
      prP.Caption:=LS('Please,wait')+' ('+IntToStr(Round(100*i/KB.Templates.Count))
       +'%)';
      Application.ProcessMessages;
      //-----------------------------

      //show existring facts
       TmTs2:=KB.GetListOfFactsByTemplate(TTemplate(KB.Templates.Items[i]));
       if TmTs2.Count>0 then
        TCheckBox(
         TRzPanel(
          TRzPanel(ScrollBox5.Controls[ScrollBox5.ControlCount-1]).Controls[0]
           ).Controls[0]
          ).Checked:=True;
      end;
   end;
  prP.Free;
  ScrollBox5.Visible:=True;
 RzBitBtn2.Visible:=True;

  //control for run button
  if ScrollBox5.Tag<=0 then
   MainForm.RzBitBtn2.Enabled:=False
    else
     MainForm.RzBitBtn2.Enabled:=True;
 RzTabSheet3.OnShow:=nil;
end;

procedure TMainForm.RzListView1Click(Sender: TObject);
var
 i  : Integer;
begin
 if RzListView1.ItemIndex>-1 then
  begin
  // MainForm.RzListView1.Items.Item[RzListView1.ItemIndex].DisplayRect();
   for i:=RzListView1.ItemIndex downto 0 do
    MainForm.RzListView1.Items.Item[i].Selected:=True;
//    MainForm.RzListView1.Canvas.DrawFocusRect(
//     MainForm.RzListView1.Items.Item[i].DisplayRect(drBounds));
  end;

end;

procedure TMainForm.ToolButton8Click(Sender: TObject);
begin
 N13Click(Sender);
end;

//--------------------------------------------------------------------------
function TH_CHKUPDATE(p: pointer):integer;
type
  TMethod = function (ProxyParams,InStr,URL:WideString):WideString; stdcall;
var
 tmTs, tmTs1 : TStringList;
 ModuleID   : Cardinal;
 EntryPoint : Pointer;
 LMethod:TMethod;
 c : string;
begin
   try
    tmTs:=TStringList.Create;
    tmTs.Delimiter:=':';
    tmTs1:=TStringList.Create;
    tmTs1.Add('ver='+Trim(Ver));
        //-------------------------------------------------------------------------
        ModuleID:=Windows.LoadLibrary(PChar(
         ExtractFileDir(Application.ExeName)+'\Dll\001.dll'
        ));

        STDIClass.InternalGetMethodEntryPoint(ModuleID,'SendRequest',EntryPoint);
         if System.Assigned(EntryPoint) then
          try
            LMethod:=Windows.GetProcAddress(ModuleID,
             PChar('SendRequest'));
            if Assigned(LMethod)then
             begin
//              tmTs.DelimitedText:=LMethod(CurSession.GetProxyAsString,TmTs1.Text,
              c:=LMethod('',TmTs1.Text,
               'http://www.knowledge-core.ru/cgi-bin/pkbd/pkbd_get_last_version.php');
             end;
          except
          end;
     tmTs.DelimitedText:=c;
//     Application.CreateForm(TMsgBoxForm, MsgBoxForm);
        //-------------------------------------------------------------------------
     if tmTs.Count>1 then
      begin
         if tmTs.Strings[1]<>'0' then
           fUpadate:=Trim(tmTs.Strings[1])
         else
          MainForm.Timer1.Enabled:=False;
       end
        else
         MainForm.Timer1.Enabled:=False;
   except
   end;
 ExitThread(0);
end;
//--------------------------------------------------------------------------

procedure TMainForm.FormActivate(Sender: TObject);
begin
 fUpadate:='';
 Timer1.Enabled:=True;
 BeginThread(nil,1024,TH_CHKUPDATE,nil,0,TID1);

 Self.Caption:=' '+Application.Title+' v.'+Ver;
 LoadParams;
 TreeView1Click(TreeView1);

 GetListOfExpertSystems; //load exist expert systems
 OnActivate:=nil;
end;

end.
